{% extends "pages/layout.html" %}
{% load custom_filters %}
{% load static %}

{% block title %}{{ project.name }} - Toad{% endblock %}

{% block extra_head %}
<!-- Grid-specific JavaScript - conditional loading for production -->
{% if not debug %}
    <script src="{% static 'js/grid/grid_mobile.js' %}"></script>
{% else %}
    <script src="{% static 'js/grid/grid_mobile.js' %}"></script>
{% endif %}
<style>
/* Prevent horizontal page scrolling on mobile */
html, body {
    overflow-x: hidden !important;
    width: 100% !important;
    max-width: 100% !important;
}

/* Ensure main content containers don't exceed viewport width */
main, #app {
    overflow-x: hidden !important;
    width: 100% !important;
    max-width: 100% !important;
}

/* Hide drag handle and any Sortable styles on mobile (drag disabled) */
.drag-handle { display: none !important; }
.sortable-drag, .sortable-ghost, .sortable-chosen { }

/* Grid Tabs Styling */
.scrollbar-hide {
    -ms-overflow-style: none;  /* Internet Explorer 10+ */
    scrollbar-width: none;  /* Firefox */
}

.scrollbar-hide::-webkit-scrollbar {
    display: none;  /* Safari and Chrome */
}

/* Ensure grid tabs container has proper boundaries */
#grid-tabs {
    width: 100% !important;
    max-width: 100% !important;
    overflow: hidden !important;
}

#grid-tabs > div {
    width: 100% !important;
    max-width: none !important;
    overflow-x: auto !important;
    overflow-y: hidden !important;
    scroll-snap-type: x mandatory;
    scroll-padding: 0 1rem;
    -webkit-overflow-scrolling: touch;
}

#grid-tabs a {
    scroll-snap-align: center;
    scroll-snap-stop: always;
}


/* Active grid tab styling */
#grid-tabs a[href*="{{ project.pk }}"] {
    color: var(--text-primary) !important;
    border-bottom: 2px solid var(--primary-action-bg) !important;
    border-radius: 0 !important;
}

/* Remove border radius from all tabs for flat underline */
#grid-tabs a {
    border-radius: 0 !important;
}

/* Ensure grid tabs are visible */
#grid-tabs {
    opacity: 1 !important;
    visibility: visible !important;
}

/* Archived project tab styling */
#grid-tabs a[href*="{{ project.pk }}"].opacity-60 {
    opacity: 0.6 !important;
}

#grid-tabs a.opacity-60:hover {
    opacity: 0.8 !important;
}

/* Grid tabs responsive design */
@media (max-width: 640px) {
    #grid-tabs .flex-wrap {
        gap: 0.5rem;
    }
    
    #grid-tabs a {
        font-size: 0.875rem;
        padding: 0.5rem 0.75rem;
    }
}

/* Button consistency */
.grid-actions-mobile button,
.grid-actions-mobile a {
    min-width: 12rem !important; /* w-48 = 12rem */
    text-align: center !important;
    display: inline-flex !important;
    visibility: visible !important;
    opacity: 1 !important;
}

/* Ensure buttons are properly aligned */
.grid-actions-mobile {
    align-items: stretch !important;
    display: flex !important;
    visibility: visible !important;
    opacity: 1 !important;
}

/* Task text hover state for mobile inline editing */
.task-text-editable:hover {
    background-color: var(--grid-header-bg) !important;
    border-radius: 6px !important;
    padding: 4px 8px !important;
    cursor: text !important;
    transition: all 0.2s ease !important;
}

/* Inline editing styles for mobile */
.editing {
    background-color: var(--container-bg) !important;
    border: 2px dashed var(--tertiary-action-bg) !important;
    border-radius: 6px !important;
    padding: 4px 8px !important;
    outline: none !important;
    min-height: 24px !important;
    box-shadow: 0 0 0 3px var(--tertiary-action-bg) / 0.1 !important;
    position: relative !important;
}

.editing:focus {
    box-shadow: 0 0 0 3px var(--tertiary-action-bg) / 0.2 !important;
    border-color: var(--tertiary-action-bg) !important;
}
</style>
{% endblock %}

{% block content %}

<!-- Grid Tabs Navigation -->
<div class="mb-6 px-4" id="grid-tabs">
    <div class="flex gap-1 overflow-x-auto pb-2 scrollbar-hide">
        <!-- All Projects on One Line -->
        {% for p in ungrouped_projects %}
            <a href="{% url 'pages:project_grid' pk=p.pk %}" 
               class="inline-flex items-center px-3 py-2 text-sm font-medium rounded-lg transition-all duration-200 cursor-pointer whitespace-nowrap flex-shrink-0 {% if p.pk == project.pk %}text-[var(--text-primary)] border-b-2 border-[var(--primary-action-bg)]{% else %}text-[var(--text-primary)]{% endif %}">
                {{ p.name }}
            </a>
        {% endfor %}
        
        {% for group_data in grouped_projects %}
            {% for p in group_data.projects %}
                <a href="{% url 'pages:project_grid' pk=p.pk %}" 
                   class="inline-flex items-center px-3 py-2 text-sm font-medium rounded-lg transition-all duration-200 cursor-pointer whitespace-nowrap flex-shrink-0 {% if p.pk == project.pk %}text-[var(--text-primary)] border-b-2 border-[var(--primary-action-bg)]{% else %}text-[var(--text-primary)]{% endif %}">
                    {{ p.name }}
                </a>
            {% endfor %}
        {% endfor %}
        
        {% for p in archived_projects %}
            <a href="{% url 'pages:project_grid' pk=p.pk %}" 
               class="inline-flex items-center px-3 py-2 text-sm font-medium rounded-lg transition-all duration-200 cursor-pointer whitespace-nowrap flex-shrink-0 opacity-60 {% if p.pk == project.pk %}text-[var(--primary-action-bg)] border-b-2 border-[var(--primary-action-bg)]{% else %}text-[var(--text-secondary)]{% endif %}">
                {{ p.name }}
            </a>
        {% endfor %}
    </div>
</div>

<!-- Header -->
            <div class="mb-4 px-4 grid-header-mobile">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-2 gap-4">
        <div class="flex items-center space-x-3">
            <h1 class="text-2xl sm:text-3xl font-bold text-[var(--primary-action-bg)]">{{ project.name }}</h1>
            
        </div>
        
    </div>
    
    
    <!-- Clear Completed Button and Actions -->
    <div class="mb-4 flex justify-end items-center gap-2">
        {% if not project.is_archived %}
        <button type="button"
                class="inline-flex items-center px-4 py-2 text-sm font-medium text-[var(--clear-button-bg)] bg-white border border-[var(--clear-button-bg)] rounded-lg hover:bg-[var(--clear-button-bg)] hover:text-white transition-all duration-200 cursor-pointer"
                hx-get="{% url 'pages:delete_completed_tasks' pk=project.pk %}"
                hx-target="#modal-content"
                hx-trigger="click throttle:500ms"
                hx-disabled-elt="this"
                hx-indicator="#modal-content"
                hx-swap="innerHTML"
                hx-headers='{"Cache-Control": "no-cache"}'
                onclick="document.getElementById('modal').classList.remove('opacity-0', 'invisible'); document.getElementById('modal').querySelector('div').classList.remove('scale-95'); document.getElementById('modal').querySelector('div').classList.add('scale-100');">
            <i class="fas fa-check mr-2"></i>
            Clear Completed
        </button>
        {% endif %}
        
        <!-- Grid Actions Dropdown -->
        <div class="relative" id="grid-actions-dropdown-container">
            <button type="button" 
                    id="grid-actions-dropdown-btn"
                    onclick="toggleGridActionsDropdown()"
                    class="group flex items-center justify-center w-8 h-8 text-[var(--text-secondary)] hover:text-[var(--primary-action-bg)] hover:bg-[var(--grid-header-bg)] rounded-lg transition-all duration-200 cursor-pointer">
                <i class="fas fa-ellipsis-v text-sm"></i>
            </button>
            
            <!-- Dropdown Menu -->
            <div id="grid-actions-dropdown" 
                 class="absolute top-full right-0 mt-2 w-48 bg-[var(--container-bg)] border border-[var(--border-color)] rounded-lg shadow-lg py-2 z-50 opacity-0 invisible transform scale-95 transition-all duration-200 origin-top-right">
                
                <!-- Edit Grid Name -->
                <button type="button"
                        class="w-full px-4 py-2 text-left text-sm text-[var(--text-primary)] hover:bg-[var(--grid-header-bg)] transition-colors cursor-pointer"
                        hx-get="{% url 'pages:project_edit' pk=project.pk %}"
                        hx-target="#modal-content"
                        hx-trigger="click throttle:500ms"
                        hx-disabled-elt="this"
                        hx-indicator="#modal-content"
                        hx-swap="innerHTML"
                        hx-headers='{"Cache-Control": "no-cache"}'
                        onclick="document.getElementById('modal').classList.remove('opacity-0', 'invisible'); document.getElementById('modal').querySelector('div').classList.remove('scale-95'); document.getElementById('modal').querySelector('div').classList.add('scale-100'); closeGridActionsDropdown();">
                    <i class="fas fa-edit mr-2 text-[var(--primary-action-bg)]"></i>
                    Edit Grid Name
                </button>
                
                <!-- Add Row -->
                <button type="button"
                        class="w-full px-4 py-2 text-left text-sm text-[var(--text-primary)] hover:bg-[var(--grid-header-bg)] transition-colors cursor-pointer"
                        hx-get="{% url 'pages:row_create' project_pk=project.pk %}"
                        hx-target="#modal-content"
                        hx-trigger="click throttle:500ms"
                        hx-disabled-elt="this"
                        hx-indicator="#modal-content"
                        hx-swap="innerHTML"
                        hx-headers='{"Cache-Control": "no-cache"}'
                        onclick="document.getElementById('modal').classList.remove('opacity-0', 'invisible'); document.getElementById('modal').querySelector('div').classList.remove('scale-95'); document.getElementById('modal').querySelector('div').classList.add('scale-100'); closeGridActionsDropdown();">
                    <i class="fas fa-plus mr-2 text-[var(--primary-action-bg)]"></i>
                    Add Row
                </button>
                
                <!-- Add Column -->
                <button type="button"
                        class="w-full px-4 py-2 text-left text-sm text-[var(--text-primary)] hover:bg-[var(--grid-header-bg)] transition-colors cursor-pointer"
                        hx-get="{% url 'pages:column_create' project_pk=project.pk %}"
                        hx-target="#modal-content"
                        hx-trigger="click throttle:500ms"
                        hx-disabled-elt="this"
                        hx-indicator="#modal-content"
                        hx-swap="innerHTML"
                        hx-headers='{"Cache-Control": "no-cache"}'
                        onclick="document.getElementById('modal').classList.remove('opacity-0', 'invisible'); document.getElementById('modal').querySelector('div').classList.remove('scale-95'); document.getElementById('modal').querySelector('div').classList.add('scale-100'); closeGridActionsDropdown();">
                    <i class="fas fa-plus mr-2 text-[var(--primary-action-bg)]"></i>
                    Add Column
                </button>
                
                <!-- Archive Grid -->
                {% if project.is_archived %}
                    {% if user_tier == 'free' %}
                    <a href="{% url 'pages:upgrade_required' %}"
                       class="w-full px-4 py-2 text-left text-sm text-[var(--primary-action-bg)] hover:bg-[var(--grid-header-bg)] transition-colors cursor-pointer"
                       onclick="closeGridActionsDropdown();">
                        <i class="fas fa-undo mr-2 text-[var(--primary-action-bg)]"></i>
                        Restore Grid
                    </a>
                    {% else %}
                    <form method="post" action="{% url 'pages:restore_project' pk=project.pk %}" class="w-full">
                        {% csrf_token %}
                        <button type="submit" 
                               class="w-full px-4 py-2 text-left text-sm text-[var(--primary-action-bg)] hover:bg-[var(--grid-header-bg)] transition-colors cursor-pointer"
                               onclick="closeGridActionsDropdown();">
                            <i class="fas fa-undo mr-2 text-[var(--primary-action-bg)]"></i>
                            Restore Grid
                        </button>
                    </form>
                    {% endif %}
                {% else %}
                    {% if user_tier == 'free' %}
                    <a href="{% url 'pages:upgrade_required' %}"
                       class="w-full px-4 py-2 text-left text-sm text-[var(--text-primary)] hover:bg-[var(--grid-header-bg)] transition-colors cursor-pointer"
                       onclick="closeGridActionsDropdown();">
                        <i class="fas fa-archive mr-2 text-[var(--clear-button-bg)]"></i>
                        Archive Grid
                    </a>
                    {% else %}
                    <button type="button"
                            class="w-full px-4 py-2 text-left text-sm text-[var(--text-primary)] hover:bg-[var(--grid-header-bg)] transition-colors cursor-pointer"
                            hx-get="{% url 'pages:archive_project_confirm' pk=project.pk %}"
                            hx-target="#modal-content"
                            hx-trigger="click throttle:500ms"
                            hx-disabled-elt="this"
                            hx-indicator="#modal-content"
                            hx-swap="innerHTML"
                            hx-headers='{"Cache-Control": "no-cache"}'
                            onclick="document.getElementById('modal').classList.remove('opacity-0', 'invisible'); document.getElementById('modal').querySelector('div').classList.remove('scale-95'); document.getElementById('modal').querySelector('div').classList.add('scale-100'); closeGridActionsDropdown();">
                        <i class="fas fa-archive mr-2 text-[var(--clear-button-bg)]"></i>
                        Archive Grid
                    </button>
                    {% endif %}
                {% endif %}
                
                   <!-- Save as Template -->
                   {% if user_tier == 'free' %}
                   <a href="{% url 'pages:upgrade_required' %}"
                      class="w-full px-4 py-2 text-left text-sm text-[var(--text-primary)] hover:bg-[var(--grid-header-bg)] transition-colors cursor-pointer"
                      onclick="closeGridActionsDropdown();">
                       <i class="fas fa-save mr-2 text-[var(--tertiary-action-bg)]"></i>
                       Save as Template
                   </a>
                   {% else %}
                   <button type="button"
                           class="w-full px-4 py-2 text-left text-sm text-[var(--text-primary)] hover:bg-[var(--grid-header-bg)] transition-colors cursor-pointer"
                           hx-get="{% url 'pages:save_as_template' pk=project.pk %}"
                           hx-target="#modal-content"
                           hx-trigger="click throttle:500ms"
                           hx-disabled-elt="this"
                           hx-indicator="#modal-content"
                           hx-swap="innerHTML"
                           hx-headers='{"Cache-Control": "no-cache"}'
                           onclick="document.getElementById('modal').classList.remove('opacity-0', 'invisible'); document.getElementById('modal').querySelector('div').classList.remove('scale-95'); document.getElementById('modal').querySelector('div').classList.add('scale-100'); closeGridActionsDropdown();">
                       <i class="fas fa-save mr-2 text-[var(--tertiary-action-bg)]"></i>
                       Save as Template
                   </button>
                   {% endif %}
                   
                   <!-- Divider -->
                   <div class="border-t border-[var(--border-color)] my-2"></div>
                   
                   <!-- Delete Grid -->
                   <button type="button"
                           class="w-full px-4 py-2 text-left text-sm text-[var(--delete-button-bg)] hover:bg-[var(--grid-header-bg)] transition-colors cursor-pointer"
                           hx-get="{% url 'pages:project_delete' pk=project.pk %}"
                           hx-target="#modal-content"
                           hx-trigger="click throttle:500ms"
                           hx-disabled-elt="this"
                           hx-indicator="#modal-content"
                           hx-swap="innerHTML"
                           hx-headers='{"Cache-Control": "no-cache"}'
                           onclick="document.getElementById('modal').classList.remove('opacity-0', 'invisible'); document.getElementById('modal').querySelector('div').classList.remove('scale-95'); document.getElementById('modal').querySelector('div').classList.add('scale-100'); closeGridActionsDropdown();">
                       <i class="fas fa-trash mr-2 text-[var(--delete-button-bg)]"></i>
                       Delete Grid
                   </button>
               </div>
           </div>
       </div>
</div>



<!-- Task Grid -->
{% include 'pages/grid/partials/mobile_grid_content.html' %}


<!-- Row Deletion Modal -->
<div id="delete-row-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 opacity-0 invisible transition-all duration-300">
    <div class="bg-[var(--container-bg)] rounded-xl shadow-2xl border border-[var(--border-color)] max-w-md w-full mx-4 transform scale-95 transition-all duration-300" id="delete-row-modal-content">
        <!-- Modal Header -->
        <div class="flex items-center justify-between p-6 border-b border-[var(--border-color)]">
            <div class="flex items-center space-x-3">
                <div class="flex items-center justify-center w-10 h-10 bg-[var(--delete-button-bg)] rounded-lg shadow-sm">
                    <i class="fas fa-exclamation-triangle text-white"></i>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-[var(--text-primary)]">Delete Row</h3>
                    <p class="text-sm text-[var(--text-secondary)]">This action cannot be undone</p>
                </div>
            </div>
            <button type="button" id="close-delete-row-modal" class="text-[var(--text-secondary)] hover:text-[var(--text-primary)] transition-colors">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <!-- Modal Body -->
        <div class="p-6">
            <div class="mb-6">
                <p class="text-[var(--text-primary)] mb-2">Are you sure you want to delete this row?</p>
                <div class="bg-[var(--grid-header-bg)] border border-[var(--border-color)] rounded-lg p-4">
                    <div class="flex items-start space-x-3">
                        <div class="flex items-center justify-center w-8 h-8 bg-[var(--primary-action-bg)] rounded-lg shadow-sm flex-shrink-0">
                            <i class="fas fa-list text-white text-sm"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="font-medium text-[var(--text-primary)] text-sm" id="row-to-delete">Row Name</p>
                            <p class="text-xs text-[var(--text-secondary)] mt-1">This row and all its tasks will be permanently removed from your grid</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Modal Footer -->
        <div class="flex items-center justify-end space-x-3 p-6 border-t border-[var(--border-color)] bg-[var(--grid-header-bg)]/30 rounded-b-xl">
            <button type="button" 
                    id="cancel-delete-row"
                    class="w-32 h-10 flex items-center justify-center border border-[var(--border-color)] text-[var(--text-secondary)] rounded-lg hover:bg-[var(--container-bg)] hover:text-[var(--text-primary)] transition-all duration-200 font-medium cursor-pointer">
                <i class="fas fa-times mr-2"></i>Cancel
            </button>
            <form id="delete-row-form" method="post" class="inline"
                  hx-swap="none"
                  hx-trigger="submit"
                  hx-disabled-elt="this">
                {% csrf_token %}
                <button type="submit" 
                        class="w-32 h-10 flex items-center justify-center bg-[var(--delete-button-bg)] hover:bg-[var(--delete-button-hover-bg)] text-white rounded-lg transition-all duration-200 font-medium shadow-sm hover:shadow-md cursor-pointer">
                    <i class="fas fa-trash mr-2"></i>Delete Row
                </button>
            </form>
        </div>
    </div>
</div>

<!-- Task Deletion Modal -->
<div id="delete-task-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 opacity-0 invisible transition-all duration-300">
    <div class="bg-[var(--container-bg)] rounded-xl shadow-2xl border border-[var(--border-color)] max-w-md w-full mx-4 transform scale-95 transition-all duration-300" id="delete-modal-content">
        <!-- Modal Header -->
        <div class="flex items-center justify-between p-6 border-b border-[var(--border-color)]">
            <div class="flex items-center space-x-3">
                <div class="flex items-center justify-center w-10 h-10 bg-[var(--delete-button-bg)] rounded-lg shadow-sm">
                    <i class="fas fa-exclamation-triangle text-white"></i>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-[var(--text-primary)]">Delete Task</h3>
                    <p class="text-sm text-[var(--text-secondary)]">This action cannot be undone</p>
                </div>
            </div>
            <button type="button" id="close-delete-modal" class="text-[var(--text-secondary)] hover:text-[var(--text-primary)] transition-colors">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <!-- Modal Body -->
        <div class="p-6">
            <div class="mb-6">
                <p class="text-[var(--text-primary)] mb-2">Are you sure you want to delete this task?</p>
                <div class="bg-[var(--grid-header-bg)] border border-[var(--border-color)] rounded-lg p-4">
                    <div class="flex items-start space-x-3">
                        <div class="flex items-center justify-center w-8 h-8 bg-[var(--primary-action-bg)] rounded-lg shadow-sm flex-shrink-0">
                            <i class="fas fa-tasks text-white text-sm"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="font-medium text-[var(--text-primary)] text-sm" id="task-to-delete">Task Name</p>
                            <p class="text-xs text-[var(--text-secondary)] mt-1">This task will be permanently removed from your grid</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Modal Footer -->
        <div class="flex items-center justify-end space-x-3 p-6 border-t border-[var(--border-color)] bg-[var(--grid-header-bg)]/30 rounded-b-xl">
            <button type="button" 
                    id="cancel-delete-task"
                    class="w-32 h-10 flex items-center justify-center border border-[var(--border-color)] text-[var(--text-secondary)] rounded-lg hover:bg-[var(--container-bg)] hover:text-[var(--text-primary)] transition-all duration-200 font-medium cursor-pointer">
                <i class="fas fa-times mr-2"></i>Cancel
            </button>
            <form id="delete-task-form" method="post" class="inline"
                  hx-swap="none"
                  hx-trigger="submit"
                  hx-disabled-elt="this">
                {% csrf_token %}
                <button type="submit" 
                        class="w-32 h-10 flex items-center justify-center bg-[var(--delete-button-bg)] hover:bg-[var(--delete-button-hover-bg)] text-white rounded-lg transition-all duration-200 font-medium shadow-sm hover:shadow-md cursor-pointer">
                    <i class="fas fa-trash mr-2"></i>Delete Task
                </button>
            </form>
        </div>
    </div>
</div>

<!-- Clear Completed Modal -->
<div id="clear-completed-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 opacity-0 invisible transition-all duration-300" style="display: none;">
    <div class="bg-[var(--container-bg)] rounded-xl shadow-2xl border border-[var(--border-color)] max-w-md w-full mx-4 transform scale-95 transition-all duration-300" id="clear-completed-modal-content">
        <!-- Modal Header -->
        <div class="flex items-center justify-between p-6 border-b border-[var(--border-color)]">
            <div class="flex items-center space-x-3">
                <div class="flex items-center justify-center w-10 h-10 bg-[var(--clear-button-bg)] rounded-lg shadow-sm">
                    <i class="fas fa-check text-white"></i>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-[var(--text-primary)]">Clear Completed Tasks</h3>
                    <p class="text-sm text-[var(--text-secondary)]">This action cannot be undone</p>
                </div>
            </div>
            <button type="button" id="close-clear-completed-modal" class="text-[var(--text-secondary)] hover:text-[var(--text-primary)] transition-colors">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <!-- Modal Body -->
        <div class="p-6">
            <div class="mb-6">
                <p class="text-[var(--text-primary)] mb-4">Are you sure you want to clear all completed tasks from this grid?</p>
                <div class="bg-[var(--grid-header-bg)] border border-[var(--border-color)] rounded-lg p-4">
                    <div class="flex items-start space-x-3">
                        <div class="flex items-center justify-center w-8 h-8 bg-[var(--clear-button-bg)] rounded-lg shadow-sm flex-shrink-0">
                            <i class="fas fa-tasks text-white text-sm"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="font-medium text-[var(--text-primary)] text-sm">All completed tasks will be permanently removed</p>
                            <p class="text-xs text-[var(--text-secondary)] mt-1">This will help keep your grid clean and focused on active tasks</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Modal Footer -->
        <div class="flex items-center justify-end space-x-3 p-6 border-t border-[var(--border-color)] bg-[var(--grid-header-bg)]/30 rounded-b-xl">
            <button type="button" 
                    id="cancel-clear-completed"
                    class="w-32 h-10 flex items-center justify-center border border-[var(--border-color)] text-[var(--text-secondary)] rounded-lg hover:bg-[var(--container-bg)] hover:text-[var(--text-primary)] transition-all duration-200 font-medium cursor-pointer">
                <i class="fas fa-times mr-2"></i>Cancel
            </button>
            <form id="clear-completed-form" method="post" action="{% url 'pages:delete_completed_tasks' pk=project.pk %}" class="inline">
                {% csrf_token %}
                <button type="submit" 
                        class="w-40 h-10 flex items-center justify-center bg-[var(--clear-button-bg)] hover:bg-[var(--clear-button-bg)]/90 text-white rounded-lg transition-all duration-200 font-medium shadow-sm hover:shadow-md cursor-pointer">
                    <i class="fas fa-check mr-2"></i>Clear All
                </button>
            </form>
        </div>
    </div>
</div>

<!-- Calendar Reminder Modal -->
<div id="calendar-reminder-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 opacity-0 invisible transition-all duration-300">
    <div class="bg-[var(--container-bg)] rounded-xl shadow-2xl border border-[var(--border-color)] max-w-md w-full mx-4 transform scale-95 transition-all duration-300" id="calendar-modal-content">
        <!-- Modal Header -->
        <div class="flex items-center justify-between p-6 border-b border-[var(--border-color)]">
            <div class="flex items-center space-x-3">
                <div class="flex items-center justify-center w-10 h-10 bg-[var(--primary-action-bg)] rounded-lg shadow-sm">
                    <i class="fas fa-calendar-plus text-white"></i>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-[var(--text-primary)]">Set Task Reminder</h3>
                    <p class="text-sm text-[var(--text-secondary)]">Schedule a calendar reminder for this task</p>
                </div>
            </div>
            <button type="button" id="close-calendar-modal" class="text-[var(--text-secondary)] hover:text-[var(--text-primary)] transition-colors">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <!-- Modal Body -->
        <form id="calendar-reminder-form" method="post">
            {% csrf_token %}
            <div class="p-6">
                <div class="mb-6">
                    <div class="bg-[var(--grid-header-bg)] border border-[var(--border-color)] rounded-lg p-4 mb-6">
                        <div class="flex items-start space-x-3">
                            <div class="flex items-center justify-center w-8 h-8 bg-[var(--primary-action-bg)] rounded-lg shadow-sm flex-shrink-0">
                                <i class="fas fa-tasks text-white text-sm"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="font-medium text-[var(--text-primary)] text-sm" id="task-for-reminder">Task Name</p>
                                <p class="text-xs text-[var(--text-secondary)] mt-1">Set a date to receive a calendar reminder</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Date Selection -->
                    <div class="space-y-4">
                        <div>
                            <label for="reminder-date" class="block text-sm font-medium text-[var(--text-primary)] mb-2">Reminder Date</label>
                            <input type="date" 
                                   id="reminder-date" 
                                   name="reminder_date" 
                                   required
                                   min=""
                                   class="w-full px-3 py-2 border border-[var(--border-color)] rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-[var(--primary-action-bg)] focus:border-[var(--primary-action-bg)] text-[var(--text-primary)]">
                        </div>
                        
                        <!-- Optional Note -->
                        <div>
                            <label for="reminder-note" class="block text-sm font-medium text-[var(--text-primary)] mb-2">Additional Note (Optional)</label>
                            <textarea id="reminder-note" 
                                      name="reminder_note" 
                                      rows="3"
                                      placeholder="Add any additional context for this reminder..."
                                      class="w-full px-3 py-2 border border-[var(--border-color)] rounded-lg shadow-sm placeholder-[var(--text-secondary)] focus:outline-none focus:ring-2 focus:ring-[var(--primary-action-bg)] focus:border-[var(--primary-action-bg)] text-[var(--text-primary)] resize-none"></textarea>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Modal Footer -->
            <div class="flex items-center justify-end space-x-3 p-6 border-t border-[var(--border-color)] bg-[var(--grid-header-bg)]/30 rounded-b-xl">
                <button type="button" 
                        id="cancel-calendar-reminder"
                        class="w-32 h-10 flex items-center justify-center border border-[var(--border-color)] text-[var(--text-secondary)] rounded-lg hover:bg-[var(--container-bg)] hover:text-[var(--text-primary)] transition-all duration-200 font-medium cursor-pointer">
                    <i class="fas fa-times mr-2"></i>Cancel
                </button>
                <button type="submit" 
                        class="w-40 h-10 flex items-center justify-center bg-[var(--primary-action-bg)] hover:bg-[var(--primary-action-hover-bg)] text-white rounded-lg transition-all duration-200 font-medium shadow-sm hover:shadow-md cursor-pointer">
                    <i class="fas fa-calendar-plus mr-2"></i>Set Reminder
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modal Container -->
<div id="modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 opacity-0 invisible transition-all duration-300">
    <div class="bg-[var(--container-bg)] rounded-xl shadow-2xl border border-[var(--border-color)] max-w-md w-full mx-4 transform scale-95 transition-all duration-300" id="modal-content">
        <!-- Loading indicator -->
        <div class="htmx-indicator flex items-center justify-center p-8">
            <div class="flex items-center space-x-3">
                <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-[var(--primary-action-bg)]"></div>
                <span class="text-[var(--text-secondary)]">Loading...</span>
            </div>
        </div>
        <!-- Modal content will be loaded here -->
    </div>
</div>

<script>
// Grid Actions Dropdown functionality
function closeGridActionsDropdown() {
    const dropdown = document.getElementById('grid-actions-dropdown');
    if (dropdown) {
        dropdown.classList.add('opacity-0', 'invisible');
        dropdown.classList.remove('opacity-100', 'visible');
    }
}

function toggleGridActionsDropdown() {
    const dropdown = document.getElementById('grid-actions-dropdown');
    if (dropdown) {
        if (dropdown.classList.contains('opacity-0') || dropdown.classList.contains('invisible')) {
            // Open dropdown
            dropdown.classList.remove('opacity-0', 'invisible');
            dropdown.classList.add('opacity-100', 'visible');
        } else {
            // Close dropdown
            closeGridActionsDropdown();
        }
    }
}

// Clear Completed Modal functionality
function showClearCompletedModal() {
    const modal = document.getElementById('clear-completed-modal');
    if (modal) {
        modal.style.display = 'flex';
        modal.classList.remove('opacity-0', 'invisible');
        const modalContent = modal.querySelector('div');
        if (modalContent) {
            modalContent.classList.remove('scale-95');
            modalContent.classList.add('scale-100');
        }
    }
}

function hideClearCompletedModal() {
    const modal = document.getElementById('clear-completed-modal');
    if (modal) {
        modal.classList.add('opacity-0', 'invisible');
        const modalContent = modal.querySelector('div');
        if (modalContent) {
            modalContent.classList.add('scale-95');
            modalContent.classList.remove('scale-100');
        }
        // Hide the modal after transition
        setTimeout(() => {
            modal.style.display = 'none';
        }, 300);
    }
}

// Auto-scroll to selected grid tab
document.addEventListener('DOMContentLoaded', function() {
    // Scroll selected tab into view
    const selectedTab = document.querySelector('#grid-tabs a[href*="{{ project.pk }}"]');
    if (selectedTab) {
        selectedTab.scrollIntoView({
            behavior: 'smooth',
            block: 'nearest',
            inline: 'center'
        });
    }
    
    // Save Template Modal functionality (using event delegation for dynamically loaded content)
    document.addEventListener('click', function(e) {
        // Handle "Save with example tasks" selection
        if (e.target && e.target.closest('#with-tasks-btn')) {
            const withTasksBtn = e.target.closest('#with-tasks-btn');
            const structureOnlyBtn = document.getElementById('structure-only-btn');
            const templateStyleInput = document.getElementById('template_style');
            
            if (structureOnlyBtn && templateStyleInput) {
                // Update visual state - just show the inner circle
                withTasksBtn.querySelector('.w-3.h-3').classList.remove('opacity-0');
                
                // Reset other button
                structureOnlyBtn.querySelector('.w-3.h-3').classList.add('opacity-0');
                
                // Set form value
                templateStyleInput.value = 'with_tasks';
            }
        }
        
        // Handle "Save with clean structure" selection
        if (e.target && e.target.closest('#structure-only-btn')) {
            const structureOnlyBtn = e.target.closest('#structure-only-btn');
            const withTasksBtn = document.getElementById('with-tasks-btn');
            const templateStyleInput = document.getElementById('template_style');
            
            if (withTasksBtn && templateStyleInput) {
                // Update visual state - just show the inner circle
                structureOnlyBtn.querySelector('.w-3.h-3').classList.remove('opacity-0');
                
                // Reset other button
                withTasksBtn.querySelector('.w-3.h-3').classList.add('opacity-0');
                
                // Set form value
                templateStyleInput.value = 'structure_only';
            }
        }
    });
    
    // Initialize Save Template modal when content is loaded
    document.addEventListener('htmx:afterSwap', function(e) {
        if (e.detail.target && e.detail.target.id === 'modal-content') {
            const withTasksBtn = document.getElementById('with-tasks-btn');
            const structureOnlyBtn = document.getElementById('structure-only-btn');
            const templateStyleInput = document.getElementById('template_style');
            
            if (withTasksBtn && structureOnlyBtn && templateStyleInput) {
                // Set initial state to "Save with clean structure"
                structureOnlyBtn.querySelector('.w-3.h-3').classList.remove('opacity-0');
                withTasksBtn.querySelector('.w-3.h-3').classList.add('opacity-0');
                templateStyleInput.value = 'structure_only';
            }
        }
    });
    
    // Clear Completed modal buttons
    const closeClearCompletedModal = document.getElementById('close-clear-completed-modal');
    const cancelClearCompleted = document.getElementById('cancel-clear-completed');
    const clearCompletedModal = document.getElementById('clear-completed-modal');
    
    if (closeClearCompletedModal) {
        closeClearCompletedModal.addEventListener('click', hideClearCompletedModal);
    }
    
    if (cancelClearCompleted) {
        cancelClearCompleted.addEventListener('click', hideClearCompletedModal);
    }
    
    // Close modal when clicking outside
    if (clearCompletedModal) {
        clearCompletedModal.addEventListener('click', function(e) {
            if (e.target === clearCompletedModal) {
                hideClearCompletedModal();
            }
        });
    }
    
    // Grid Actions Dropdown button
    const gridActionsBtn = document.getElementById('grid-actions-dropdown-btn');
    if (gridActionsBtn) {
        gridActionsBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            toggleGridActionsDropdown();
        });
    }
    
    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
        const dropdown = document.getElementById('grid-actions-dropdown');
        const dropdownBtn = document.getElementById('grid-actions-dropdown-btn');
        if (dropdown && dropdownBtn && !dropdown.contains(e.target) && !dropdownBtn.contains(e.target)) {
            closeGridActionsDropdown();
        }
    });
    
    // Clear Completed form submission (using event delegation for dynamically loaded content)
    document.addEventListener('submit', function(e) {
        if (e.target && e.target.id === 'clear-completed-form') {
            e.preventDefault();
            
            const clearCompletedForm = e.target;
            const submitBtn = clearCompletedForm.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            
            // Show loading state
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Clearing...';
            submitBtn.disabled = true;
            
            // Submit form via fetch
            const formData = new FormData(clearCompletedForm);
            
            fetch(clearCompletedForm.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Show success message
                    submitBtn.innerHTML = '<i class="fas fa-check mr-2"></i>Cleared!';
                    submitBtn.classList.remove('bg-[var(--clear-button-bg)]', 'hover:bg-[var(--clear-button-bg)]/90');
                    submitBtn.classList.add('bg-green-500');
                    
                    // Close modal after short delay
                    setTimeout(() => {
                        // Close the main modal
                        const modal = document.getElementById('modal');
                        if (modal) {
                            modal.classList.add('opacity-0', 'invisible');
                            const modalContent = modal.querySelector('div');
                            if (modalContent) {
                                modalContent.classList.add('scale-95');
                                modalContent.classList.remove('scale-100');
                            }
                        }
                        
                        // Reset button
                        submitBtn.innerHTML = originalText;
                        submitBtn.disabled = false;
                        submitBtn.classList.remove('bg-green-500');
                        submitBtn.classList.add('bg-[var(--clear-button-bg)]', 'hover:bg-[var(--clear-button-bg)]/90');
                        
                        // Reload the page to show updated grid
                        window.location.reload();
                    }, 1500);
                } else {
                    // Show error
                    submitBtn.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i>Error';
                    submitBtn.classList.remove('bg-[var(--clear-button-bg)]');
                    submitBtn.classList.add('bg-red-500');
                    
                    setTimeout(() => {
                        submitBtn.innerHTML = originalText;
                        submitBtn.disabled = false;
                        submitBtn.classList.remove('bg-red-500');
                        submitBtn.classList.add('bg-[var(--clear-button-bg)]');
                    }, 2000);
                }
            })
            .catch(error => {
                console.error('Error clearing completed tasks:', error);
                submitBtn.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i>Error';
                submitBtn.classList.remove('bg-[var(--clear-button-bg)]');
                submitBtn.classList.add('bg-red-500');
                
                setTimeout(() => {
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                    submitBtn.classList.remove('bg-red-500');
                    submitBtn.classList.add('bg-[var(--clear-button-bg)]');
                }, 2000);
            });
        }
    });
    
    // Clear Completed modal close buttons (using event delegation for dynamically loaded content)
    document.addEventListener('click', function(e) {
        // Close modal button
        if (e.target && e.target.id === 'close-clear-completed-modal') {
            const modal = document.getElementById('modal');
            if (modal) {
                modal.classList.add('opacity-0', 'invisible');
                const modalContent = modal.querySelector('div');
                if (modalContent) {
                    modalContent.classList.add('scale-95');
                    modalContent.classList.remove('scale-100');
                }
            }
        }
        
        // Cancel button
        if (e.target && e.target.id === 'cancel-clear-completed') {
            const modal = document.getElementById('modal');
            if (modal) {
                modal.classList.add('opacity-0', 'invisible');
                const modalContent = modal.querySelector('div');
                if (modalContent) {
                    modalContent.classList.add('scale-95');
                    modalContent.classList.remove('scale-100');
                }
            }
        }
        
        // Save Template modal close buttons
        if (e.target && e.target.id === 'close-save-template-modal') {
            const modal = document.getElementById('modal');
            if (modal) {
                modal.classList.add('opacity-0', 'invisible');
                const modalContent = modal.querySelector('div');
                if (modalContent) {
                    modalContent.classList.add('scale-95');
                    modalContent.classList.remove('scale-100');
                }
            }
        }
        
        if (e.target && e.target.id === 'cancel-save-template') {
            const modal = document.getElementById('modal');
            if (modal) {
                modal.classList.add('opacity-0', 'invisible');
                const modalContent = modal.querySelector('div');
                if (modalContent) {
                    modalContent.classList.add('scale-95');
                    modalContent.classList.remove('scale-100');
                }
            }
        }
    });
});

// Calendar Reminder Modal functionality
function showCalendarReminderModal(taskId, taskText) {
    const modal = document.getElementById('calendar-reminder-modal');
    const taskDisplay = document.getElementById('task-for-reminder');
    const form = document.getElementById('calendar-reminder-form');
    const dateInput = document.getElementById('reminder-date');
    
    if (modal && taskDisplay && form && dateInput) {
        // Set task text in modal
        taskDisplay.textContent = taskText;
        
        // Set form action URL
        form.action = `/tasks/${taskId}/reminder/`;
        
        // Set minimum date to today
        const today = new Date().toISOString().split('T')[0];
        dateInput.min = today;
        dateInput.value = today;
        
        // Show modal
        modal.classList.remove('opacity-0', 'invisible');
        const modalContent = modal.querySelector('div');
        if (modalContent) {
            modalContent.classList.remove('scale-95');
            modalContent.classList.add('scale-100');
        }
    }
}

function hideCalendarReminderModal() {
    const modal = document.getElementById('calendar-reminder-modal');
    if (modal) {
        modal.classList.add('opacity-0', 'invisible');
        const modalContent = modal.querySelector('div');
        if (modalContent) {
            modalContent.classList.add('scale-95');
            modalContent.classList.remove('scale-100');
        }
        
        // Reset form
        const form = document.getElementById('calendar-reminder-form');
        const noteTextarea = document.getElementById('reminder-note');
        if (form) form.reset();
        if (noteTextarea) noteTextarea.value = '';
    }
}

// Calendar reminder event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Close calendar modal buttons
    const closeCalendarModal = document.getElementById('close-calendar-modal');
    const cancelCalendarReminder = document.getElementById('cancel-calendar-reminder');
    const calendarModal = document.getElementById('calendar-reminder-modal');
    
    if (closeCalendarModal) {
        closeCalendarModal.addEventListener('click', hideCalendarReminderModal);
    }
    
    if (cancelCalendarReminder) {
        cancelCalendarReminder.addEventListener('click', hideCalendarReminderModal);
    }
    
    // Close modal when clicking outside
    if (calendarModal) {
        calendarModal.addEventListener('click', function(e) {
            if (e.target === calendarModal) {
                hideCalendarReminderModal();
            }
        });
    }
    
    // Handle calendar reminder button clicks
    document.addEventListener('click', function(e) {
        const calendarBtn = e.target.closest('.calendar-reminder-btn');
        if (calendarBtn) {
            e.preventDefault();
            e.stopPropagation();
            const taskId = calendarBtn.dataset.taskId;
            const taskText = calendarBtn.dataset.taskText;
            showCalendarReminderModal(taskId, taskText);
        }
    });
    
    // Handle calendar reminder form submission
    const calendarForm = document.getElementById('calendar-reminder-form');
    if (calendarForm) {
        calendarForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(calendarForm);
            const taskId = calendarForm.action.split('/tasks/')[1].split('/reminder/')[0];
            
            // Show loading state
            const submitBtn = calendarForm.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Creating...';
            submitBtn.disabled = true;
            
            // Submit form via fetch
            fetch(calendarForm.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Show success message
                    submitBtn.innerHTML = '<i class="fas fa-check mr-2"></i>Created!';
                    submitBtn.classList.remove('bg-[var(--primary-action-bg)]', 'hover:bg-[var(--primary-action-hover-bg)]');
                    submitBtn.classList.add('bg-green-500');
                    
                    // Close modal after short delay
                    setTimeout(() => {
                        hideCalendarReminderModal();
                        
                        // Reset button
                        submitBtn.innerHTML = originalText;
                        submitBtn.disabled = false;
                        submitBtn.classList.remove('bg-green-500');
                        submitBtn.classList.add('bg-[var(--primary-action-bg)]', 'hover:bg-[var(--primary-action-hover-bg)]');
                        
                        // Show notification if available
                        if (window.showNotification) {
                            window.showNotification('Calendar reminder created successfully!', 'success');
                        }
                    }, 1500);
                } else {
                    // Show error
                    submitBtn.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i>Error';
                    submitBtn.classList.remove('bg-[var(--primary-action-bg)]');
                    submitBtn.classList.add('bg-red-500');
                    
                    setTimeout(() => {
                        submitBtn.innerHTML = originalText;
                        submitBtn.disabled = false;
                        submitBtn.classList.remove('bg-red-500');
                        submitBtn.classList.add('bg-[var(--primary-action-bg)]');
                    }, 2000);
                }
            })
            .catch(error => {
                console.error('Error creating reminder:', error);
                submitBtn.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i>Error';
                submitBtn.classList.remove('bg-[var(--primary-action-bg)]');
                submitBtn.classList.add('bg-red-500');
                
                setTimeout(() => {
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                    submitBtn.classList.remove('bg-red-500');
                    submitBtn.classList.add('bg-[var(--primary-action-bg)]');
                }, 2000);
            });
        });
    }
});


// Button carousel scrolling function
function scrollButtonCarousel(direction) {
    const carousel = document.getElementById('button-carousel');
    const scrollAmount = 200; // Adjust scroll distance
    
    if (direction === 'left') {
        carousel.scrollBy({ left: -scrollAmount, behavior: 'smooth' });
    } else {
        carousel.scrollBy({ left: scrollAmount, behavior: 'smooth' });
    }
}
</script>

{% endblock %}