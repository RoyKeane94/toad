{% extends "pages/layout.html" %}
{% load custom_filters %}
{% load static %}

{% block title %}{{ project.name }} - Toad{% endblock %}

{% block extra_head %}
<!-- Grid-specific JavaScript - conditional loading for production -->
{% if not debug %}
    <script src="{% static 'js/grid/grid_mobile.js' %}"></script>
{% else %}
    <script src="{% static 'js/grid/grid_mobile.js' %}"></script>
{% endif %}
<style>
/* Prevent horizontal page scrolling on mobile */
html, body {
    overflow-x: hidden !important;
    width: 100% !important;
    max-width: 100% !important;
}

/* Ensure main content containers don't exceed viewport width */
main, #app {
    overflow-x: hidden !important;
    width: 100% !important;
    max-width: 100% !important;
}

/* Hide drag handle and any Sortable styles on mobile (drag disabled) */
.drag-handle { display: none !important; }
.sortable-drag, .sortable-ghost, .sortable-chosen { }

/* Grid Tabs Styling */
.scrollbar-hide {
    -ms-overflow-style: none;  /* Internet Explorer 10+ */
    scrollbar-width: none;  /* Firefox */
}

.scrollbar-hide::-webkit-scrollbar {
    display: none;  /* Safari and Chrome */
}

/* Ensure grid tabs container has proper boundaries */
#grid-tabs {
    width: 100% !important;
    max-width: 100% !important;
    overflow: hidden !important;
}

#grid-tabs > div {
    width: 100% !important;
    max-width: none !important;
    overflow-x: auto !important;
    overflow-y: hidden !important;
    scroll-snap-type: x mandatory;
    scroll-padding: 0 1rem;
    -webkit-overflow-scrolling: touch;
}

#grid-tabs a {
    scroll-snap-align: center;
    scroll-snap-stop: always;
}


/* Active grid tab styling */
#grid-tabs a[href*="{{ project.pk }}"] {
    color: var(--text-primary) !important;
    border-bottom: 2px solid var(--primary-action-bg) !important;
    border-radius: 0 !important;
}

/* Remove border radius from all tabs for flat underline */
#grid-tabs a {
    border-radius: 0 !important;
}

/* Ensure grid tabs are visible */
#grid-tabs {
    opacity: 1 !important;
    visibility: visible !important;
}

/* Archived project tab styling */
#grid-tabs a[href*="{{ project.pk }}"].opacity-60 {
    opacity: 0.6 !important;
}

#grid-tabs a.opacity-60:hover {
    opacity: 0.8 !important;
}

/* Grid tabs responsive design */
@media (max-width: 640px) {
    #grid-tabs .flex-wrap {
        gap: 0.5rem;
    }
    
    #grid-tabs a {
        font-size: 0.875rem;
        padding: 0.5rem 0.75rem;
    }
}

/* Button consistency */
.grid-actions-mobile button,
.grid-actions-mobile a {
    min-width: 12rem !important; /* w-48 = 12rem */
    text-align: center !important;
    display: inline-flex !important;
    visibility: visible !important;
    opacity: 1 !important;
}

/* Ensure buttons are properly aligned */
.grid-actions-mobile {
    align-items: stretch !important;
    display: flex !important;
    visibility: visible !important;
    opacity: 1 !important;
}

/* Task text hover state for mobile inline editing */
.task-text-editable:hover {
    background-color: var(--grid-header-bg) !important;
    border-radius: 6px !important;
    padding: 4px 8px !important;
    cursor: text !important;
    transition: all 0.2s ease !important;
}

/* Inline editing styles for mobile */
.editing {
    background-color: var(--container-bg) !important;
    border: 2px dashed var(--tertiary-action-bg) !important;
    border-radius: 6px !important;
    padding: 4px 8px !important;
    outline: none !important;
    min-height: 24px !important;
    box-shadow: 0 0 0 3px var(--tertiary-action-bg) / 0.1 !important;
    position: relative !important;
}

.editing:focus {
    box-shadow: 0 0 0 3px var(--tertiary-action-bg) / 0.2 !important;
    border-color: var(--tertiary-action-bg) !important;
}
</style>
{% endblock %}

{% block content %}

<!-- Grid Tabs Navigation -->
<div class="mb-6 px-4" id="grid-tabs">
    <div class="flex gap-1 overflow-x-auto pb-2 scrollbar-hide">
        <!-- All Projects on One Line -->
        {% for p in ungrouped_projects %}
            <a href="{% url 'pages:project_grid' pk=p.pk %}" 
               class="inline-flex items-center px-3 py-2 text-sm font-medium rounded-lg transition-all duration-200 cursor-pointer whitespace-nowrap flex-shrink-0 {% if p.pk == project.pk %}text-[var(--text-primary)] border-b-2 border-[var(--primary-action-bg)]{% else %}text-[var(--text-primary)]{% endif %}">
                {{ p.name }}
            </a>
        {% endfor %}
        
        {% for group_data in grouped_projects %}
            {% for p in group_data.projects %}
                <a href="{% url 'pages:project_grid' pk=p.pk %}" 
                   class="inline-flex items-center px-3 py-2 text-sm font-medium rounded-lg transition-all duration-200 cursor-pointer whitespace-nowrap flex-shrink-0 {% if p.pk == project.pk %}text-[var(--text-primary)] border-b-2 border-[var(--primary-action-bg)]{% else %}text-[var(--text-primary)]{% endif %}">
                    {{ p.name }}
                </a>
            {% endfor %}
        {% endfor %}
        
        {% for p in archived_projects %}
            <a href="{% url 'pages:project_grid' pk=p.pk %}" 
               class="inline-flex items-center px-3 py-2 text-sm font-medium rounded-lg transition-all duration-200 cursor-pointer whitespace-nowrap flex-shrink-0 opacity-60 {% if p.pk == project.pk %}text-[var(--primary-action-bg)] border-b-2 border-[var(--primary-action-bg)]{% else %}text-[var(--text-secondary)]{% endif %}">
                {{ p.name }}
            </a>
        {% endfor %}
    </div>
</div>

<!-- Header -->
            <div class="mb-4 px-4 grid-header-mobile">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-2 gap-4">
        <div class="flex items-center space-x-3">
            <h1 class="text-2xl sm:text-3xl font-bold text-[var(--primary-action-bg)]">{{ project.name }}</h1>
            
            <!-- Grid Actions Dropdown -->
            <div class="relative" id="grid-actions-dropdown-container">
                <button type="button" 
                        id="grid-actions-dropdown-btn"
                        class="group flex items-center justify-center w-8 h-8 text-[var(--text-secondary)] hover:text-[var(--primary-action-bg)] hover:bg-[var(--grid-header-bg)] rounded-lg transition-all duration-200 cursor-pointer">
                    <i class="fas fa-ellipsis-h text-sm"></i>
                </button>
                
                                            <!-- Dropdown Menu -->
                            <div id="grid-actions-dropdown" 
                                 class="absolute top-full left-0 mt-2 w-48 bg-[var(--container-bg)] border border-[var(--border-color)] rounded-lg shadow-lg py-2 z-50 opacity-0 invisible transform scale-95 transition-all duration-200 origin-top-left"
                                 style="left: -180px;">
                    
                    <!-- Edit Grid Name -->
                    <button type="button"
                            class="w-full px-4 py-2 text-left text-sm text-[var(--text-primary)] hover:bg-[var(--grid-header-bg)] transition-colors cursor-pointer"
                            hx-get="{% url 'pages:project_edit' pk=project.pk %}"
                            hx-target="#modal-content"
                            hx-trigger="click throttle:500ms"
                            hx-disabled-elt="this"
                            hx-indicator="#modal-content"
                            hx-swap="innerHTML"
                            hx-headers='{"Cache-Control": "no-cache"}'
                            onclick="document.getElementById('modal').classList.remove('opacity-0', 'invisible'); document.getElementById('modal').querySelector('div').classList.remove('scale-95'); document.getElementById('modal').querySelector('div').classList.add('scale-100'); closeGridActionsDropdown();">
                        <i class="fas fa-edit mr-2 text-[var(--primary-action-bg)]"></i>
                        Edit Grid Name
                    </button>
                    
                    <!-- Clear Completed -->
                    {% if not project.is_archived %}
                        <a href="{% url 'pages:delete_completed_tasks' pk=project.pk %}" 
                           class="block w-full px-4 py-2 text-left text-sm text-[var(--text-primary)] hover:bg-[var(--grid-header-bg)] transition-colors cursor-pointer">
                            <i class="fas fa-check mr-2 text-[var(--clear-button-bg)]"></i>
                            Clear Completed
                        </a>
                    {% endif %}
                    
                    <!-- Archive Grid -->
                    {% if project.is_archived %}
                        <form method="post" action="{% url 'pages:restore_project' pk=project.pk %}" class="w-full">
                            {% csrf_token %}
                            <button type="submit" 
                                   class="w-full px-4 py-2 text-left text-sm text-[var(--text-primary)] hover:bg-[var(--grid-header-bg)] transition-colors cursor-pointer">
                                <i class="fas fa-undo mr-2 text-[var(--primary-action-bg)]"></i>
                                Restore Grid
                            </button>
                        </form>
                    {% else %}
                        <a href="{% url 'pages:archive_project_confirm' pk=project.pk %}" 
                           class="block w-full px-4 py-2 text-left text-sm text-[var(--text-primary)] hover:bg-[var(--grid-header-bg)] transition-colors cursor-pointer">
                            <i class="fas fa-archive mr-2 text-[var(--clear-button-bg)]"></i>
                            Archive Grid
                        </a>
                    {% endif %}
                    
                    <!-- Save as Template -->
                    <button type="button"
                            class="w-full px-4 py-2 text-left text-sm text-[var(--text-primary)] hover:bg-[var(--grid-header-bg)] transition-colors cursor-pointer"
                            onclick="document.getElementById('save-template-modal').classList.remove('opacity-0', 'invisible'); document.getElementById('save-template-modal').querySelector('div').classList.remove('scale-95'); document.getElementById('save-template-modal').querySelector('div').classList.add('scale-100'); closeGridActionsDropdown();">
                        <i class="fas fa-save mr-2 text-[var(--tertiary-action-bg)]"></i>
                        Save as Template
                    </button>
                </div>
            </div>
        </div>
        
    </div>
    
    <!-- Grid Actions - Simple Buttons -->
    <div class="flex gap-3 mb-2">
        <button type="button"
                class="inline-flex items-center justify-center w-20 px-3 py-1.5 text-sm font-medium text-[var(--primary-action-bg)] bg-white border border-[var(--primary-action-bg)] rounded-lg hover:bg-[var(--primary-action-bg)] hover:text-white transition-all duration-200 cursor-pointer"
                hx-get="{% url 'pages:row_create' project_pk=project.pk %}"
                hx-target="#modal-content"
                hx-trigger="click throttle:500ms"
                hx-disabled-elt="this"
                hx-indicator="#modal-content"
                hx-swap="innerHTML"
                hx-headers='{"Cache-Control": "no-cache"}'
                onclick="document.getElementById('modal').classList.remove('opacity-0', 'invisible'); document.getElementById('modal').querySelector('div').classList.remove('scale-95'); document.getElementById('modal').querySelector('div').classList.add('scale-100');">
            <i class="fas fa-plus mr-1"></i>Row
        </button>
        <button type="button"
                class="inline-flex items-center justify-center w-20 px-3 py-1.5 text-sm font-medium text-[var(--primary-action-bg)] bg-white border border-[var(--primary-action-bg)] rounded-lg hover:bg-[var(--primary-action-bg)] hover:text-white transition-all duration-200 cursor-pointer"
                hx-get="{% url 'pages:column_create' project_pk=project.pk %}"
                hx-target="#modal-content"
                hx-trigger="click throttle:500ms"
                hx-disabled-elt="this"
                hx-indicator="#modal-content"
                hx-swap="innerHTML"
                hx-headers='{"Cache-Control": "no-cache"}'
                onclick="document.getElementById('modal').querySelector('div').classList.remove('scale-95'); document.getElementById('modal').querySelector('div').classList.add('scale-100');">
            <i class="fas fa-plus mr-1"></i>Column
        </button>
    </div>
</div>



<!-- Task Grid -->
{% include 'pages/grid/partials/mobile_grid_content.html' %}

<!-- Save Template Modal -->
<div id="save-template-modal" class="fixed inset-0 bg-black/60 backdrop-blur-md z-50 opacity-0 invisible transition-all duration-300 flex items-center justify-center p-4">
    <div class="bg-[var(--container-bg)] rounded-xl max-w-lg w-full mx-4 transform scale-95 transition-all duration-300 shadow-2xl border border-[var(--border-color)]">
        <!-- Modal Header -->
        <div class="flex items-center p-6 border-b border-[var(--border-color)]">
            <div class="flex items-center space-x-3">
                <div class="flex items-center justify-center w-10 h-10 bg-[var(--tertiary-action-bg)] rounded-lg shadow-sm">
                    <i class="fas fa-save text-white"></i>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-[var(--text-primary)]">Save as Template</h3>
                    <p class="text-sm text-[var(--text-secondary)]">Save your current grid structure as a reusable template</p>
                </div>
            </div>
        </div>
        
        <!-- Modal Body -->
        <div class="p-6">
            <form id="save-template-form" method="post" action="{% url 'pages:save_as_template' pk=project.pk %}">
                {% csrf_token %}
                
                <!-- Template Name Field -->
                <div class="mb-6">
                    <label for="template_name" class="block text-sm font-medium text-[var(--text-primary)] mb-2">Template Name</label>
                    <input type="text" 
                           id="template_name" 
                           name="template_name" 
                           required
                           class="w-full px-3 py-2 border border-[var(--border-color)] rounded-md shadow-sm placeholder-[var(--text-secondary)] focus:outline-none focus:ring-2 focus:ring-[var(--tertiary-action-bg)] focus:border-[var(--tertiary-action-bg)] text-[var(--text-primary)]"
                           placeholder="Enter template name">
                </div>
                
                <!-- Template Options -->
                <div class="space-y-4">
                    <!-- Option 1: Save with example tasks -->
                    <button type="button" id="with-tasks-btn" class="w-full text-left p-4 border border-[var(--border-color)] rounded-lg hover:bg-[var(--grid-header-bg)] hover:border-[var(--tertiary-action-bg)] transition-all duration-200 group cursor-pointer">
                        <div class="flex items-start">
                            <div class="flex-shrink-0 w-5 h-5 mt-0.5 mr-3">
                                <div class="w-5 h-5 border-2 border-[var(--border-color)] rounded-full transition-all duration-200 flex items-center justify-center">
                                    <div class="w-3 h-3 bg-[var(--tertiary-action-bg)] rounded-full opacity-0 transition-opacity duration-200"></div>
                                </div>
                            </div>
                            <div class="flex-1">
                                <h4 class="text-sm font-medium text-[var(--text-primary)] group-hover:text-[var(--tertiary-action-bg)] transition-colors duration-200 mb-1">Save with example tasks</h4>
                                <p class="text-sm text-[var(--text-secondary)] group-hover:text-[var(--text-primary)] transition-colors duration-200">Include all current tasks as examples to show how to use the template effectively.</p>
                            </div>
                        </div>
                    </button>
                    
                    <!-- Option 2: Save with clean structure -->
                    <button type="button" id="structure-only-btn" class="w-full text-left p-4 border border-[var(--border-color)] rounded-lg hover:bg-[var(--grid-header-bg)] hover:border-[var(--tertiary-action-bg)] transition-all duration-200 group cursor-pointer">
                        <div class="flex items-center justify-start">
                            <div class="flex-shrink-0 w-5 h-5 mt-0.5 mr-3">
                                <div class="w-5 h-5 border-2 border-[var(--border-color)] rounded-full transition-all duration-200 flex items-center justify-center">
                                    <div class="w-3 h-3 bg-[var(--tertiary-action-bg)] rounded-full opacity-0 transition-opacity duration-200"></div>
                                </div>
                            </div>
                            <div class="flex-1">
                                <h4 class="text-sm font-medium text-[var(--text-primary)] group-hover:text-[var(--tertiary-action-bg)] transition-colors duration-200 mb-1">Save with a clean structure</h4>
                                <p class="text-sm text-[var(--text-secondary)] group-hover:text-[var(--text-primary)] transition-colors duration-200">Save just the rows and columns structure, ready for new tasks.</p>
                            </div>
                        </div>
                    </button>
                </div>
                
                <!-- Hidden input for template style -->
                <input type="hidden" id="template_style" name="template_style" value="structure_only">
            </form>
        </div>
        
        <!-- Modal Footer -->
        <div class="flex items-center justify-end space-x-3 p-6 border-t border-[var(--border-color)]">
            <button onclick="hideSaveTemplateModal()" class="px-4 py-2 flex items-center justify-center border border-[var(--border-color)] text-[var(--text-secondary)] rounded-lg hover:bg-[var(--container-bg)] hover:text-[var(--text-primary)] transition-all duration-200 font-medium cursor-pointer">
                <i class="fas fa-times mr-2"></i>Cancel
            </button>
            <button type="submit" form="save-template-form" class="px-4 py-2 flex items-center justify-center bg-[var(--tertiary-action-bg)] hover:bg-[var(--tertiary-action-hover-bg)] text-[var(--tertiary-action-text)] rounded-lg transition-all duration-200 font-medium shadow-sm hover:shadow-md cursor-pointer">
                <i class="fas fa-save mr-1"></i>Save Template
            </button>
        </div>
    </div>
</div>

<!-- Row Deletion Modal -->
<div id="delete-row-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 opacity-0 invisible transition-all duration-300">
    <div class="bg-[var(--container-bg)] rounded-xl shadow-2xl border border-[var(--border-color)] max-w-md w-full mx-4 transform scale-95 transition-all duration-300" id="delete-row-modal-content">
        <!-- Modal Header -->
        <div class="flex items-center justify-between p-6 border-b border-[var(--border-color)]">
            <div class="flex items-center space-x-3">
                <div class="flex items-center justify-center w-10 h-10 bg-[var(--delete-button-bg)] rounded-lg shadow-sm">
                    <i class="fas fa-exclamation-triangle text-white"></i>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-[var(--text-primary)]">Delete Row</h3>
                    <p class="text-sm text-[var(--text-secondary)]">This action cannot be undone</p>
                </div>
            </div>
            <button type="button" id="close-delete-row-modal" class="text-[var(--text-secondary)] hover:text-[var(--text-primary)] transition-colors">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <!-- Modal Body -->
        <div class="p-6">
            <div class="mb-6">
                <p class="text-[var(--text-primary)] mb-2">Are you sure you want to delete this row?</p>
                <div class="bg-[var(--grid-header-bg)] border border-[var(--border-color)] rounded-lg p-4">
                    <div class="flex items-start space-x-3">
                        <div class="flex items-center justify-center w-8 h-8 bg-[var(--primary-action-bg)] rounded-lg shadow-sm flex-shrink-0">
                            <i class="fas fa-list text-white text-sm"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="font-medium text-[var(--text-primary)] text-sm" id="row-to-delete">Row Name</p>
                            <p class="text-xs text-[var(--text-secondary)] mt-1">This row and all its tasks will be permanently removed from your grid</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Modal Footer -->
        <div class="flex items-center justify-end space-x-3 p-6 border-t border-[var(--border-color)] bg-[var(--grid-header-bg)]/30 rounded-b-xl">
            <button type="button" 
                    id="cancel-delete-row"
                    class="w-32 h-10 flex items-center justify-center border border-[var(--border-color)] text-[var(--text-secondary)] rounded-lg hover:bg-[var(--container-bg)] hover:text-[var(--text-primary)] transition-all duration-200 font-medium cursor-pointer">
                <i class="fas fa-times mr-2"></i>Cancel
            </button>
            <form id="delete-row-form" method="post" class="inline"
                  hx-swap="none"
                  hx-trigger="submit"
                  hx-disabled-elt="this">
                {% csrf_token %}
                <button type="submit" 
                        class="w-32 h-10 flex items-center justify-center bg-[var(--delete-button-bg)] hover:bg-[var(--delete-button-hover-bg)] text-white rounded-lg transition-all duration-200 font-medium shadow-sm hover:shadow-md cursor-pointer">
                    <i class="fas fa-trash mr-2"></i>Delete Row
                </button>
            </form>
        </div>
    </div>
</div>

<!-- Task Deletion Modal -->
<div id="delete-task-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 opacity-0 invisible transition-all duration-300">
    <div class="bg-[var(--container-bg)] rounded-xl shadow-2xl border border-[var(--border-color)] max-w-md w-full mx-4 transform scale-95 transition-all duration-300" id="delete-modal-content">
        <!-- Modal Header -->
        <div class="flex items-center justify-between p-6 border-b border-[var(--border-color)]">
            <div class="flex items-center space-x-3">
                <div class="flex items-center justify-center w-10 h-10 bg-[var(--delete-button-bg)] rounded-lg shadow-sm">
                    <i class="fas fa-exclamation-triangle text-white"></i>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-[var(--text-primary)]">Delete Task</h3>
                    <p class="text-sm text-[var(--text-secondary)]">This action cannot be undone</p>
                </div>
            </div>
            <button type="button" id="close-delete-modal" class="text-[var(--text-secondary)] hover:text-[var(--text-primary)] transition-colors">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <!-- Modal Body -->
        <div class="p-6">
            <div class="mb-6">
                <p class="text-[var(--text-primary)] mb-2">Are you sure you want to delete this task?</p>
                <div class="bg-[var(--grid-header-bg)] border border-[var(--border-color)] rounded-lg p-4">
                    <div class="flex items-start space-x-3">
                        <div class="flex items-center justify-center w-8 h-8 bg-[var(--primary-action-bg)] rounded-lg shadow-sm flex-shrink-0">
                            <i class="fas fa-tasks text-white text-sm"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="font-medium text-[var(--text-primary)] text-sm" id="task-to-delete">Task Name</p>
                            <p class="text-xs text-[var(--text-secondary)] mt-1">This task will be permanently removed from your grid</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Modal Footer -->
        <div class="flex items-center justify-end space-x-3 p-6 border-t border-[var(--border-color)] bg-[var(--grid-header-bg)]/30 rounded-b-xl">
            <button type="button" 
                    id="cancel-delete-task"
                    class="w-32 h-10 flex items-center justify-center border border-[var(--border-color)] text-[var(--text-secondary)] rounded-lg hover:bg-[var(--container-bg)] hover:text-[var(--text-primary)] transition-all duration-200 font-medium cursor-pointer">
                <i class="fas fa-times mr-2"></i>Cancel
            </button>
            <form id="delete-task-form" method="post" class="inline"
                  hx-swap="none"
                  hx-trigger="submit"
                  hx-disabled-elt="this">
                {% csrf_token %}
                <button type="submit" 
                        class="w-32 h-10 flex items-center justify-center bg-[var(--delete-button-bg)] hover:bg-[var(--delete-button-hover-bg)] text-white rounded-lg transition-all duration-200 font-medium shadow-sm hover:shadow-md cursor-pointer">
                    <i class="fas fa-trash mr-2"></i>Delete Task
                </button>
            </form>
        </div>
    </div>
</div>

<!-- Calendar Reminder Modal -->
<div id="calendar-reminder-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 opacity-0 invisible transition-all duration-300">
    <div class="bg-[var(--container-bg)] rounded-xl shadow-2xl border border-[var(--border-color)] max-w-md w-full mx-4 transform scale-95 transition-all duration-300" id="calendar-modal-content">
        <!-- Modal Header -->
        <div class="flex items-center justify-between p-6 border-b border-[var(--border-color)]">
            <div class="flex items-center space-x-3">
                <div class="flex items-center justify-center w-10 h-10 bg-[var(--primary-action-bg)] rounded-lg shadow-sm">
                    <i class="fas fa-calendar-plus text-white"></i>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-[var(--text-primary)]">Set Task Reminder</h3>
                    <p class="text-sm text-[var(--text-secondary)]">Schedule a calendar reminder for this task</p>
                </div>
            </div>
            <button type="button" id="close-calendar-modal" class="text-[var(--text-secondary)] hover:text-[var(--text-primary)] transition-colors">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <!-- Modal Body -->
        <form id="calendar-reminder-form" method="post">
            {% csrf_token %}
            <div class="p-6">
                <div class="mb-6">
                    <div class="bg-[var(--grid-header-bg)] border border-[var(--border-color)] rounded-lg p-4 mb-6">
                        <div class="flex items-start space-x-3">
                            <div class="flex items-center justify-center w-8 h-8 bg-[var(--primary-action-bg)] rounded-lg shadow-sm flex-shrink-0">
                                <i class="fas fa-tasks text-white text-sm"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="font-medium text-[var(--text-primary)] text-sm" id="task-for-reminder">Task Name</p>
                                <p class="text-xs text-[var(--text-secondary)] mt-1">Set a date to receive a calendar reminder</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Date Selection -->
                    <div class="space-y-4">
                        <div>
                            <label for="reminder-date" class="block text-sm font-medium text-[var(--text-primary)] mb-2">Reminder Date</label>
                            <input type="date" 
                                   id="reminder-date" 
                                   name="reminder_date" 
                                   required
                                   min=""
                                   class="w-full px-3 py-2 border border-[var(--border-color)] rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-[var(--primary-action-bg)] focus:border-[var(--primary-action-bg)] text-[var(--text-primary)]">
                        </div>
                        
                        <!-- Optional Note -->
                        <div>
                            <label for="reminder-note" class="block text-sm font-medium text-[var(--text-primary)] mb-2">Additional Note (Optional)</label>
                            <textarea id="reminder-note" 
                                      name="reminder_note" 
                                      rows="3"
                                      placeholder="Add any additional context for this reminder..."
                                      class="w-full px-3 py-2 border border-[var(--border-color)] rounded-lg shadow-sm placeholder-[var(--text-secondary)] focus:outline-none focus:ring-2 focus:ring-[var(--primary-action-bg)] focus:border-[var(--primary-action-bg)] text-[var(--text-primary)] resize-none"></textarea>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Modal Footer -->
            <div class="flex items-center justify-end space-x-3 p-6 border-t border-[var(--border-color)] bg-[var(--grid-header-bg)]/30 rounded-b-xl">
                <button type="button" 
                        id="cancel-calendar-reminder"
                        class="w-32 h-10 flex items-center justify-center border border-[var(--border-color)] text-[var(--text-secondary)] rounded-lg hover:bg-[var(--container-bg)] hover:text-[var(--text-primary)] transition-all duration-200 font-medium cursor-pointer">
                    <i class="fas fa-times mr-2"></i>Cancel
                </button>
                <button type="submit" 
                        class="w-40 h-10 flex items-center justify-center bg-[var(--primary-action-bg)] hover:bg-[var(--primary-action-hover-bg)] text-white rounded-lg transition-all duration-200 font-medium shadow-sm hover:shadow-md cursor-pointer">
                    <i class="fas fa-calendar-plus mr-2"></i>Set Reminder
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modal Container -->
<div id="modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 opacity-0 invisible transition-all duration-300">
    <div class="bg-[var(--container-bg)] rounded-xl shadow-2xl border border-[var(--border-color)] max-w-md w-full mx-4 transform scale-95 transition-all duration-300" id="modal-content">
        <!-- Loading indicator -->
        <div class="htmx-indicator flex items-center justify-center p-8">
            <div class="flex items-center space-x-3">
                <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-[var(--primary-action-bg)]"></div>
                <span class="text-[var(--text-secondary)]">Loading...</span>
            </div>
        </div>
        <!-- Modal content will be loaded here -->
    </div>
</div>

<script>
// Auto-scroll to selected grid tab
document.addEventListener('DOMContentLoaded', function() {
    // Scroll selected tab into view
    const selectedTab = document.querySelector('#grid-tabs a[href*="{{ project.pk }}"]');
    if (selectedTab) {
        selectedTab.scrollIntoView({
            behavior: 'smooth',
            block: 'nearest',
            inline: 'center'
        });
    }
    
    // Save Template Modal functionality
    const withTasksBtn = document.getElementById('with-tasks-btn');
    const structureOnlyBtn = document.getElementById('structure-only-btn');
    const templateStyleInput = document.getElementById('template_style');
    
    if (withTasksBtn && structureOnlyBtn && templateStyleInput) {
        // Set initial state to "Save with clean structure"
        structureOnlyBtn.querySelector('.w-3.h-3').classList.remove('opacity-0');
        
        // Handle "Save with example tasks" selection
        withTasksBtn.addEventListener('click', function() {
            // Update visual state - just show the inner circle
            withTasksBtn.querySelector('.w-3.h-3').classList.remove('opacity-0');
            
            // Reset other button
            structureOnlyBtn.querySelector('.w-3.h-3').classList.add('opacity-0');
            
            // Set form value
            templateStyleInput.value = 'with_tasks';
        });
        
        // Handle "Save with clean structure" selection
        structureOnlyBtn.addEventListener('click', function() {
            // Update visual state - just show the inner circle
            structureOnlyBtn.querySelector('.w-3.h-3').classList.remove('opacity-0');
            
            // Reset other button
            withTasksBtn.querySelector('.w-3.h-3').classList.add('opacity-0');
            
            // Set form value
            templateStyleInput.value = 'structure_only';
        });
    }
});

// Calendar Reminder Modal functionality
function showCalendarReminderModal(taskId, taskText) {
    const modal = document.getElementById('calendar-reminder-modal');
    const taskDisplay = document.getElementById('task-for-reminder');
    const form = document.getElementById('calendar-reminder-form');
    const dateInput = document.getElementById('reminder-date');
    
    if (modal && taskDisplay && form && dateInput) {
        // Set task text in modal
        taskDisplay.textContent = taskText;
        
        // Set form action URL
        form.action = `/tasks/${taskId}/reminder/`;
        
        // Set minimum date to today
        const today = new Date().toISOString().split('T')[0];
        dateInput.min = today;
        dateInput.value = today;
        
        // Show modal
        modal.classList.remove('opacity-0', 'invisible');
        const modalContent = modal.querySelector('div');
        if (modalContent) {
            modalContent.classList.remove('scale-95');
            modalContent.classList.add('scale-100');
        }
    }
}

function hideCalendarReminderModal() {
    const modal = document.getElementById('calendar-reminder-modal');
    if (modal) {
        modal.classList.add('opacity-0', 'invisible');
        const modalContent = modal.querySelector('div');
        if (modalContent) {
            modalContent.classList.add('scale-95');
            modalContent.classList.remove('scale-100');
        }
        
        // Reset form
        const form = document.getElementById('calendar-reminder-form');
        const noteTextarea = document.getElementById('reminder-note');
        if (form) form.reset();
        if (noteTextarea) noteTextarea.value = '';
    }
}

// Calendar reminder event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Close calendar modal buttons
    const closeCalendarModal = document.getElementById('close-calendar-modal');
    const cancelCalendarReminder = document.getElementById('cancel-calendar-reminder');
    const calendarModal = document.getElementById('calendar-reminder-modal');
    
    if (closeCalendarModal) {
        closeCalendarModal.addEventListener('click', hideCalendarReminderModal);
    }
    
    if (cancelCalendarReminder) {
        cancelCalendarReminder.addEventListener('click', hideCalendarReminderModal);
    }
    
    // Close modal when clicking outside
    if (calendarModal) {
        calendarModal.addEventListener('click', function(e) {
            if (e.target === calendarModal) {
                hideCalendarReminderModal();
            }
        });
    }
    
    // Handle calendar reminder button clicks
    document.addEventListener('click', function(e) {
        const calendarBtn = e.target.closest('.calendar-reminder-btn');
        if (calendarBtn) {
            e.preventDefault();
            e.stopPropagation();
            const taskId = calendarBtn.dataset.taskId;
            const taskText = calendarBtn.dataset.taskText;
            showCalendarReminderModal(taskId, taskText);
        }
    });
    
    // Handle calendar reminder form submission
    const calendarForm = document.getElementById('calendar-reminder-form');
    if (calendarForm) {
        calendarForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(calendarForm);
            const taskId = calendarForm.action.split('/tasks/')[1].split('/reminder/')[0];
            
            // Show loading state
            const submitBtn = calendarForm.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Creating...';
            submitBtn.disabled = true;
            
            // Submit form via fetch
            fetch(calendarForm.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Show success message
                    submitBtn.innerHTML = '<i class="fas fa-check mr-2"></i>Created!';
                    submitBtn.classList.remove('bg-[var(--primary-action-bg)]', 'hover:bg-[var(--primary-action-hover-bg)]');
                    submitBtn.classList.add('bg-green-500');
                    
                    // Close modal after short delay
                    setTimeout(() => {
                        hideCalendarReminderModal();
                        
                        // Reset button
                        submitBtn.innerHTML = originalText;
                        submitBtn.disabled = false;
                        submitBtn.classList.remove('bg-green-500');
                        submitBtn.classList.add('bg-[var(--primary-action-bg)]', 'hover:bg-[var(--primary-action-hover-bg)]');
                        
                        // Show notification if available
                        if (window.showNotification) {
                            window.showNotification('Calendar reminder created successfully!', 'success');
                        }
                    }, 1500);
                } else {
                    // Show error
                    submitBtn.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i>Error';
                    submitBtn.classList.remove('bg-[var(--primary-action-bg)]');
                    submitBtn.classList.add('bg-red-500');
                    
                    setTimeout(() => {
                        submitBtn.innerHTML = originalText;
                        submitBtn.disabled = false;
                        submitBtn.classList.remove('bg-red-500');
                        submitBtn.classList.add('bg-[var(--primary-action-bg)]');
                    }, 2000);
                }
            })
            .catch(error => {
                console.error('Error creating reminder:', error);
                submitBtn.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i>Error';
                submitBtn.classList.remove('bg-[var(--primary-action-bg)]');
                submitBtn.classList.add('bg-red-500');
                
                setTimeout(() => {
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                    submitBtn.classList.remove('bg-red-500');
                    submitBtn.classList.add('bg-[var(--primary-action-bg)]');
                }, 2000);
            });
        });
    }
});

function hideSaveTemplateModal() {
    const modal = document.getElementById('save-template-modal');
    if (modal) {
        modal.classList.add('opacity-0', 'invisible');
        const modalContent = modal.querySelector('div');
        if (modalContent) {
            modalContent.classList.add('scale-95');
            modalContent.classList.remove('scale-100');
        }
    }
}

// Button carousel scrolling function
function scrollButtonCarousel(direction) {
    const carousel = document.getElementById('button-carousel');
    const scrollAmount = 200; // Adjust scroll distance
    
    if (direction === 'left') {
        carousel.scrollBy({ left: -scrollAmount, behavior: 'smooth' });
    } else {
        carousel.scrollBy({ left: scrollAmount, behavior: 'smooth' });
    }
}
</script>

{% endblock %}