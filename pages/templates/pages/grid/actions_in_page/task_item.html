{% load static %}
{% load custom_filters %}
<div class="task-item group flex items-center justify-between w-full p-2 rounded-lg hover:bg-[var(--grid-header-bg)] transition-all duration-200"
     data-task-id="{{ task.id }}"
     id="task-{{ task.id }}"
     data-task-order="{{ task.order|default:0 }}"
     data-task-row="{{ task.row.pk }}"
     data-task-col="{{ task.column.pk }}"
     {% if task.assigned_to %}data-assigned-user-id="{{ task.assigned_to.pk }}"{% endif %}>
    <div class="flex items-center space-x-3 min-w-0 flex-1">
            <!-- Drag Handle (Desktop Only) -->
    <div class="drag-handle flex-shrink-0 cursor-grab active:cursor-grabbing opacity-0 group-hover:opacity-100 transition-opacity duration-200 mr-2"
         title="Drag to reorder">
        <i class="fas fa-grip-vertical text-xs text-[var(--text-secondary)] hover:text-[var(--primary-action-bg)]"></i>
    </div>
        
        <form method="POST" 
              action="{% url 'pages:task_toggle_complete' task.pk %}" 
              onsubmit="plausible('task_completed');"
              class="flex-shrink-0"
              hx-post="{% url 'pages:task_toggle_complete' task.pk %}"
              hx-swap="none"
              hx-trigger="change throttle:300ms"
              hx-disabled-elt="find input"
              _="on change 
                   -- Apply visual changes immediately for instant feedback
                   if target.checked
                     add .task-completed-strikethrough to #task-text-{{ task.id }}
                     add .checkbox-completed to #checkbox-{{ task.id }}
                   else
                     remove .task-completed-strikethrough from #task-text-{{ task.id }}
                     remove .checkbox-completed from #checkbox-{{ task.id }}
                   end
                 end
                 on htmx:afterRequest(detail) 
                   -- Handle server response errors by reverting changes
                   if not detail.successful
                     -- Server request failed, revert visual changes
                     if target.checked
                       remove .task-completed-strikethrough from #task-text-{{ task.id }}
                       remove .checkbox-completed from #checkbox-{{ task.id }}
                       set target.checked to false
                     else
                       add .task-completed-strikethrough to #task-text-{{ task.id }}
                       add .checkbox-completed to #checkbox-{{ task.id }}
                       set target.checked to true
                     end
                   end
                 end">
            {% csrf_token %}
            <input type="checkbox" 
                   id="checkbox-{{ task.id }}"
                   name="completed" 
                   {% if task.completed %}checked{% endif %}
                   class="w-4 h-4 rounded border-gray-300 text-[var(--primary-action-bg)] focus:ring-[var(--primary-action-bg)] cursor-pointer {% if task.completed %}checkbox-completed{% endif %}">
        </form>
        
        <!-- Note Display - Left of text -->
        {% if task.notes.exists %}
            <div class="note-display flex items-center text-xs text-[var(--text-secondary)] mr-2">
                <i class="fas fa-sticky-note text-[var(--primary-action-bg)]"></i>
            </div>
        {% endif %}
        
        <div class="flex-1 min-w-0">
            <div id="task-text-{{ task.id }}" 
                 class="text-sm text-[var(--text-primary)] {% if task.completed %}task-completed-strikethrough{% endif %} leading-relaxed whitespace-pre-wrap cursor-text hover:bg-[var(--grid-header-bg)] hover:rounded px-1 transition-all duration-200 task-text-editable"
                 data-task-id="{{ task.id }}"
                 data-original-text="{{ task.text|escapejs }}">{{ task.text|linebreaks }}</div>
            
            <!-- Reminder Display -->
            {% if task.has_reminder %}
                <div class="reminder-display flex items-center space-x-1 mt-1 text-xs ml-1" style="color: var(--primary-action-bg);">
                    <i class="fas fa-calendar-check text-green-500"></i>
                    <span>{{ task.get_reminder_date_display }}</span>
                </div>
            {% endif %}
            
            <!-- Assignee Display -->
            {% if project.is_team_toad and task.assigned_to %}
                <div class="assignee-display flex items-center mt-1 text-xs ml-1">
                    <div class="assignee-avatar" 
                         style="width: 16px; height: 16px; border-radius: 50%; background-color: {{ task.assigned_to.pk|get_avatar_color }}; color: white; font-weight: 600; font-size: 8px; display: flex; align-items: center; justify-content: center; margin-right: 4px;"
                         title="{{ task.assigned_to.get_full_name }}">
                        {{ task.assigned_to.get_full_name|get_smart_initials:project.team_toad_user.all }}
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Actions -->
    <div class="flex-shrink-0 flex space-x-1 opacity-0 group-hover:opacity-100 transition-opacity duration-200 desktop-task-actions">
        {% if project.is_team_toad %}
        <button type="button"
                class="assign-task-btn p-1 rounded hover:bg-[var(--grid-header-bg)] transition-colors cursor-pointer" 
                title="{% if task.assigned_to %}Reassign task{% else %}Assign task{% endif %}"
                data-task-id="{{ task.pk }}"
                data-task-text="{{ task.text }}"
                {% if task.assigned_to %}data-assigned-to="{{ task.assigned_to.pk }}"{% endif %}>
            <i class="fas fa-user text-gray-400 hover:text-orange-500 text-xs transition-colors"></i>
        </button>
        {% endif %}
        <button type="button"
                class="task-note-btn p-1 rounded hover:bg-[var(--grid-header-bg)] transition-colors cursor-pointer" 
                title="{% if task.notes.exists %}Edit note{% else %}Add note{% endif %}"
                data-task-id="{{ task.pk }}"
                data-task-text="{{ task.text }}"
                {% if task.notes.exists %}data-has-note="true"{% else %}data-has-note="false"{% endif %}>
            <i class="fas {% if task.notes.exists %}fa-sticky-note text-[var(--primary-action-bg)]{% else %}fa-sticky-note text-gray-400 hover:text-[var(--primary-action-bg)]{% endif %} text-xs transition-colors"></i>
        </button>
        <button type="button"
                class="calendar-reminder-btn p-1 rounded hover:bg-[var(--grid-header-bg)] transition-colors cursor-pointer" 
                title="{% if task.has_reminder %}Edit reminder{% else %}Set reminder{% endif %}"
                data-task-id="{{ task.pk }}"
                data-task-text="{{ task.text }}"
                {% if task.has_reminder %}data-reminder-date="{{ task.reminder|date:'Y-m-d' }}"{% endif %}>
            <i class="fas {% if task.has_reminder %}fa-calendar-check text-green-500{% else %}fa-calendar-plus text-gray-400 hover:text-[var(--primary-action-bg)]{% endif %} text-xs transition-colors"></i>
        </button>
        <button type="button"
                class="delete-task-btn p-1 rounded hover:bg-[var(--grid-header-bg)] transition-colors cursor-pointer" 
                title="Delete task"
                data-task-id="{{ task.pk }}"
                data-task-text="{{ task.text }}"
                data-delete-url="{% url 'pages:task_delete' task_pk=task.pk %}">
            <i class="fas fa-trash text-xs text-gray-400 hover:text-[var(--delete-button-bg)] transition-colors"></i>
        </button>
    </div>
    
    <!-- Mobile Actions -->
    <div class="mobile-task-actions flex flex-row justify-end items-center space-x-1 {% if project.is_team_toad %}min-w-[100px]{% else %}min-w-[70px]{% endif %} opacity-100">
        {% if project.is_team_toad %}
        <button type="button"
                class="assign-task-btn p-2 rounded hover:bg-[var(--grid-header-bg)] transition-colors cursor-pointer" 
                title="{% if task.assigned_to %}Reassign task{% else %}Assign task{% endif %}"
                data-task-id="{{ task.pk }}"
                data-task-text="{{ task.text }}"
                {% if task.assigned_to %}data-assigned-to="{{ task.assigned_to.pk }}"{% endif %}>
            <i class="fas fa-user text-gray-400 hover:text-orange-500 text-sm transition-colors"></i>
        </button>
        {% endif %}
        <button type="button"
                class="task-note-btn p-2 rounded hover:bg-[var(--grid-header-bg)] transition-colors cursor-pointer" 
                title="{% if task.notes.exists %}Edit note{% else %}Add note{% endif %}"
                data-task-id="{{ task.pk }}"
                data-task-text="{{ task.text }}"
                {% if task.notes.exists %}data-has-note="true"{% else %}data-has-note="false"{% endif %}>
            <i class="fas {% if task.notes.exists %}fa-sticky-note text-[var(--primary-action-bg)]{% else %}fa-sticky-note text-gray-400 hover:text-[var(--primary-action-bg)]{% endif %} text-sm transition-colors"></i>
        </button>
        <button type="button"
                class="calendar-reminder-btn p-2 rounded hover:bg-[var(--grid-header-bg)] transition-colors cursor-pointer" 
                title="{% if task.has_reminder %}Edit reminder{% else %}Set reminder{% endif %}"
                data-task-id="{{ task.pk }}"
                data-task-text="{{ task.text }}"
                {% if task.has_reminder %}data-reminder-date="{{ task.reminder|date:'Y-m-d' }}"{% endif %}>
            <i class="fas {% if task.has_reminder %}fa-calendar-check text-green-500{% else %}fa-calendar-plus text-gray-400 hover:text-[var(--primary-action-bg)]{% endif %} text-sm transition-colors"></i>
        </button>
        <button type="button"
                class="delete-task-btn p-2 rounded hover:bg-[var(--grid-header-bg)] transition-colors cursor-pointer" 
                title="Delete task"
                data-task-id="{{ task.pk }}"
                data-task-text="{{ task.text }}"
                data-delete-url="{% url 'pages:task_delete' task_pk=task.pk %}">
            <i class="fas fa-trash text-sm text-gray-400 hover:text-[var(--delete-button-bg)] transition-colors"></i>
        </button>
    </div>
</div> 