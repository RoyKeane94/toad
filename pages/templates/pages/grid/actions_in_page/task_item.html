{% load static %}
<div class="group flex items-center justify-between w-full p-2 rounded-lg hover:bg-[var(--grid-header-bg)] transition-all duration-200"
     data-task-id="{{ task.id }}"
     id="task-{{ task.id }}"
     data-task-order="{{ task.order|default:0 }}"
     data-task-row="{{ task.row.pk }}"
     data-task-col="{{ task.column.pk }}">
    <div class="flex items-center space-x-3 min-w-0 flex-1">
            <!-- Drag Handle (Desktop Only) -->
    <div class="drag-handle flex-shrink-0 cursor-grab active:cursor-grabbing opacity-0 group-hover:opacity-100 transition-opacity duration-200 mr-2"
         title="Drag to reorder">
        <i class="fas fa-grip-vertical text-xs text-[var(--text-secondary)] hover:text-[var(--primary-action-bg)]"></i>
    </div>
        
        <form method="POST" 
              action="{% url 'pages:task_toggle_complete' task.pk %}" 
              onsubmit="plausible('task_completed');"
              class="flex-shrink-0"
              hx-post="{% url 'pages:task_toggle_complete' task.pk %}"
              hx-swap="none"
              hx-trigger="change throttle:300ms"
              hx-disabled-elt="find input"
              _="on change 
                   -- Apply visual changes immediately for instant feedback
                   if target.checked
                     add .task-completed-strikethrough to #task-text-{{ task.id }}
                     add .checkbox-completed to #checkbox-{{ task.id }}
                   else
                     remove .task-completed-strikethrough from #task-text-{{ task.id }}
                     remove .checkbox-completed from #checkbox-{{ task.id }}
                   end
                 end
                 on htmx:afterRequest(detail) 
                   -- Handle server response errors by reverting changes
                   if not detail.successful
                     -- Server request failed, revert visual changes
                     if target.checked
                       remove .task-completed-strikethrough from #task-text-{{ task.id }}
                       remove .checkbox-completed from #checkbox-{{ task.id }}
                       set target.checked to false
                     else
                       add .task-completed-strikethrough to #task-text-{{ task.id }}
                       add .checkbox-completed to #checkbox-{{ task.id }}
                       set target.checked to true
                     end
                   end
                 end">
            {% csrf_token %}
            <input type="checkbox" 
                   id="checkbox-{{ task.id }}"
                   name="completed" 
                   {% if task.completed %}checked{% endif %}
                   class="w-4 h-4 rounded border-gray-300 text-[var(--primary-action-bg)] focus:ring-[var(--primary-action-bg)] cursor-pointer {% if task.completed %}checkbox-completed{% endif %}">
        </form>
        <div id="task-text-{{ task.id }}" 
             class="text-sm text-[var(--text-primary)] {% if task.completed %}task-completed-strikethrough{% endif %} leading-relaxed whitespace-pre-wrap cursor-text hover:bg-[var(--grid-header-bg)] hover:rounded px-1 transition-all duration-200 task-text-editable"
             data-task-id="{{ task.id }}"
             data-original-text="{{ task.text|escapejs }}">{{ task.text|linebreaks }}</div>
    </div>
    
    <!-- Actions -->
    <div class="flex-shrink-0 flex space-x-1 opacity-0 group-hover:opacity-100 transition-opacity duration-200 desktop-task-actions">
        <button type="button"
                class="calendar-reminder-btn p-1 rounded hover:bg-[var(--grid-header-bg)] transition-colors cursor-pointer" 
                title="Set reminder"
                data-task-id="{{ task.pk }}"
                data-task-text="{{ task.text }}">
            <i class="fas fa-calendar-plus text-xs text-gray-400 hover:text-[var(--primary-action-bg)] transition-colors"></i>
        </button>
        <button type="button"
                class="delete-task-btn p-1 rounded hover:bg-[var(--grid-header-bg)] transition-colors cursor-pointer" 
                title="Delete task"
                data-task-id="{{ task.pk }}"
                data-task-text="{{ task.text }}"
                data-delete-url="{% url 'pages:task_delete' task_pk=task.pk %}">
            <i class="fas fa-trash text-xs text-gray-400 hover:text-[var(--delete-button-bg)] transition-colors"></i>
        </button>
    </div>
    
    <!-- Mobile Actions -->
    <div class="mobile-task-actions flex flex-row justify-end items-center space-x-1 min-w-[70px] opacity-100">
        <button type="button"
                class="calendar-reminder-btn p-2 rounded hover:bg-[var(--grid-header-bg)] transition-colors cursor-pointer" 
                title="Set reminder"
                data-task-id="{{ task.pk }}"
                data-task-text="{{ task.text }}">
            <i class="fas fa-calendar-plus text-sm text-gray-400 hover:text-[var(--primary-action-bg)] transition-colors"></i>
        </button>
        <button type="button"
                class="delete-task-btn p-2 rounded hover:bg-[var(--grid-header-bg)] transition-colors cursor-pointer" 
                title="Delete task"
                data-task-id="{{ task.pk }}"
                data-task-text="{{ task.text }}"
                data-delete-url="{% url 'pages:task_delete' task_pk=task.pk %}">
            <i class="fas fa-trash text-sm text-gray-400 hover:text-[var(--delete-button-bg)] transition-colors"></i>
        </button>
    </div>
</div> 