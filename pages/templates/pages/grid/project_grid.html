{% extends "pages/layout.html" %}
{% load custom_filters %}
{% load static %}

{% block title %}{{ project.name }} - Toad{% endblock %}

{% block extra_head %}
<!-- Grid-specific JavaScript - conditional loading for production -->
{% if not debug %}
    <script src="{% static 'js/grid/grid.min.js' %}"></script>
{% else %}
    <script src="{% static 'js/grid/grid_optimized.js' %}"></script>
{% endif %}

<!-- Team functionality JavaScript - only load for team_toad projects -->
{% if project.is_team_toad %}
    <script src="{% static 'js/grid/grid_team.js' %}"></script>
{% endif %}

<style>
    /* Loading overlay styles */
    .grid-loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: var(--main-bg);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        transition: opacity 0.3s ease-out;
    }
    
    .grid-loading-spinner {
        width: 40px;
        height: 40px;
        border: 3px solid var(--border-color);
        border-top: 3px solid var(--primary-action-bg);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    /* Hide grid content until loaded */
    .grid-content-hidden {
        opacity: 0;
        transition: opacity 0.3s ease-in;
    }
    
    .grid-content-visible {
        opacity: 1;
    }
    
    /* SortableJS styles */
    .sortable-drag {
        box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        cursor: grabbing;
        background-color: white;
        opacity: 0.8;
        transform: rotate(2deg);
    }

    .sortable-ghost {
        opacity: 0.5;
        border: 2px dashed var(--primary-action-bg);
        background-color: var(--grid-header-bg);
    }
    
    .sortable-ghost > * {
        opacity: 0;
    }
    
    .drag-handle {
        cursor: grab;
    }
    
    .drag-handle:active {
        cursor: grabbing;
    }
    
    /* Hide drag handle on mobile */
    @media (max-width: 768px) {
        .drag-handle {
            display: none;
        }
    }
    
    /* Inline editing styles */
    .editing {
        background-color: var(--container-bg) !important;
        border: 2px dashed var(--tertiary-action-bg) !important;
        border-radius: 6px !important;
        padding: 4px 8px !important;
        outline: none !important;
        min-height: 24px !important;
        box-shadow: 0 0 0 3px var(--tertiary-action-bg) / 0.1 !important;
        position: relative !important;
    }
    
    .editing:focus {
        box-shadow: 0 0 0 3px var(--tertiary-action-bg) / 0.2 !important;
        border-color: var(--tertiary-action-bg) !important;
    }
    
    /* Smooth scrolling optimizations */
    .grid-table-scrollable {
        scroll-behavior: smooth;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: thin;
        scrollbar-color: var(--border-color) transparent;
    }
    
    .grid-table-scrollable::-webkit-scrollbar {
        height: 8px;
    }
    
    .grid-table-scrollable::-webkit-scrollbar-track {
        background: transparent;
    }
    
    .grid-table-scrollable::-webkit-scrollbar-thumb {
        background-color: var(--border-color);
        border-radius: 4px;
    }
    
    .grid-table-scrollable::-webkit-scrollbar-thumb:hover {
        background-color: var(--text-secondary);
    }
    
    /* Optimize scroll button interactions */
    .external-scroll-btn {
        transition: all 0.15s ease-out;
        will-change: transform, opacity;
    }
    
    .external-scroll-btn:hover {
        transform: scale(1.05);
    }
    
    .external-scroll-btn:active {
        transform: scale(0.95);
    }
    
    .external-scroll-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }
    
    /* Delete button and calendar reminder button styling */
    .row-delete-btn,
    .column-delete-btn,
    .delete-task-btn,
    .calendar-reminder-btn,
    .assign-task-btn {
        transition: all 0.2s ease-out;
        will-change: opacity, transform;
    }
    
    .row-delete-btn:hover,
    .column-delete-btn:hover,
    .delete-task-btn:hover,
    .calendar-reminder-btn:hover,
    .assign-task-btn:hover {
        transform: scale(1.1);
    }
    
    .row-delete-btn:active,
    .column-delete-btn:active,
    .delete-task-btn:active,
    .calendar-reminder-btn:active,
    .assign-task-btn:active {
        transform: scale(0.95);
    }
    
    /* Assign Task Popup Styling */
    .assign-popup {
        position: absolute;
        background: var(--container-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        padding: 12px;
        z-index: 1000;
        display: none;
        min-width: 160px;
    }
    
    .assign-popup.active {
        display: block;
    }
    
    .assign-popup-arrow {
        position: absolute;
        width: 8px;
        height: 8px;
        background: var(--container-bg);
        border: 1px solid var(--border-color);
        transform: rotate(45deg);
        left: 16px;
        top: -5px;
        border-right: none;
        border-bottom: none;
    }
    
    .user-avatar {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 10px;
        cursor: pointer;
        transition: all 0.2s ease;
        border: 3px solid transparent;
        position: relative;
    }
    
    .user-avatar:hover {
        transform: scale(1.1);
        border-color: rgba(255, 255, 255, 0.4);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }
    
    .user-avatar.selected {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    
    .user-list {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 8px;
        justify-content: center;
        align-items: center;
    }
    
    .unassign-option {
        width: 100%;
        padding: 8px 12px;
        background: var(--grid-header-bg);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        color: var(--text-secondary);
        font-size: 12px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .unassign-option:hover {
        background: var(--delete-button-bg);
        color: white;
        border-color: var(--delete-button-bg);
    }
    
    /* Ensure smooth opacity transitions for delete buttons */
    .opacity-0 {
        opacity: 0 !important;
    }
    
    .group:hover .opacity-0 {
        opacity: 1 !important;
    }
    
    /* Task text hover state for desktop */
    @media (min-width: 769px) {
        .task-text-editable:hover {
            background-color: var(--grid-header-bg) !important;
            border-radius: 6px !important;
            padding: 4px 8px !important;
            cursor: text !important;
            transition: all 0.2s ease !important;
        }
        
        /* Row and column header inline editing styles */
        .row-header-editable:hover,
        .column-header-editable:hover {
            background-color: var(--grid-header-bg) !important;
            border-radius: 6px !important;
            padding: 4px 8px !important;
            cursor: text !important;
            transition: all 0.2s ease !important;
        }
        
        .row-header-editable.editing,
        .column-header-editable.editing {
            background-color: var(--container-bg) !important;
            border: 2px dashed var(--tertiary-action-bg) !important;
            border-radius: 6px !important;
            padding: 4px 8px !important;
            outline: none !important;
            min-height: 24px !important;
            box-shadow: 0 0 0 3px var(--tertiary-action-bg) / 0.1 !important;
            position: relative !important;
        }
        
        .row-header-editable.editing:focus,
        .column-header-editable.editing:focus {
            box-shadow: 0 0 0 3px var(--tertiary-action-bg) / 0.2 !important;
            border-color: var(--tertiary-action-bg) !important;
        }
        
        /* Grid name inline editing styles */
        .grid-name-editable:hover {
            background-color: var(--grid-header-bg) !important;
            border-radius: 6px !important;
            padding: 4px 8px !important;
            cursor: text !important;
            transition: all 0.2s ease !important;
        }
        
        .grid-name-editable.editing {
            background-color: var(--container-bg) !important;
            border: 2px dashed var(--tertiary-action-bg) !important;
            border-radius: 6px !important;
            padding: 4px 8px !important;
            outline: none !important;
            min-height: 24px !important;
            box-shadow: 0 0 0 3px var(--tertiary-action-bg) / 0.1 !important;
            position: relative !important;
        }
        
        .grid-name-editable.editing:focus {
            box-shadow: 0 0 0 3px var(--tertiary-action-bg) / 0.2 !important;
            border-color: var(--tertiary-action-bg) !important;
        }
    }
    
    /* Grid Tabs Styling */
    .scrollbar-hide {
        -ms-overflow-style: none;  /* Internet Explorer 10+ */
        scrollbar-width: none;  /* Firefox */
    }
    
    .scrollbar-hide::-webkit-scrollbar {
        display: none;  /* Safari and Chrome */
    }
    
    /* Active grid tab styling */
    #grid-tabs a[href*="{{ project.pk }}"] {
        color: var(--text-primary) !important;
        border-bottom: 2px solid var(--primary-action-bg) !important;
        border-radius: 0 !important;
    }
    
    /* Remove border radius from all tabs for flat underline */
    #grid-tabs a {
        border-radius: 0 !important;
    }
    
    /* Ensure grid tabs are visible */
    #grid-tabs {
        opacity: 1 !important;
        visibility: visible !important;
    }
    
    /* Archived project tab styling */
    #grid-tabs a[href*="{{ project.pk }}"].opacity-60 {
        opacity: 0.6 !important;
    }
    
    #grid-tabs a.opacity-60:hover {
        opacity: 0.8 !important;
    }
    
    /* Grid tabs responsive design */
    @media (max-width: 640px) {
        #grid-tabs .flex-wrap {
            gap: 0.5rem;
        }
        
        #grid-tabs a {
            font-size: 0.875rem;
            padding: 0.5rem 0.75rem;
        }
    }
    
    /* Button consistency */
    .grid-actions-mobile button,
    .grid-actions-mobile a {
        min-width: 12rem; /* w-48 = 12rem */
        text-align: center;
    }
    
    /* Ensure buttons are properly aligned */
    .grid-actions-mobile {
        align-items: stretch;
    }
    
    /* Container for tabs and header that adjusts width based on column count */
    .grid-header-container {
        max-width: 90vw;
        margin: 0 auto;
        padding: 0; /* No padding to align with grid content */
    }
    
    /* Narrow layout for grids with 4+ data columns */
    .grid-header-container.narrow-layout {
        max-width: 83vw; /* Narrower when scroll buttons are present */
        padding: 0; /* No padding to align with grid content */
    }
    
    /* Ensure grid content wrapper aligns with tabs and header */
    #grid-content-wrapper {
        max-width: 90vw;
        margin: 0 auto;
    }

</style>
{% endblock %}

{% block content %}

<!-- CSRF Token for inline editing -->
{% csrf_token %}

<script>
// Check column count and apply narrow layout if needed
document.addEventListener('DOMContentLoaded', function() {
    const totalColumns = parseInt('{{ total_data_columns }}');
    
    if (totalColumns > 3) {
        document.getElementById('grid-tabs-container').classList.add('narrow-layout');
        document.getElementById('grid-header-container').classList.add('narrow-layout');
    }
});
</script>

<!-- Loading Overlay -->
<div id="grid-loading-overlay" class="grid-loading-overlay">
    <div class="grid-loading-spinner"></div>
</div>

<!-- Grid Tabs Navigation -->
<div class="grid-header-container mb-6 " id="grid-tabs-container" data-total-columns="{{ total_data_columns }}">
    <div id="grid-tabs">
            <div class="flex flex-wrap gap-1 overflow-x-auto pb-2 scrollbar-hide ">
            <!-- Ungrouped Projects First -->
            {% if ungrouped_projects %}
                <div class="flex-shrink-0">
                    <div class="text-xs font-semibold text-[var(--text-secondary)] uppercase tracking-wide mb-2 px-3">{{ user.first_name|default:user.username }}'s Grids</div>
                    <div class="flex flex-wrap gap-1">
                        {% for p in ungrouped_projects %}
                            <a href="{% url 'pages:project_grid' pk=p.pk %}" 
                               class="inline-flex items-center px-3 py-2 text-sm font-medium rounded-lg transition-all duration-200 cursor-pointer whitespace-nowrap {% if p.pk == project.pk %}text-[var(--text-primary)] border-b-2 border-[var(--primary-action-bg)]{% else %}text-[var(--text-primary)]{% endif %}">
                                {{ p.name }}
                            </a>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}
            
            <!-- Grouped Projects -->
            {% for group_data in grouped_projects %}
                <div class="flex-shrink-0">
                    <div class="text-xs font-semibold text-[var(--text-secondary)] uppercase tracking-wide mb-2 px-3">{{ group_data.group.name }}</div>
                    <div class="flex flex-wrap gap-1">
                        {% for p in group_data.projects %}
                            <a href="{% url 'pages:project_grid' pk=p.pk %}" 
                               class="inline-flex items-center px-3 py-2 text-sm font-medium rounded-lg transition-all duration-200 cursor-pointer whitespace-nowrap {% if p.pk == project.pk %}text-[var(--text-primary)] border-b-2 border-[var(--primary-action-bg)]{% else %}text-[var(--text-primary)]{% endif %}">
                                {{ p.name }}
                            </a>
                        {% endfor %}
                    </div>
                </div>
            {% endfor %}
            
            <!-- Archived Projects - Only show if current project is archived -->
            {% if project.is_archived and archived_projects %}
                <div class="flex-shrink-0">
                    <div class="text-xs font-semibold text-[var(--text-secondary)] uppercase tracking-wide mb-2 px-3 opacity-60">Archived</div>
                    <div class="flex flex-wrap gap-1">
                        {% for p in archived_projects %}
                            <a href="{% url 'pages:project_grid' pk=p.pk %}" 
                               class="inline-flex items-center px-3 py-2 text-sm font-medium rounded-lg transition-all duration-200 cursor-pointer whitespace-nowrap opacity-60 {% if p.pk == project.pk %}text-[var(--primary-action-bg)] border-b-2 border-[var(--primary-action-bg)]{% else %}text-[var(--text-secondary)]{% endif %}">
                                {{ p.name }}
                            </a>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
    </div>
</div>

<!-- Header -->
<div class="grid-header-container mb-6 " id="grid-header-container" data-total-columns="{{ total_data_columns }}">
    <div id="grid-header" class="grid-header-mobile grid-content-hidden">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4 gap-4">
        <div class="flex flex-col space-y-3">
            <div class="flex items-center space-x-3">
                <h1 class="text-2xl sm:text-3xl font-bold text-[var(--primary-action-bg)] grid-name-editable cursor-text" data-project-id="{{ project.pk }}">{{ project.name }}</h1>
            </div>
            
            <!-- Team Members Display - Only show for team_toad projects -->
            {% if project.is_team_toad and project.team_toad_user.all %}
            <div class="flex items-center space-x-1" id="team-members-display">
                {% for team_member in project.team_toad_user.all %}
                <div class="team-member-avatar cursor-pointer transition-all duration-200 hover:scale-110" 
                     data-user-id="{{ team_member.pk }}" 
                     data-user-name="{{ team_member.get_full_name }}"
                     style="--avatar-color: {{ team_member.pk|get_avatar_color }}; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 10px; background-color: var(--avatar-color)"
                     title="{{ team_member.get_full_name }} - Click to filter tasks">
                    {{ team_member.get_full_name|get_initials }}
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>
        
        <!-- Grid Actions - Right Aligned -->
        <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-2 grid-actions-mobile">
            <div class="w-full sm:w-auto flex items-center gap-1">
                <button type="button"
                        class="inline-flex items-center justify-center w-full sm:w-48 py-1.5 text-sm font-medium text-[var(--clear-button-bg)] bg-white border border-[var(--clear-button-bg)] rounded-lg hover:bg-[var(--clear-button-bg)] hover:text-white transition-all duration-200 cursor-pointer"
                        onclick="showClearCompletedModal()">
                    <i class="fas fa-check mr-1"></i>Clear Completed
                </button>
                
                <!-- Grid Name Actions Dropdown -->
                <div class="relative" id="grid-name-actions-container">
                    <div type="button" 
                         id="grid-name-actions-btn"
                         class="group w-6 h-6 text-[var(--text-secondary)] hover:text-[var(--primary-action-bg)] transition-all duration-200 cursor-pointer p-0 m-0 min-w-0 min-h-0 border-0 flex items-center justify-center ml-2">
                        <i class="fas fa-ellipsis-v text-base font-semibold"></i>
                    </div>
                    
                    <!-- Dropdown Menu -->
                    <div id="grid-name-actions-dropdown" 
                         class="absolute top-full right-0 mt-2 w-48 bg-[var(--container-bg)] border border-[var(--border-color)] rounded-lg shadow-lg py-2 z-50 opacity-0 invisible transform scale-95 transition-all duration-200 origin-top-right">
                        
                        <!-- + Row -->
                        <button type="button"
                                class="w-full flex items-center space-x-3 px-4 py-2 text-sm text-[var(--primary-action-bg)] hover:bg-[var(--grid-header-bg)] transition-colors cursor-pointer"
                                hx-get="{% url 'pages:row_create' project_pk=project.pk %}"
                                hx-target="#modal-content"
                                hx-trigger="click throttle:500ms"
                                hx-disabled-elt="this"
                                hx-indicator="#modal-content"
                                hx-swap="innerHTML"
                                hx-headers='{"Cache-Control": "no-cache"}'
                                onclick="closeAllDropdowns(); document.getElementById('modal').classList.remove('opacity-0', 'invisible'); document.getElementById('modal').querySelector('div').classList.remove('scale-95'); document.getElementById('modal').querySelector('div').classList.add('scale-100');">
                            <i class="fas fa-plus text-xs w-4 text-center"></i>
                            <span>Row</span>
                        </button>
                        
                        <!-- + Column -->
                        <button type="button"
                                class="w-full flex items-center space-x-3 px-4 py-2 text-sm text-[var(--primary-action-bg)] hover:bg-[var(--grid-header-bg)] transition-colors cursor-pointer"
                                hx-get="{% url 'pages:column_create' project_pk=project.pk %}"
                                hx-target="#modal-content"
                                hx-trigger="click throttle:500ms"
                                hx-disabled-elt="this"
                                hx-indicator="#modal-content"
                                hx-swap="innerHTML"
                                hx-headers='{"Cache-Control": "no-cache"}'
                                onclick="closeAllDropdowns(); document.getElementById('modal').classList.remove('opacity-0', 'invisible'); document.getElementById('modal').querySelector('div').classList.remove('scale-95'); document.getElementById('modal').querySelector('div').classList.add('scale-100');">
                            <i class="fas fa-plus text-xs w-4 text-center"></i>
                            <span>Column</span>
                        </button>
                        
                        <!-- Divider -->
                        <div class="border-t border-[var(--border-color)] my-2"></div>

                        <!-- Share Grid -->
                        {% if user_tier == 'free' %}
                        <a href="{% url 'pages:upgrade_required' %}"
                           class="w-full flex items-center space-x-3 px-4 py-2 text-sm text-[var(--tertiary-action-bg)] hover:bg-[var(--grid-header-bg)] transition-colors cursor-pointer"
                           onclick="closeAllDropdowns();">
                            <i class="fas fa-share text-xs w-4 text-center"></i>
                            <span>Share Grid</span>
                        </a>
                        {% else %}
                        <button type="button"
                                class="w-full flex items-center space-x-3 px-4 py-2 text-sm text-[var(--tertiary-action-bg)] hover:bg-[var(--grid-header-bg)] transition-colors cursor-pointer"
                                onclick="closeAllDropdowns(); document.getElementById('share-grid-modal').classList.remove('opacity-0', 'invisible'); document.getElementById('share-grid-modal').querySelector('div').classList.remove('scale-95'); document.getElementById('share-grid-modal').querySelector('div').classList.add('scale-100');">
                            <i class="fas fa-share text-xs w-4 text-center"></i>
                            <span>Share Grid</span>
                        </button>
                        {% endif %}
                        
                        {% if project.is_archived %}
                            <!-- Restore Grid -->
                            <form method="post" action="{% url 'pages:restore_project' pk=project.pk %}" class="w-full">
                                {% csrf_token %}
                                <button type="submit" 
                                       class="w-full flex items-center space-x-3 px-4 py-2 text-sm text-[var(--primary-action-bg)] hover:bg-[var(--grid-header-bg)] transition-colors cursor-pointer"
                                       onclick="closeAllDropdowns();">
                                    <i class="fas fa-undo text-xs w-4 text-center"></i>
                                    <span>Restore Grid</span>
                                </button>
                            </form>
                        {% else %}
                            <!-- Archive Grid -->
                            {% if user_tier == 'free' %}
                            <a href="{% url 'pages:upgrade_required' %}"
                               class="w-full flex items-center space-x-3 px-4 py-2 text-sm text-[var(--tertiary-action-bg)] hover:bg-[var(--grid-header-bg)] transition-colors cursor-pointer"
                               onclick="closeAllDropdowns();">
                                <i class="fas fa-archive text-xs w-4 text-center"></i>
                                <span>Archive Grid</span>
                            </a>
                            {% else %}
                            <button type="button"
                                    class="w-full flex items-center space-x-3 px-4 py-2 text-sm text-[var(--tertiary-action-bg)] hover:bg-[var(--grid-header-bg)] transition-colors cursor-pointer"
                                    hx-get="{% url 'pages:archive_project_confirm' pk=project.pk %}"
                                    hx-target="#modal-content"
                                    hx-trigger="click throttle:500ms"
                                    hx-disabled-elt="this"
                                    hx-indicator="#modal-content"
                                    hx-swap="innerHTML"
                                    hx-headers='{"Cache-Control": "no-cache"}'
                                    onclick="closeAllDropdowns(); document.getElementById('modal').classList.remove('opacity-0', 'invisible'); document.getElementById('modal').querySelector('div').classList.remove('scale-95'); document.getElementById('modal').querySelector('div').classList.add('scale-100');">
                                <i class="fas fa-archive text-xs w-4 text-center"></i>
                                <span>Archive Grid</span>
                            </button>
                            {% endif %}
                        {% endif %}
                        
                        <!-- Save as Template -->
                        {% if user_tier == 'free' %}
                        <a href="{% url 'pages:upgrade_required' %}"
                           class="w-full flex items-center space-x-3 px-4 py-2 text-sm text-[var(--tertiary-action-bg)] hover:bg-[var(--grid-header-bg)] transition-colors cursor-pointer"
                           onclick="closeAllDropdowns();">
                            <i class="fas fa-save text-xs w-4 text-center"></i>
                            <span>Save as Template</span>
                        </a>
                        {% else %}
                        <button type="button"
                                class="w-full flex items-center space-x-3 px-4 py-2 text-sm text-[var(--tertiary-action-bg)] hover:bg-[var(--grid-header-bg)] transition-colors cursor-pointer"
                                onclick="closeAllDropdowns(); document.getElementById('save-template-modal').classList.remove('opacity-0', 'invisible'); document.getElementById('save-template-modal').querySelector('div').classList.remove('scale-95'); document.getElementById('save-template-modal').querySelector('div').classList.add('scale-100');">
                            <i class="fas fa-save text-xs w-4 text-center"></i>
                            <span>Save as Template</span>
                        </button>
                        {% endif %}
                        
                        <!-- Divider -->
                        <div class="border-t border-[var(--border-color)] my-2"></div>
                        
                        <!-- Delete Grid -->
                        <button type="button"
                                class="w-full flex items-center space-x-3 px-4 py-2 text-sm text-[var(--delete-button-bg)] hover:bg-[var(--grid-header-bg)] transition-colors cursor-pointer"
                                hx-get="{% url 'pages:project_delete' pk=project.pk %}"
                                hx-target="#modal-content"
                                hx-trigger="click throttle:500ms"
                                hx-disabled-elt="this"
                                hx-indicator="#modal-content"
                                hx-swap="innerHTML"
                                hx-headers='{"Cache-Control": "no-cache"}'
                                onclick="closeAllDropdowns(); document.getElementById('modal').classList.remove('opacity-0', 'invisible'); document.getElementById('modal').querySelector('div').classList.remove('scale-95'); document.getElementById('modal').querySelector('div').classList.add('scale-100');">
                            <i class="fas fa-trash text-xs w-4 text-center"></i>
                            <span>Delete Grid</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>            
    </div>
    </div>
</div>



<!-- Task Grid -->
<div class="grid-content-hidden" id="grid-content-wrapper">
{% include 'pages/grid/partials/grid_content.html' %}
</div>

<!-- Task Deletion Modal -->
<div id="delete-task-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 opacity-0 invisible transition-all duration-300">
    <div class="bg-[var(--container-bg)] rounded-xl shadow-2xl border border-[var(--border-color)] max-w-md w-full mx-4 transform scale-95 transition-all duration-300" id="delete-modal-content">
        <!-- Modal Header -->
        <div class="flex items-center justify-between p-6 border-b border-[var(--border-color)]">
            <div class="flex items-center space-x-3">
                <div class="flex items-center justify-center w-10 h-10 bg-[var(--delete-button-bg)] rounded-lg shadow-sm">
                    <i class="fas fa-exclamation-triangle text-white"></i>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-[var(--text-primary)]">Delete Task</h3>
                    <p class="text-sm text-[var(--text-secondary)]">This action cannot be undone</p>
                </div>
            </div>
            <button type="button" id="close-delete-modal" class="text-[var(--text-secondary)] hover:text-[var(--text-primary)] transition-colors">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <!-- Modal Body -->
        <div class="p-6">
            <div class="mb-6">
                <p class="text-[var(--text-primary)] mb-2">Are you sure you want to delete this task?</p>
                <div class="bg-[var(--grid-header-bg)] border border-[var(--border-color)] rounded-lg p-4">
                    <div class="flex items-start space-x-3">
                        <div class="flex items-center justify-center w-8 h-8 bg-[var(--primary-action-bg)] rounded-lg shadow-sm flex-shrink-0">
                            <i class="fas fa-tasks text-white text-sm"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="font-medium text-[var(--text-primary)] text-sm" id="task-to-delete">Task Name</p>
                            <p class="text-xs text-[var(--text-secondary)] mt-1">This task will be permanently removed from your grid</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Modal Footer -->
        <div class="flex items-center justify-end space-x-3 p-6 border-t border-[var(--border-color)] bg-[var(--grid-header-bg)]/30 rounded-b-xl">
            <button type="button" 
                    id="cancel-delete-task"
                    class="w-32 h-10 flex items-center justify-center border border-[var(--border-color)] text-[var(--text-secondary)] rounded-lg hover:bg-[var(--container-bg)] hover:text-[var(--text-primary)] transition-all duration-200 font-medium cursor-pointer">
                <i class="fas fa-times mr-2"></i>Cancel
            </button>
            <form id="delete-task-form" method="post" class="inline"
                  hx-swap="none"
                  hx-trigger="submit"
                  hx-disabled-elt="this">
                {% csrf_token %}
                <button type="submit" 
                        class="w-32 h-10 flex items-center justify-center bg-[var(--delete-button-bg)] hover:bg-[var(--delete-button-hover-bg)] text-white rounded-lg transition-all duration-200 font-medium shadow-sm hover:shadow-md cursor-pointer">
                    <i class="fas fa-trash mr-2"></i>Delete Task
                </button>
            </form>
        </div>
    </div>
</div>

<!-- Modal Container -->
<div id="modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 opacity-0 invisible transition-all duration-300">
    <div class="bg-[var(--container-bg)] rounded-xl shadow-2xl border border-[var(--border-color)] max-w-md w-full mx-4 transform scale-95 transition-all duration-300" id="modal-content">
        <!-- Modal content will be loaded here -->
    </div>
</div>

<!-- Calendar Reminder Modal -->
<div id="calendar-reminder-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 opacity-0 invisible transition-all duration-300">
    <div class="bg-[var(--container-bg)] rounded-xl shadow-2xl border border-[var(--border-color)] max-w-md w-full mx-4 transform scale-95 transition-all duration-300" id="calendar-modal-content">
        <!-- Modal Header -->
        <div class="flex items-center justify-between p-6 border-b border-[var(--border-color)]">
            <div class="flex items-center space-x-3">
                <div class="flex items-center justify-center w-10 h-10 bg-[var(--primary-action-bg)] rounded-lg shadow-sm">
                    <i class="fas fa-calendar-plus text-white"></i>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-[var(--text-primary)]">Set Task Reminder</h3>
                    <p class="text-sm text-[var(--text-secondary)]">Schedule a calendar reminder for this task</p>
                </div>
            </div>
            <button type="button" id="close-calendar-modal" class="text-[var(--text-secondary)] hover:text-[var(--text-primary)] transition-colors">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <!-- Modal Body -->
        <form id="calendar-reminder-form" method="post">
            {% csrf_token %}
            <div class="p-6">
                <div class="mb-6">
                    <div class="bg-[var(--grid-header-bg)] border border-[var(--border-color)] rounded-lg p-4 mb-6">
                        <div class="flex items-start space-x-3">
                            <div class="flex items-center justify-center w-8 h-8 bg-[var(--primary-action-bg)] rounded-lg shadow-sm flex-shrink-0">
                                <i class="fas fa-tasks text-white text-sm"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="font-medium text-[var(--text-primary)] text-sm" id="task-for-reminder">Task Name</p>
                                <p class="text-xs text-[var(--text-secondary)] mt-1">Set a date to receive a calendar reminder</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Date Selection -->
                    <div class="space-y-4">
                        <div>
                            <label for="reminder-date" class="block text-sm font-medium text-[var(--text-primary)] mb-2">Reminder Date</label>
                            <input type="date" 
                                   id="reminder-date" 
                                   name="reminder_date" 
                                   required
                                   min=""
                                   class="w-full px-3 py-2 border border-[var(--border-color)] rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-[var(--primary-action-bg)] focus:border-[var(--primary-action-bg)] text-[var(--text-primary)]">
                        </div>
                        
                        <!-- Optional Note -->
                        <div>
                            <label for="reminder-note" class="block text-sm font-medium text-[var(--text-primary)] mb-2">Additional Note (Optional)</label>
                            <textarea id="reminder-note" 
                                      name="reminder_note" 
                                      rows="3"
                                      placeholder="Add any additional context for this reminder..."
                                      class="w-full px-3 py-2 border border-[var(--border-color)] rounded-lg shadow-sm placeholder-[var(--text-secondary)] focus:outline-none focus:ring-2 focus:ring-[var(--primary-action-bg)] focus:border-[var(--primary-action-bg)] text-[var(--text-primary)] resize-none"></textarea>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Modal Footer -->
            <div class="flex items-center justify-end space-x-3 p-6 border-t border-[var(--border-color)] bg-[var(--grid-header-bg)]/30 rounded-b-xl">
                <button type="button" 
                        id="cancel-calendar-reminder"
                        class="w-32 h-10 flex items-center justify-center border border-[var(--border-color)] text-[var(--text-secondary)] rounded-lg hover:bg-[var(--container-bg)] hover:text-[var(--text-primary)] transition-all duration-200 font-medium cursor-pointer">
                    <i class="fas fa-times mr-2"></i>Cancel
                </button>
                <button type="submit" 
                        class="w-40 h-10 flex items-center justify-center bg-[var(--primary-action-bg)] hover:bg-[var(--primary-action-hover-bg)] text-white rounded-lg transition-all duration-200 font-medium shadow-sm hover:shadow-md cursor-pointer">
                    <i class="fas fa-calendar-plus mr-2"></i>Set Reminder
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Assign Task Popup -->
<div id="assign-task-popup" class="assign-popup">
    <div class="assign-popup-arrow"></div>
    <div class="user-list" id="user-list">
        <!-- User avatars will be dynamically added here -->
    </div>
</div>

<!-- Save Template Modal -->
<div id="save-template-modal" class="fixed inset-0 bg-black/60 backdrop-blur-md z-50 opacity-0 invisible transition-all duration-300 flex items-center justify-center p-4">
    <div class="bg-[var(--container-bg)] rounded-xl max-w-lg w-full mx-4 transform scale-95 transition-all duration-300 shadow-2xl border border-[var(--border-color)]">
        <!-- Modal Header -->
        <div class="flex items-center p-6 border-b border-[var(--border-color)]">
            <div class="flex items-center space-x-3">
                <div class="flex items-center justify-center w-10 h-10 bg-[var(--tertiary-action-bg)] rounded-lg shadow-sm">
                    <i class="fas fa-save text-white"></i>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-[var(--text-primary)]">Save as Template</h3>
                    <p class="text-sm text-[var(--text-secondary)]">Save your current grid structure as a reusable template</p>
                </div>
            </div>
        </div>
        
        <!-- Modal Body -->
        <div class="p-6">
            <form id="save-template-form" method="post" action="{% url 'pages:save_as_template' pk=project.pk %}">
                {% csrf_token %}
                
                <!-- Template Name Field -->
                <div class="mb-6">
                    <label for="template_name" class="block text-sm font-medium text-[var(--text-primary)] mb-2">Template Name</label>
                    <input type="text" 
                           id="template_name" 
                           name="template_name" 
                           required
                           class="w-full px-3 py-2 border border-[var(--border-color)] rounded-md shadow-sm placeholder-[var(--text-secondary)] focus:outline-none focus:ring-2 focus:ring-[var(--tertiary-action-bg)] focus:border-[var(--tertiary-action-bg)] text-[var(--text-primary)]"
                           placeholder="Enter template name">
                </div>
                
                <!-- Template Options -->
                <div class="space-y-4">
                    <!-- Option 1: Save with example tasks -->
                    <button type="button" id="with-tasks-btn" class="w-full text-left p-4 border border-[var(--border-color)] rounded-lg hover:bg-[var(--grid-header-bg)] hover:border-[var(--tertiary-action-bg)] transition-all duration-200 group cursor-pointer">
                        <div class="flex items-start">
                            <div class="flex-shrink-0 w-5 h-5 mt-0.5 mr-3">
                                <div class="w-5 h-5 border-2 border-[var(--border-color)] rounded-full transition-all duration-200 flex items-center justify-center">
                                    <div class="w-3 h-3 bg-[var(--tertiary-action-bg)] rounded-full opacity-0 transition-opacity duration-200"></div>
                                </div>
                            </div>
                            <div class="flex-1">
                                <h4 class="text-sm font-medium text-[var(--text-primary)] group-hover:text-[var(--tertiary-action-bg)] transition-colors duration-200 mb-1">Save with example tasks</h4>
                                <p class="text-sm text-[var(--text-secondary)] group-hover:text-[var(--text-primary)] transition-colors duration-200">Include all current tasks as examples to show how to use the template effectively.</p>
                            </div>
                        </div>
                    </button>
                    
                    <!-- Option 2: Save with clean structure -->
                    <button type="button" id="structure-only-btn" class="w-full text-left p-4 border border-[var(--border-color)] rounded-lg hover:bg-[var(--grid-header-bg)] hover:border-[var(--tertiary-action-bg)] transition-all duration-200 group cursor-pointer">
                        <div class="flex items-center justify-start">
                            <div class="flex-shrink-0 w-5 h-5 mt-0.5 mr-3">
                                <div class="w-5 h-5 border-2 border-[var(--border-color)] rounded-full transition-all duration-200 flex items-center justify-center">
                                    <div class="w-3 h-3 bg-[var(--tertiary-action-bg)] rounded-full opacity-0 transition-opacity duration-200"></div>
                                </div>
                            </div>
                            <div class="flex-1">
                                <h4 class="text-sm font-medium text-[var(--text-primary)] group-hover:text-[var(--tertiary-action-bg)] transition-colors duration-200 mb-1">Save with a clean structure</h4>
                                <p class="text-sm text-[var(--text-secondary)] group-hover:text-[var(--text-primary)] transition-colors duration-200">Save just the rows and columns structure, ready for new tasks.</p>
                            </div>
                        </div>
                    </button>
                </div>
                
                <!-- Hidden input for template style -->
                <input type="hidden" id="template_style" name="template_style" value="structure_only">
            </form>
        </div>
        
        <!-- Modal Footer -->
        <div class="flex items-center justify-end space-x-3 p-6 border-t border-[var(--border-color)]">
            <button onclick="hideSaveTemplateModal()" class="px-4 py-2 flex items-center justify-center border border-[var(--border-color)] text-[var(--text-secondary)] rounded-lg hover:bg-[var(--container-bg)] hover:text-[var(--text-primary)] transition-all duration-200 font-medium cursor-pointer">
                <i class="fas fa-times mr-2"></i>Cancel
            </button>
            <button type="submit" form="save-template-form" class="px-4 py-2 flex items-center justify-center bg-[var(--tertiary-action-bg)] hover:bg-[var(--tertiary-action-hover-bg)] text-[var(--tertiary-action-text)] rounded-lg transition-all duration-200 font-medium shadow-sm hover:shadow-md cursor-pointer">
                <i class="fas fa-save mr-2"></i>Save Template
            </button>
        </div>
    </div>
</div>

<!-- Share Grid Modal -->
<div id="share-grid-modal" class="fixed inset-0 bg-black/60 backdrop-blur-md z-50 opacity-0 invisible transition-all duration-300 flex items-center justify-center p-4">
    <div class="bg-[var(--container-bg)] rounded-xl max-w-2xl w-full mx-4 transform scale-95 transition-all duration-300 shadow-2xl border border-[var(--border-color)]">
        <!-- Modal Header -->
        <div class="flex items-center p-6 border-b border-[var(--border-color)]">
            <div class="flex items-center space-x-3">
                <div class="flex items-center justify-center w-10 h-10 bg-[var(--tertiary-action-bg)] rounded-lg shadow-sm">
                    <i class="fas fa-share text-white"></i>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-[var(--text-primary)]">Share your Grid</h3>
                    <p class="text-sm text-[var(--text-secondary)]">Collaborate with team members</p>
                </div>
            </div>
        </div>
        
        <!-- Modal Body -->
        <div class="p-6">
            <!-- Sharing Options Tabs -->
            <div class="mb-6">
                <div class="flex space-x-1 bg-[var(--grid-header-bg)] p-1 rounded-lg">
                    <button type="button" id="email-tab" class="flex-1 py-2 px-4 text-sm font-medium rounded-md transition-all duration-200 cursor-pointer bg-[var(--tertiary-action-bg)] text-white">
                        <i class="fas fa-envelope mr-2"></i>Email Invitation
                    </button>
                    <button type="button" id="link-tab" class="flex-1 py-2 px-4 text-sm font-medium rounded-md transition-all duration-200 cursor-pointer text-[var(--text-secondary)] hover:text-[var(--text-primary)] hover:bg-[var(--container-bg)]">
                        <i class="fas fa-link mr-2"></i>Shareable Link
                    </button>
                </div>
            </div>
            
            <!-- Email Invitation Form -->
            <div id="email-form" class="sharing-form min-h-[280px]">
                <form id="share-grid-form">
                    {% csrf_token %}
                    
                    <div class="mb-6">
                        <p class="text-[var(--text-primary)] mb-4">Send an email invitation to collaborate on your grid. The recipient needs a Toad Pro account.</p>
                        
                        <!-- Error Message Display -->
                        <div id="email-error-message" class="hidden mb-4 p-3 bg-red-50 border border-red-200 rounded-md">
                            <div class="flex items-start">
                                <div class="flex-shrink-0">
                                    <i class="fas fa-exclamation-triangle text-red-400"></i>
                                </div>
                                <div class="ml-3">
                                    <p id="email-error-text" class="text-sm text-red-700"></p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Email Input -->
                        <div class="mb-4">
                            <label for="share-email" class="block text-sm font-medium text-[var(--text-primary)] mb-2">Email Address</label>
                            <input type="email" 
                                   id="share-email" 
                                   name="email" 
                                   required
                                   class="w-full px-3 py-2 border border-[var(--border-color)] rounded-md shadow-sm placeholder-[var(--text-secondary)] focus:outline-none focus:ring-2 focus:ring-[var(--tertiary-action-bg)] focus:border-[var(--tertiary-action-bg)] text-[var(--text-primary)]"
                                   placeholder="Enter email address">
                        </div>
                        
                        <!-- Optional Message -->
                        <div>
                            <label for="share-message" class="block text-sm font-medium text-[var(--text-primary)] mb-2">Personal Message (Optional)</label>
                            <textarea id="share-message" 
                                      name="message" 
                                      rows="3"
                                      placeholder="Add a personal message to your invitation..."
                                      class="w-full px-3 py-2 border border-[var(--border-color)] rounded-md shadow-sm placeholder-[var(--text-secondary)] focus:outline-none focus:ring-2 focus:ring-[var(--tertiary-action-bg)] focus:border-[var(--tertiary-action-bg)] text-[var(--text-primary)] resize-none"></textarea>
                        </div>
                    </div>
                </form>
            </div>
            
            <!-- Shareable Link Form -->
            <div id="link-form" class="sharing-form hidden min-h-[280px]">
                <div class="mb-6">
                    <p class="text-[var(--text-primary)] mb-4">Generate a shareable link that can be sent to anyone. Recipients need a Toad Pro account to join.</p>
                    
                    <!-- Error Message Display -->
                    <div id="link-error-message" class="hidden mb-4 p-3 bg-red-50 border border-red-200 rounded-md">
                        <div class="flex items-start">
                            <div class="flex-shrink-0">
                                <i class="fas fa-exclamation-triangle text-red-400"></i>
                            </div>
                            <div class="ml-3">
                                <p id="link-error-text" class="text-sm text-red-700"></p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Generated Link Display -->
                    <div id="link-display" class="hidden">
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-[var(--text-primary)] mb-2">Shareable Link</label>
                            <div class="flex items-center space-x-2">
                                <input type="text" 
                                       id="generated-link" 
                                       readonly
                                       class="flex-1 px-3 py-2 border border-[var(--border-color)] rounded-md shadow-sm bg-[var(--grid-header-bg)] text-[var(--text-primary)] text-sm">
                                <button type="button" 
                                        id="copy-link-btn"
                                        class="px-3 py-2 bg-[var(--tertiary-action-bg)] text-white rounded-md hover:bg-[var(--tertiary-action-hover-bg)] transition-colors cursor-pointer">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="bg-[var(--grid-header-bg)] border border-[var(--border-color)] rounded-lg p-4">
                            <div class="flex items-start space-x-3">
                                <div class="flex items-center justify-center w-8 h-8 bg-[var(--tertiary-action-bg)] rounded-lg shadow-sm flex-shrink-0">
                                    <i class="fas fa-info text-white text-sm"></i>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p class="font-medium text-[var(--text-primary)] text-sm">Link Details</p>
                                    <p class="text-xs text-[var(--text-secondary)] mt-1">This link will expire in 30 days and can be used by anyone with a valid Toad Pro account.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Generate Link Button -->
                    <div id="generate-link-section">
                        <button type="button" 
                                id="generate-link-btn"
                                class="w-full py-3 px-4 bg-[var(--tertiary-action-bg)] hover:bg-[var(--tertiary-action-hover-bg)] text-white rounded-lg transition-all duration-200 font-medium shadow-sm hover:shadow-md cursor-pointer">
                            <i class="fas fa-link mr-2"></i>Generate Shareable Link
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Modal Footer -->
        <div class="flex items-center justify-end space-x-3 p-6 border-t border-[var(--border-color)]">
            <button onclick="hideShareGridModal()" class="px-4 py-2 flex items-center justify-center border border-[var(--border-color)] text-[var(--text-secondary)] rounded-lg hover:bg-[var(--container-bg)] hover:text-[var(--text-primary)] transition-all duration-200 font-medium cursor-pointer">
                <i class="fas fa-times mr-2"></i>Cancel
            </button>
            <button type="submit" id="submit-email-btn" form="share-grid-form" class="px-4 py-2 flex items-center justify-center bg-[var(--tertiary-action-bg)] hover:bg-[var(--tertiary-action-hover-bg)] text-[var(--tertiary-action-text)] rounded-lg transition-all duration-200 font-medium shadow-sm hover:shadow-md cursor-pointer">
                <i class="fas fa-share mr-2"></i>Send Invitation
            </button>
        </div>
    </div>
</div>

<!-- Clear Completed Modal -->
<div id="clear-completed-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 opacity-0 invisible transition-all duration-300">
    <div class="bg-[var(--container-bg)] rounded-xl shadow-2xl border border-[var(--border-color)] max-w-md w-full mx-4 transform scale-95 transition-all duration-300" id="clear-completed-modal-content">
        <!-- Modal Header -->
        <div class="flex items-center justify-between p-6 border-b border-[var(--border-color)]">
            <div class="flex items-center space-x-3">
                <div class="flex items-center justify-center w-10 h-10 bg-[var(--clear-button-bg)] rounded-lg shadow-sm">
                    <i class="fas fa-check text-white"></i>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-[var(--text-primary)]">Clear Completed Tasks</h3>
                    <p class="text-sm text-[var(--text-secondary)]">This action cannot be undone</p>
                </div>
            </div>
            <button type="button" id="close-clear-completed-modal" class="text-[var(--text-secondary)] hover:text-[var(--text-primary)] transition-colors">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <!-- Modal Body -->
        <div class="p-6">
            <div class="mb-6">
                <p class="text-[var(--text-primary)] mb-4">Are you sure you want to clear all completed tasks from this grid?</p>
                <div class="bg-[var(--grid-header-bg)] border border-[var(--border-color)] rounded-lg p-4">
                    <div class="flex items-start space-x-3">
                        <div class="flex items-center justify-center w-8 h-8 bg-[var(--clear-button-bg)] rounded-lg shadow-sm flex-shrink-0">
                            <i class="fas fa-tasks text-white text-sm"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="font-medium text-[var(--text-primary)] text-sm">All completed tasks will be permanently removed</p>
                            <p class="text-xs text-[var(--text-secondary)] mt-1">This will help keep your grid clean and focused on active tasks</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Modal Footer -->
        <div class="flex items-center justify-end space-x-3 p-6 border-t border-[var(--border-color)] bg-[var(--grid-header-bg)]/30 rounded-b-xl">
            <button type="button" 
                    id="cancel-clear-completed"
                    class="w-32 h-10 flex items-center justify-center border border-[var(--border-color)] text-[var(--text-secondary)] rounded-lg hover:bg-[var(--container-bg)] hover:text-[var(--text-primary)] transition-all duration-200 font-medium cursor-pointer">
                <i class="fas fa-times mr-2"></i>Cancel
            </button>
            <form id="clear-completed-form" method="post" action="{% url 'pages:delete_completed_tasks' pk=project.pk %}" class="inline">
                {% csrf_token %}
                <button type="submit" 
                        class="w-40 h-10 flex items-center justify-center bg-[var(--clear-button-bg)] hover:bg-[var(--clear-button-bg)]/90 text-white rounded-lg transition-all duration-200 font-medium shadow-sm hover:shadow-md cursor-pointer">
                    <i class="fas fa-check mr-2"></i>Clear All
                </button>
            </form>
        </div>
    </div>
</div>

<!-- Team Members Data (JSON) - only for team_toad projects -->
{% if project.is_team_toad %}
<script id="team-members-data" type="application/json">
[
    {% for team_member in project.team_toad_user.all %}
    {
        "id": "{{ team_member.pk }}",
        "name": "{{ team_member.get_full_name }}",
        "initials": "{{ team_member.get_full_name|get_initials }}"
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
]
</script>
{% endif %}

<script>
// Grid Name Actions Dropdown functionality
document.addEventListener('DOMContentLoaded', function() {
    const gridNameActionsBtn = document.getElementById('grid-name-actions-btn');
    const gridNameActionsDropdown = document.getElementById('grid-name-actions-dropdown');
    
    if (gridNameActionsBtn && gridNameActionsDropdown) {
        // Toggle dropdown
        gridNameActionsBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            const isVisible = !gridNameActionsDropdown.classList.contains('invisible');
            
            if (isVisible) {
                // Close dropdown
                gridNameActionsDropdown.classList.add('opacity-0', 'invisible', 'scale-95');
                gridNameActionsDropdown.classList.remove('scale-100');
            } else {
                // Open dropdown
                gridNameActionsDropdown.classList.remove('opacity-0', 'invisible', 'scale-95');
                gridNameActionsDropdown.classList.add('scale-100');
            }
        });
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!gridNameActionsBtn.contains(e.target) && !gridNameActionsDropdown.contains(e.target)) {
                gridNameActionsDropdown.classList.add('opacity-0', 'invisible', 'scale-95');
                gridNameActionsDropdown.classList.remove('scale-100');
            }
        });
        
        // Close dropdown when pressing Escape
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                gridNameActionsDropdown.classList.add('opacity-0', 'invisible', 'scale-95');
                gridNameActionsDropdown.classList.remove('scale-100');
            }
        });
    }
    
    // Initialize grid tabs with smooth scrolling
    const gridTabs = document.getElementById('grid-tabs');
    if (gridTabs) {
        // Add smooth scrolling to the tabs container
        gridTabs.querySelector('.overflow-x-auto').style.scrollBehavior = 'smooth';
    }
});



// Modal functions
function closeModal() {
    const modal = document.getElementById('modal');
    if (modal) {
        modal.classList.add('opacity-0', 'invisible');
        const modalContent = modal.querySelector('#modal-content');
        if (modalContent) {
            modalContent.classList.add('scale-95');
            modalContent.classList.remove('scale-100');
        }
    }
}

// Extend the existing closeAllDropdowns function to include the new dropdown
const originalCloseAllDropdowns = window.closeAllDropdowns;
window.closeAllDropdowns = function() {
    if (originalCloseAllDropdowns) {
        originalCloseAllDropdowns();
    }
    
    // Close the grid name actions dropdown
    const gridNameActionsDropdown = document.getElementById('grid-name-actions-dropdown');
    if (gridNameActionsDropdown) {
        gridNameActionsDropdown.classList.add('opacity-0', 'invisible', 'scale-95');
        gridNameActionsDropdown.classList.remove('scale-100');
    }
};

// Save Template Modal functionality
document.addEventListener('DOMContentLoaded', function() {
    const withTasksBtn = document.getElementById('with-tasks-btn');
    const structureOnlyBtn = document.getElementById('structure-only-btn');
    const templateStyleInput = document.getElementById('template_style');
    
    if (withTasksBtn && structureOnlyBtn && templateStyleInput) {
        // Set initial state to "Save with clean structure"
        structureOnlyBtn.querySelector('.w-3.h-3').classList.remove('opacity-0');
        
        // Handle "Save with example tasks" selection
        withTasksBtn.addEventListener('click', function() {
            // Update visual state - just show the inner circle
            withTasksBtn.querySelector('.w-3.h-3').classList.remove('opacity-0');
            
            // Reset other button
            structureOnlyBtn.querySelector('.w-3.h-3').classList.add('opacity-0');
            
            // Set form value
            templateStyleInput.value = 'with_tasks';
        });
        
        // Handle "Save with clean structure" selection
        structureOnlyBtn.addEventListener('click', function() {
            // Update visual state - just show the inner circle
            structureOnlyBtn.querySelector('.w-3.h-3').classList.remove('opacity-0');
            
            // Reset other button
            withTasksBtn.querySelector('.w-3.h-3').classList.add('opacity-0');
            
            // Set form value
            templateStyleInput.value = 'structure_only';
        });
    }
});

function hideSaveTemplateModal() {
    const modal = document.getElementById('save-template-modal');
    if (modal) {
        modal.classList.add('opacity-0', 'invisible');
        const modalContent = modal.querySelector('div');
        if (modalContent) {
            modalContent.classList.add('scale-95');
            modalContent.classList.remove('scale-100');
        }
    }
}

function hideShareGridModal() {
    const modal = document.getElementById('share-grid-modal');
    if (modal) {
        modal.classList.add('opacity-0', 'invisible');
        const modalContent = modal.querySelector('div');
        if (modalContent) {
            modalContent.classList.add('scale-95');
            modalContent.classList.remove('scale-100');
        }
        
        // Reset forms and states
        const emailForm = document.getElementById('share-grid-form');
        if (emailForm) emailForm.reset();
        
        // Reset to email tab
        switchToEmailTab();
        
        // Hide link display
        const linkDisplay = document.getElementById('link-display');
        const generateSection = document.getElementById('generate-link-section');
        if (linkDisplay) linkDisplay.classList.add('hidden');
        if (generateSection) generateSection.classList.remove('hidden');
        
        // Clear all error messages
        clearAllErrors();
    }
}

// Function to clear all error messages
function clearAllErrors() {
    const emailError = document.getElementById('email-error-message');
    const linkError = document.getElementById('link-error-message');
    
    if (emailError) emailError.classList.add('hidden');
    if (linkError) linkError.classList.add('hidden');
}

// Function to show error message in modal
function showError(message, type = 'email') {
    clearAllErrors();
    
    const errorElement = document.getElementById(`${type}-error-message`);
    const errorText = document.getElementById(`${type}-error-text`);
    
    if (errorElement && errorText) {
        errorText.textContent = message;
        errorElement.classList.remove('hidden');
    }
}

// Tab switching functionality
function switchToEmailTab() {
    const emailTab = document.getElementById('email-tab');
    const linkTab = document.getElementById('link-tab');
    const emailForm = document.getElementById('email-form');
    const linkForm = document.getElementById('link-form');
    const submitBtn = document.getElementById('submit-email-btn');
    
    if (emailTab && linkTab && emailForm && linkForm) {
        // Clear any existing errors
        clearAllErrors();
        
        // Update tab styles
        emailTab.classList.add('bg-[var(--tertiary-action-bg)]', 'text-white');
        emailTab.classList.remove('text-[var(--text-secondary)]', 'hover:text-[var(--text-primary)]', 'hover:bg-[var(--container-bg)]');
        
        linkTab.classList.remove('bg-[var(--tertiary-action-bg)]', 'text-white');
        linkTab.classList.add('text-[var(--text-secondary)]', 'hover:text-[var(--text-primary)]', 'hover:bg-[var(--container-bg)]');
        
        // Show/hide forms
        emailForm.classList.remove('hidden');
        linkForm.classList.add('hidden');
        
        // Show submit button
        if (submitBtn) submitBtn.classList.remove('hidden');
    }
}

function switchToLinkTab() {
    const emailTab = document.getElementById('email-tab');
    const linkTab = document.getElementById('link-tab');
    const emailForm = document.getElementById('email-form');
    const linkForm = document.getElementById('link-form');
    const submitBtn = document.getElementById('submit-email-btn');
    
    if (emailTab && linkTab && emailForm && linkForm) {
        // Clear any existing errors
        clearAllErrors();
        
        // Update tab styles
        linkTab.classList.add('bg-[var(--tertiary-action-bg)]', 'text-white');
        linkTab.classList.remove('text-[var(--text-secondary)]', 'hover:text-[var(--text-primary)]', 'hover:bg-[var(--container-bg)]');
        
        emailTab.classList.remove('bg-[var(--tertiary-action-bg)]', 'text-white');
        emailTab.classList.add('text-[var(--text-secondary)]', 'hover:text-[var(--text-primary)]', 'hover:bg-[var(--container-bg)]');
        
        // Show/hide forms
        linkForm.classList.remove('hidden');
        emailForm.classList.add('hidden');
        
        // Hide submit button
        if (submitBtn) submitBtn.classList.add('hidden');
    }
}

// Clear Completed Modal functionality
function showClearCompletedModal() {
    const modal = document.getElementById('clear-completed-modal');
    if (modal) {
        modal.classList.remove('opacity-0', 'invisible');
        const modalContent = modal.querySelector('div');
        if (modalContent) {
            modalContent.classList.remove('scale-95');
            modalContent.classList.add('scale-100');
        }
    }
}

function hideClearCompletedModal() {
    const modal = document.getElementById('clear-completed-modal');
    if (modal) {
        modal.classList.add('opacity-0', 'invisible');
        const modalContent = modal.querySelector('div');
        if (modalContent) {
            modalContent.classList.add('scale-95');
            modalContent.classList.remove('scale-100');
        }
    }
}

// Calendar Reminder Modal functionality
function showCalendarReminderModal(taskId, taskText, existingReminderDate = null) {
    const modal = document.getElementById('calendar-reminder-modal');
    const taskDisplay = document.getElementById('task-for-reminder');
    const form = document.getElementById('calendar-reminder-form');
    const dateInput = document.getElementById('reminder-date');
    
    if (modal && taskDisplay && form && dateInput) {
        // Set task text in modal
        taskDisplay.textContent = taskText;
        
        // Set form action URL
        form.action = `/tasks/${taskId}/reminder/`;
        
        // Set minimum date to today
        const today = new Date().toISOString().split('T')[0];
        dateInput.min = today;
        
        // Set date value - use existing reminder date if available, otherwise today
        if (existingReminderDate) {
            dateInput.value = existingReminderDate;
        } else {
            dateInput.value = today;
        }
        
        // Show modal
        modal.classList.remove('opacity-0', 'invisible');
        const modalContent = modal.querySelector('div');
        if (modalContent) {
            modalContent.classList.remove('scale-95');
            modalContent.classList.add('scale-100');
        }
    }
}

function hideCalendarReminderModal() {
    const modal = document.getElementById('calendar-reminder-modal');
    if (modal) {
        modal.classList.add('opacity-0', 'invisible');
        const modalContent = modal.querySelector('div');
        if (modalContent) {
            modalContent.classList.add('scale-95');
            modalContent.classList.remove('scale-100');
        }
        
        // Reset form
        const form = document.getElementById('calendar-reminder-form');
        const noteTextarea = document.getElementById('reminder-note');
        if (form) form.reset();
        if (noteTextarea) noteTextarea.value = '';
    }
}

// Function to update task reminder display without page refresh
function updateTaskReminderDisplay(taskId, reminderDate) {
    const taskElement = document.getElementById(`task-${taskId}`);
    if (!taskElement) return;
    
    // Format the date to match the new format (02 Sep 2025)
    const date = new Date(reminderDate);
    const formattedDate = date.toLocaleDateString('en-GB', {
        day: '2-digit',
        month: 'short',
        year: 'numeric'
    });
    
    // Find the task text container
    const taskTextContainer = taskElement.querySelector('.flex-1.min-w-0');
    if (!taskTextContainer) return;
    
    // Check if reminder display already exists
    let reminderDisplay = taskTextContainer.querySelector('.reminder-display');
    
    if (!reminderDisplay) {
        // Create new reminder display
        reminderDisplay = document.createElement('div');
        reminderDisplay.className = 'reminder-display flex items-center space-x-1 mt-1 text-xs text-green-600 ml-1';
        reminderDisplay.innerHTML = `
            <i class="fas fa-calendar-check text-green-500"></i>
            <span>${formattedDate}</span>
        `;
        // Insert after the task text div, not at the end of the container
        const taskTextDiv = taskTextContainer.querySelector('[id^="task-text-"]');
        if (taskTextDiv) {
            taskTextDiv.parentNode.insertBefore(reminderDisplay, taskTextDiv.nextSibling);
        } else {
            taskTextContainer.appendChild(reminderDisplay);
        }
    } else {
        // Update existing reminder display
        const dateSpan = reminderDisplay.querySelector('span');
        if (dateSpan) {
            dateSpan.textContent = formattedDate;
        }
    }
    
    // Update calendar button icons
    const calendarButtons = taskElement.querySelectorAll('.calendar-reminder-btn');
    calendarButtons.forEach(btn => {
        const icon = btn.querySelector('i');
        if (icon) {
            icon.className = 'fas fa-calendar-check text-green-500 text-xs transition-colors';
            btn.title = 'Edit reminder';
            btn.setAttribute('data-reminder-date', reminderDate);
        }
    });
}

// Function to remove task reminder display (for future use)
function removeTaskReminderDisplay(taskId) {
    const taskElement = document.getElementById(`task-${taskId}`);
    if (!taskElement) return;
    
    // Remove reminder display
    const reminderDisplay = taskElement.querySelector('.reminder-display');
    if (reminderDisplay) {
        reminderDisplay.remove();
    }
    
    // Update calendar button icons back to default
    const calendarButtons = taskElement.querySelectorAll('.calendar-reminder-btn');
    calendarButtons.forEach(btn => {
        const icon = btn.querySelector('i');
        if (icon) {
            icon.className = 'fas fa-calendar-plus text-gray-400 hover:text-[var(--primary-action-bg)] text-xs transition-colors';
            btn.title = 'Set reminder';
            btn.removeAttribute('data-reminder-date');
        }
    });
}


// Team member filtering functionality
let currentFilterUserId = null;

function filterTasksByUser(userId) {
    const allTasks = document.querySelectorAll('.task-item');
    const teamMemberAvatars = document.querySelectorAll('.team-member-avatar');
    
    // Remove active state from all avatars
    teamMemberAvatars.forEach(avatar => {
        avatar.classList.remove('ring-2', 'ring-white', 'ring-offset-2');
    });
    
    if (currentFilterUserId === userId) {
        // If clicking the same user, reset filter
        currentFilterUserId = null;
        allTasks.forEach(task => {
            task.style.opacity = '1';
        });
    } else {
        // Filter to show only tasks assigned to this user
        currentFilterUserId = userId;
        
        // Add active state to clicked avatar
        const clickedAvatar = document.querySelector(`[data-user-id="${userId}"]`);
        if (clickedAvatar) {
            clickedAvatar.classList.add('ring-2', 'ring-white', 'ring-offset-2');
        }
        
        allTasks.forEach(task => {
            const assignedUserId = task.dataset.assignedUserId;
            if (assignedUserId && assignedUserId === userId.toString()) {
                // Task is assigned to this user - keep full opacity
                task.style.opacity = '1';
            } else {
                // Task is not assigned to this user - reduce opacity
                task.style.opacity = '0.25';
            }
        });
    }
}

// Calendar reminder event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Close calendar modal buttons
    const closeCalendarModal = document.getElementById('close-calendar-modal');
    const cancelCalendarReminder = document.getElementById('cancel-calendar-reminder');
    const calendarModal = document.getElementById('calendar-reminder-modal');
    
    if (closeCalendarModal) {
        closeCalendarModal.addEventListener('click', hideCalendarReminderModal);
    }
    
    if (cancelCalendarReminder) {
        cancelCalendarReminder.addEventListener('click', hideCalendarReminderModal);
    }
    
    // Close modal when clicking outside
    if (calendarModal) {
        calendarModal.addEventListener('click', function(e) {
            if (e.target === calendarModal) {
                hideCalendarReminderModal();
            }
        });
    }
    
    // Clear Completed modal event listeners
    const closeClearCompletedModal = document.getElementById('close-clear-completed-modal');
    const cancelClearCompleted = document.getElementById('cancel-clear-completed');
    const clearCompletedModal = document.getElementById('clear-completed-modal');
    
    if (closeClearCompletedModal) {
        closeClearCompletedModal.addEventListener('click', hideClearCompletedModal);
    }
    
    if (cancelClearCompleted) {
        cancelClearCompleted.addEventListener('click', hideClearCompletedModal);
    }
    
    // Close modal when clicking outside
    if (clearCompletedModal) {
        clearCompletedModal.addEventListener('click', function(e) {
            if (e.target === clearCompletedModal) {
                hideClearCompletedModal();
            }
        });
    }
    
    // Share Grid modal event listeners
    const shareGridModal = document.getElementById('share-grid-modal');
    if (shareGridModal) {
        shareGridModal.addEventListener('click', function(e) {
            if (e.target === shareGridModal) {
                hideShareGridModal();
            }
        });
    }
    
    // Tab switching event listeners
    const emailTab = document.getElementById('email-tab');
    const linkTab = document.getElementById('link-tab');
    
    if (emailTab) {
        emailTab.addEventListener('click', switchToEmailTab);
    }
    
    if (linkTab) {
        linkTab.addEventListener('click', switchToLinkTab);
    }
    
    // Handle Share Grid form submission (Email invitation)
    const shareGridForm = document.getElementById('share-grid-form');
    if (shareGridForm) {
        shareGridForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const email = document.getElementById('share-email').value.trim();
            const message = document.getElementById('share-message').value.trim();
            const submitBtn = document.getElementById('submit-email-btn');
            const originalText = submitBtn.innerHTML;
            
            if (!email) {
                showError('Please enter an email address', 'email');
                return;
            }
            
            // Show loading state
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Sending...';
            submitBtn.disabled = true;
            
            // Send request to backend
            fetch(`/grids/{{ project.pk }}/share/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    type: 'email',
                    email: email,
                    message: message
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show success message
                    submitBtn.innerHTML = '<i class="fas fa-check mr-2"></i>Sent!';
                    submitBtn.classList.remove('bg-[var(--tertiary-action-bg)]', 'hover:bg-[var(--tertiary-action-hover-bg)]');
                    submitBtn.classList.add('bg-green-500');
                    
                    // Close modal after short delay
                    setTimeout(() => {
                        hideShareGridModal();
                        
                        // Reset button
                        submitBtn.innerHTML = originalText;
                        submitBtn.disabled = false;
                        submitBtn.classList.remove('bg-green-500');
                        submitBtn.classList.add('bg-[var(--tertiary-action-bg)]', 'hover:bg-[var(--tertiary-action-hover-bg)]');
                        
                        // Show notification if available
                        if (window.showNotification) {
                            window.showNotification(data.message || 'Grid invitation sent successfully!', 'success');
                        }
                    }, 1500);
                } else {
                    // Show error message
                    submitBtn.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i>Error';
                    submitBtn.classList.remove('bg-[var(--tertiary-action-bg)]');
                    submitBtn.classList.add('bg-red-500');
                    
                    setTimeout(() => {
                        submitBtn.innerHTML = originalText;
                        submitBtn.disabled = false;
                        submitBtn.classList.remove('bg-red-500');
                        submitBtn.classList.add('bg-[var(--tertiary-action-bg)]');
                        
                        // Show error in modal
                        showError(data.error || 'Failed to send invitation', 'email');
                    }, 2000);
                }
            })
            .catch(error => {
                console.error('Error sending invitation:', error);
                submitBtn.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i>Error';
                submitBtn.classList.remove('bg-[var(--tertiary-action-bg)]');
                submitBtn.classList.add('bg-red-500');
                
                setTimeout(() => {
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                    submitBtn.classList.remove('bg-red-500');
                    submitBtn.classList.add('bg-[var(--tertiary-action-bg)]');
                    
                    showError('An error occurred while sending the invitation', 'email');
                }, 2000);
            });
        });
    }
    
    // Handle shareable link generation
    const generateLinkBtn = document.getElementById('generate-link-btn');
    if (generateLinkBtn) {
        generateLinkBtn.addEventListener('click', function() {
            const originalText = generateLinkBtn.innerHTML;
            
            // Show loading state
            generateLinkBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Generating...';
            generateLinkBtn.disabled = true;
            
            // Send request to backend
            fetch(`/grids/{{ project.pk }}/share/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    type: 'link'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show the generated link
                    const linkDisplay = document.getElementById('link-display');
                    const generateSection = document.getElementById('generate-link-section');
                    const generatedLink = document.getElementById('generated-link');
                    
                    if (linkDisplay && generateSection && generatedLink) {
                        generatedLink.value = data.shareable_url;
                        generateSection.classList.add('hidden');
                        linkDisplay.classList.remove('hidden');
                    }
                    
                    // Reset button
                    generateLinkBtn.innerHTML = originalText;
                    generateLinkBtn.disabled = false;
                    
                    // Show notification if available
                    if (window.showNotification) {
                        window.showNotification(data.message || 'Shareable link generated successfully!', 'success');
                    }
                } else {
                    // Show error
                    generateLinkBtn.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i>Error';
                    generateLinkBtn.classList.remove('bg-[var(--tertiary-action-bg)]');
                    generateLinkBtn.classList.add('bg-red-500');
                    
                    setTimeout(() => {
                        generateLinkBtn.innerHTML = originalText;
                        generateLinkBtn.disabled = false;
                        generateLinkBtn.classList.remove('bg-red-500');
                        generateLinkBtn.classList.add('bg-[var(--tertiary-action-bg)]');
                        
                        showError(data.error || 'Failed to generate link', 'link');
                    }, 2000);
                }
            })
            .catch(error => {
                console.error('Error generating link:', error);
                generateLinkBtn.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i>Error';
                generateLinkBtn.classList.remove('bg-[var(--tertiary-action-bg)]');
                generateLinkBtn.classList.add('bg-red-500');
                
                setTimeout(() => {
                    generateLinkBtn.innerHTML = originalText;
                    generateLinkBtn.disabled = false;
                    generateLinkBtn.classList.remove('bg-red-500');
                    generateLinkBtn.classList.add('bg-[var(--tertiary-action-bg)]');
                    
                    showError('An error occurred while generating the link', 'link');
                }, 2000);
            });
        });
    }
    
    // Handle copy link functionality
    const copyLinkBtn = document.getElementById('copy-link-btn');
    if (copyLinkBtn) {
        copyLinkBtn.addEventListener('click', function() {
            const linkInput = document.getElementById('generated-link');
            if (linkInput) {
                linkInput.select();
                linkInput.setSelectionRange(0, 99999); // For mobile devices
                
                try {
                    document.execCommand('copy');
                    
                    // Show success feedback
                    const originalIcon = copyLinkBtn.innerHTML;
                    copyLinkBtn.innerHTML = '<i class="fas fa-check"></i>';
                    copyLinkBtn.classList.remove('bg-[var(--tertiary-action-bg)]');
                    copyLinkBtn.classList.add('bg-green-500');
                    
                    setTimeout(() => {
                        copyLinkBtn.innerHTML = originalIcon;
                        copyLinkBtn.classList.remove('bg-green-500');
                        copyLinkBtn.classList.add('bg-[var(--tertiary-action-bg)]');
                    }, 1500);
                    
                    if (window.showNotification) {
                        window.showNotification('Link copied to clipboard!', 'success');
                    }
                } catch (err) {
                    console.error('Failed to copy link:', err);
                    if (window.showNotification) {
                        window.showNotification('Failed to copy link', 'error');
                    }
                }
            }
        });
    }
    
    // Handle Clear Completed form submission
    const clearCompletedForm = document.getElementById('clear-completed-form');
    if (clearCompletedForm) {
        clearCompletedForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const submitBtn = clearCompletedForm.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            
            // Show loading state
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Clearing...';
            submitBtn.disabled = true;
            
            // Submit form via fetch
            const formData = new FormData(clearCompletedForm);
            
            fetch(clearCompletedForm.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Show success message
                    submitBtn.innerHTML = '<i class="fas fa-check mr-2"></i>Cleared!';
                    submitBtn.classList.remove('bg-[var(--clear-button-bg)]', 'hover:bg-[var(--clear-button-bg)]/90');
                    submitBtn.classList.add('bg-green-500');
                    
                    // Close modal after short delay
                    setTimeout(() => {
                        hideClearCompletedModal();
                        
                        // Reset button
                        submitBtn.innerHTML = originalText;
                        submitBtn.disabled = false;
                        submitBtn.classList.remove('bg-green-500');
                        submitBtn.classList.add('bg-[var(--clear-button-bg)]', 'hover:bg-[var(--clear-button-bg)]/90');
                        
                        // Reload the page to show updated grid
                        window.location.reload();
                    }, 1500);
                } else {
                    // Show error
                    submitBtn.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i>Error';
                    submitBtn.classList.remove('bg-[var(--clear-button-bg)]');
                    submitBtn.classList.add('bg-red-500');
                    
                    setTimeout(() => {
                        submitBtn.innerHTML = originalText;
                        submitBtn.disabled = false;
                        submitBtn.classList.remove('bg-red-500');
                        submitBtn.classList.add('bg-[var(--clear-button-bg)]');
                    }, 2000);
                }
            })
            .catch(error => {
                console.error('Error clearing completed tasks:', error);
                submitBtn.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i>Error';
                submitBtn.classList.remove('bg-[var(--clear-button-bg)]');
                submitBtn.classList.add('bg-red-500');
                
                setTimeout(() => {
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                    submitBtn.classList.remove('bg-red-500');
                    submitBtn.classList.add('bg-[var(--clear-button-bg)]');
                }, 2000);
            });
        });
    }
    
    
    // Handle team member avatar clicks for filtering
    document.addEventListener('click', function(e) {
        const teamMemberAvatar = e.target.closest('.team-member-avatar');
        if (teamMemberAvatar) {
            e.preventDefault();
            e.stopPropagation();
            const userId = teamMemberAvatar.dataset.userId;
            filterTasksByUser(userId);
        }
    });
    
    // Handle calendar reminder button clicks
    document.addEventListener('click', function(e) {
        const calendarBtn = e.target.closest('.calendar-reminder-btn');
        if (calendarBtn) {
            e.preventDefault();
            e.stopPropagation();
            const taskId = calendarBtn.dataset.taskId;
            const taskText = calendarBtn.dataset.taskText;
            const existingReminderDate = calendarBtn.dataset.reminderDate;
            showCalendarReminderModal(taskId, taskText, existingReminderDate);
        }
    });
    
    // Handle calendar reminder form submission
    const calendarForm = document.getElementById('calendar-reminder-form');
    if (calendarForm) {
        calendarForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(calendarForm);
            const taskId = calendarForm.action.split('/tasks/')[1].split('/reminder/')[0];
            const reminderDate = formData.get('reminder_date');
            
            // Form data ready for submission
            
            // Show loading state
            const submitBtn = calendarForm.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Creating...';
            submitBtn.disabled = true;
            
            // Submit form via fetch
            fetch(calendarForm.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Show success message
                    submitBtn.innerHTML = '<i class="fas fa-check mr-2"></i>Created!';
                    submitBtn.classList.remove('bg-[var(--primary-action-bg)]', 'hover:bg-[var(--primary-action-hover-bg)]');
                    submitBtn.classList.add('bg-green-500');
                    
                    // Update the task display immediately
                    updateTaskReminderDisplay(taskId, reminderDate);
                    
                    // Close modal after short delay
                    setTimeout(() => {
                        hideCalendarReminderModal();
                        
                        // Reset button
                        submitBtn.innerHTML = originalText;
                        submitBtn.disabled = false;
                        submitBtn.classList.remove('bg-green-500');
                        submitBtn.classList.add('bg-[var(--primary-action-bg)]', 'hover:bg-[var(--primary-action-hover-bg)]');
                        
                        // Show notification if available
                        if (window.showNotification) {
                            window.showNotification('Calendar reminder created successfully!', 'success');
                        }
                    }, 1500);
                } else {
                    // Show error
                    submitBtn.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i>Error';
                    submitBtn.classList.remove('bg-[var(--primary-action-bg)]');
                    submitBtn.classList.add('bg-red-500');
                    
                    setTimeout(() => {
                        submitBtn.innerHTML = originalText;
                        submitBtn.disabled = false;
                        submitBtn.classList.remove('bg-red-500');
                        submitBtn.classList.add('bg-[var(--primary-action-bg)]');
                    }, 2000);
                }
            })
            .catch(error => {
                console.error('Error creating reminder:', error);
                submitBtn.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i>Error';
                submitBtn.classList.remove('bg-[var(--primary-action-bg)]');
                submitBtn.classList.add('bg-red-500');
                
                setTimeout(() => {
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                    submitBtn.classList.remove('bg-red-500');
                    submitBtn.classList.add('bg-[var(--primary-action-bg)]');
                }, 2000);
            });
        });
    }
});


</script>

{% endblock %} 