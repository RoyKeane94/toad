class GridManager{constructor(){this.state={currentCol:0,dataColWidth:0,totalDataColumns:0,columnsToShow:3,isDropdownOpen:!1,currentTaskId:null,currentDeleteUrl:null},this.elements={},this.observers=new Map,this.eventListeners=new Map,this.init()}cacheElements(){const t={switcherBtn:"#project-switcher-btn",switcherDropdown:"#project-switcher-dropdown",switcherChevron:"#switcher-chevron",switcherContainer:"#project-switcher-container",scrollable:".grid-table-scrollable",leftBtn:".left-scroll-btn",rightBtn:".right-scroll-btn",gridTable:".grid-table",dataCols:"col.data-column",deleteModal:"#delete-task-modal",deleteModalContent:"#delete-modal-content",taskToDelete:"#task-to-delete",deleteTaskForm:"#delete-task-form",closeDeleteModal:"#close-delete-modal",cancelDeleteTask:"#cancel-delete-task",modal:"#modal",modalContent:"#modal-content",fixedRows:".grid-table-fixed tr",scrollRows:".grid-table-scrollable .grid-table tr"};Object.keys(t).forEach(e=>{const s=t[e];s.includes("All")||e.includes("Rows")||"dataCols"===e?this.elements[e]=document.querySelectorAll(s):this.elements[e]=document.querySelector(s)})}addEventListeners(){[["document","click",this.handleDocumentClick.bind(this)],["document","keydown",this.handleKeydown.bind(this)],["document","htmx:afterRequest",this.handleHtmxAfterRequest.bind(this)],["document","htmx:afterSwap",this.handleHtmxAfterSwap.bind(this)],["document","htmx:afterSettle",this.handleHtmxAfterSettle.bind(this)],["body","openModal",this.showModal.bind(this)],["body","closeModal",this.hideModal.bind(this)],["body","refreshGrid",()=>window.location.reload()],["body","scrollToEnd",this.handleScrollToEnd.bind(this)]].forEach(([t,e,s])=>{const o="document"===t?document:document.body;o.addEventListener(e,s),this.eventListeners.has(o)||this.eventListeners.set(o,[]),this.eventListeners.get(o).push({event:e,handler:s})})}handleDocumentClick(t){if(t.target.closest("#project-switcher-btn"))return t.stopPropagation(),void this.toggleProjectSwitcher();t.target.closest("#project-switcher-container")||this.closeProjectSwitcher();const e=t.target.closest(".column-actions-btn, .row-actions-btn");if(e)return t.stopPropagation(),void this.toggleActionDropdown(e);t.target.closest(".column-actions-dropdown, .row-actions-dropdown")||this.closeAllActionDropdowns();const s=t.target.closest(".delete-task-btn");if(s)return t.preventDefault(),void this.showDeleteModal(s.dataset.taskId,s.dataset.taskText,s.dataset.deleteUrl);const o=t.target.closest(".close-modal, #close-delete-modal, #cancel-delete-task");if(o)return void("close-delete-modal"===o.id||"cancel-delete-task"===o.id?this.hideDeleteModal():o.classList.contains("close-modal")&&this.hideModal());t.target===this.elements.deleteModal&&this.hideDeleteModal(),t.target===this.elements.modal&&this.hideModal();const l=t.target.closest('button[hx-get*="task_edit"]');l&&this.storeTaskEditColumn(l);const a=t.target.closest(".add-task-trigger");if(a)return t.preventDefault(),void this.expandAddTaskForm(a.closest(".add-task-form"));const i=t.target.closest(".add-task-cancel");if(i)return t.preventDefault(),void this.collapseAddTaskForm(i.closest(".add-task-form"));t.target.closest(".add-task-form")||this.collapseAllAddTaskForms()}handleKeydown(t){"Escape"===t.key&&(this.closeProjectSwitcher(),this.closeAllActionDropdowns(),this.hideDeleteModal(),this.hideModal(),this.collapseAllAddTaskForms())}toggleProjectSwitcher(){this.elements.switcherDropdown&&(this.state.isDropdownOpen=!this.state.isDropdownOpen,this.updateProjectSwitcherUI())}closeProjectSwitcher(){this.state.isDropdownOpen&&(this.state.isDropdownOpen=!1,this.updateProjectSwitcherUI())}updateProjectSwitcherUI(){const{switcherDropdown:t,switcherChevron:e,switcherBtn:s}=this.elements;if(!t)return;const o=this.state.isDropdownOpen?{remove:["opacity-0","invisible","scale-95"],add:["opacity-100","visible","scale-100"]}:{remove:["opacity-100","visible","scale-100"],add:["opacity-0","invisible","scale-95"]};t.classList.remove(...o.remove),t.classList.add(...o.add),e&&(e.style.transform=this.state.isDropdownOpen?"rotate(180deg)":"rotate(0deg)"),s&&(s.classList.toggle("ring-2",this.state.isDropdownOpen),s.classList.toggle("ring-[var(--primary-action-bg)]/20",this.state.isDropdownOpen))}toggleActionDropdown(t){const e=t.nextElementSibling;if(!e)return;this.closeAllActionDropdowns(e);const s=!e.classList.contains("opacity-0");this.setDropdownState(e,!s)}closeAllActionDropdowns(t=null){document.querySelectorAll(".column-actions-dropdown, .row-actions-dropdown").forEach(e=>{e!==t&&this.setDropdownState(e,!1)})}setDropdownState(t,e){const s=e?{remove:["opacity-0","invisible","scale-95"],add:["opacity-100","visible","scale-100"]}:{remove:["opacity-100","visible","scale-100"],add:["opacity-0","invisible","scale-95"]};t.classList.remove(...s.remove),t.classList.add(...s.add)}showDeleteModal(t,e,s){this.state.currentTaskId=t,this.state.currentDeleteUrl=s,this.elements.taskToDelete&&(this.elements.taskToDelete.textContent=e),this.elements.deleteTaskForm&&(this.elements.deleteTaskForm.action=s),this.setModalState(this.elements.deleteModal,this.elements.deleteModalContent,!0),setTimeout(()=>this.elements.cancelDeleteTask?.focus(),100)}hideDeleteModal(){this.setModalState(this.elements.deleteModal,this.elements.deleteModalContent,!1),this.state.currentTaskId=null,this.state.currentDeleteUrl=null}showModal(){this.setModalState(this.elements.modal,this.elements.modalContent,!0)}hideModal(){this.setModalState(this.elements.modal,this.elements.modalContent,!1)}setModalState(t,e,s){t&&e&&(s?(t.classList.remove("opacity-0","invisible"),t.classList.add("opacity-100","visible"),e.classList.remove("scale-95"),e.classList.add("scale-100")):(t.classList.add("opacity-0","invisible"),t.classList.remove("opacity-100","visible"),e.classList.add("scale-95"),e.classList.remove("scale-100")))}expandAddTaskForm(t){if(!t)return;const e=t.querySelector(".add-task-collapsed"),s=t.querySelector(".add-task-expanded"),o=t.querySelector('input[name="text"]');e&&s&&(e.style.display="none",s.classList.remove("hidden"),setTimeout(()=>o?.focus(),100))}collapseAddTaskForm(t){if(!t)return;const e=t.querySelector(".add-task-collapsed"),s=t.querySelector(".add-task-expanded"),o=t.querySelector('input[name="text"]'),l=t.querySelector(".error-message");e&&s&&(e.style.display="block",s.classList.add("hidden"),o&&(o.value="",o.classList.remove("border-red-500"),o.classList.add("border-[var(--inline-input-border)]")),l&&(l.innerHTML=""))}collapseAllAddTaskForms(){document.querySelectorAll(".add-task-form").forEach(t=>{this.collapseAddTaskForm(t)})}setupGridScrolling(t=!1){const{scrollable:e,leftBtn:s,rightBtn:o,gridTable:l,dataCols:a}=this.elements;if(e&&s&&o&&l&&a.length){if(this.state.totalDataColumns=parseInt(l.dataset.totalDataColumns)||0,this.state.columnsToShow=Math.min(3,this.state.totalDataColumns),s.onclick||(s.onclick=()=>this.scrollToCol(this.state.currentCol-1),o.onclick=()=>this.scrollToCol(this.state.currentCol+1)),!this.observers.has("resize")){const t=new ResizeObserver(()=>{const t=e.scrollLeft;this.calculateAndApplyWidths(),e.scrollLeft=t,this.updateScrollButtons()});t.observe(e),this.observers.set("resize",t)}this.calculateAndApplyWidths(),this.updateScrollButtons(),t||this.restoreScrollPosition()}}calculateAndApplyWidths(){const{scrollable:t,gridTable:e,dataCols:s}=this.elements;if(t&&s.length){if(this.state.columnsToShow>0){const o=t.clientWidth;this.state.dataColWidth=o/this.state.columnsToShow,s.forEach(t=>{t.style.width=`${this.state.dataColWidth}px`});const l=this.state.dataColWidth*this.state.totalDataColumns;e.style.width=`${l}px`}this.syncRowHeights()}}scrollToCol(t,e="smooth"){const{scrollable:s}=this.elements;if(!s)return;this.state.currentCol=Math.max(0,Math.min(t,this.state.totalDataColumns-this.state.columnsToShow));const o=this.state.currentCol*this.state.dataColWidth;s.scrollTo({left:o,behavior:e}),this.updateScrollButtons()}updateScrollButtons(){const{leftBtn:t,rightBtn:e}=this.elements;t&&e&&(this.state.totalDataColumns<=this.state.columnsToShow?(t.disabled=e.disabled=!0,t.style.display=e.style.display="none"):(t.style.display=e.style.display="flex",t.disabled=0===this.state.currentCol,e.disabled=this.state.currentCol>=this.state.totalDataColumns-this.state.columnsToShow))}syncRowHeights(){const{fixedRows:t,scrollRows:e}=this.elements;if(t.length===e.length)for(let s=0;s<t.length;s++){const o=t[s].querySelector("td, th"),l=e[s].querySelector("td, th");if(o&&l){o.style.height=l.style.height="auto";const t=Math.max(o.offsetHeight,l.offsetHeight);o.style.height=l.style.height=`${t}px`}}}restoreScrollPosition(){const t=sessionStorage.getItem("scrollToEnd"),e=sessionStorage.getItem("grid-scroll-position"),s=sessionStorage.getItem("edited-task-column");if(s){sessionStorage.removeItem("edited-task-column");const t=parseInt(s);setTimeout(()=>{this.scrollToCol(t,"smooth")},10)}else if(t)sessionStorage.removeItem("scrollToEnd"),setTimeout(()=>{const t=this.state.totalDataColumns-this.state.columnsToShow;this.scrollToCol(t,"auto")},10);else if(e){sessionStorage.removeItem("grid-scroll-position");const t=parseFloat(e);this.elements.scrollable&&t>0&&(this.elements.scrollable.scrollLeft=t,this.state.currentCol=this.state.dataColWidth>0?Math.round(t/this.state.dataColWidth):0,this.updateScrollButtons())}else this.scrollToCol(0,"auto")}handleScrollToEnd(){sessionStorage.setItem("scrollToEnd","true"),window.location.reload()}storeTaskEditColumn(t){const e=t.closest("td[data-col]");if(e){const t=e.dataset.col,s=document.querySelectorAll("td[data-col]"),o=[...new Set(Array.from(s).map(t=>t.dataset.col))].indexOf(t);o>=0&&sessionStorage.setItem("edited-task-column",o.toString())}}handleHtmxAfterRequest(t){if(t.detail.requestConfig&&"post"===t.detail.requestConfig.verb&&t.target.closest("#modal-content")&&this.elements.scrollable&&sessionStorage.setItem("grid-scroll-position",this.elements.scrollable.scrollLeft.toString()),t.detail.successful){const e=t.target.closest(".task-form");if(e){const t=e.querySelector('input[name="text"]');t&&(t.value="",e.classList.contains("add-task-form")?this.collapseAddTaskForm(e):t.focus());const s=e.querySelector(".error-message");s&&(s.innerHTML="")}}}handleHtmxAfterSwap(t){const e=t.detail.target&&"modal-content"===t.detail.target.id,s=t.detail.target&&t.detail.target.closest("#grid-content");e?this.reinitializeComponents():s&&setTimeout(()=>this.syncRowHeights(),10)}handleHtmxAfterSettle(t){if(t.detail.target&&(t.detail.target.closest("#grid-content")||t.detail.target.closest(".task-form"))){const t=this.elements.scrollable?this.elements.scrollable.scrollLeft:0;setTimeout(()=>{this.syncRowHeights(),this.elements.scrollable&&this.elements.scrollable.scrollLeft!==t&&(this.elements.scrollable.scrollLeft=t)},10)}}reinitializeComponents(){const t=this.elements.scrollable?this.elements.scrollable.scrollLeft:0;this.cacheElements(),this.setupGridScrolling(!0),this.elements.scrollable&&t>0&&(this.elements.scrollable.scrollLeft=t,this.state.currentCol=this.state.dataColWidth>0?Math.round(t/this.state.dataColWidth):0,this.updateScrollButtons())}cleanup(){this.eventListeners.forEach((t,e)=>{t.forEach(({event:t,handler:s})=>{e.removeEventListener(t,s)})}),this.eventListeners.clear(),this.observers.forEach(t=>t.disconnect()),this.observers.clear()}init(){this.cacheElements(),this.addEventListeners(),this.setupGridScrolling(),console.log("Grid JavaScript optimized and loaded")}}function validateTaskForm(t){const e=t.querySelector('input[name="text"]'),s=t.querySelector(".error-message");return e.value.trim()?(s.innerHTML="",e.classList.remove("border-red-500"),e.classList.add("border-[var(--inline-input-border)]"),!0):(s.innerHTML="Please enter a task description",e.classList.remove("border-[var(--inline-input-border)]"),e.classList.add("border-red-500"),e.focus(),!1)}document.addEventListener("DOMContentLoaded",function(){window.gridManager=new GridManager}),window.addEventListener("beforeunload",function(){window.gridManager&&window.gridManager.cleanup()});