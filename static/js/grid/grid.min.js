class GridManager{constructor(){window.innerWidth<769||(this.state={currentCol:0,dataColWidth:0,totalDataColumns:0,columnsToShow:3,isDropdownOpen:!1,currentTaskId:null,currentDeleteUrl:null,isDragging:!1,draggedElement:null,dragStartY:0,dragStartX:0,originalOrder:[],dragPlaceholder:null,aboutToDrag:!1,dragStartElement:null,targetTask:null,dropAfter:null,originalLeft:0,originalTop:0,originalWidth:0,originalHeight:0,dragClone:null,lastLiveReorder:null,isScrollingToEnd:!1},this.elements={},this.observers=new Map,this.eventListeners=new Map,this.init())}cacheElements(){const t={switcherBtn:"#project-switcher-btn",switcherDropdown:"#project-switcher-dropdown",switcherChevron:"#switcher-chevron",switcherContainer:"#project-switcher-container",scrollable:".grid-table-scrollable",leftBtn:".left-scroll-btn",rightBtn:".right-scroll-btn",gridTable:".grid-table",dataCols:"col.data-column",gridContent:"#grid-content",deleteModal:"#delete-task-modal",deleteModalContent:"#delete-modal-content",taskToDelete:"#task-to-delete",deleteTaskForm:"#delete-task-form",closeDeleteModal:"#close-delete-modal",cancelDeleteTask:"#cancel-delete-task",modal:"#modal",modalContent:"#modal-content",fixedRows:".grid-table-fixed tr",scrollRows:".grid-table-scrollable .grid-table tr",fixedTable:".grid-table-fixed",dataTable:".grid-table",draggableTasks:'[draggable="true"]',taskContainers:"[data-row][data-col]"};Object.keys(t).forEach(e=>{const s=t[e];s.includes("All")||e.includes("Rows")||"dataCols"===e||"draggableTasks"===e||"taskContainers"===e?this.elements[e]=document.querySelectorAll(s):this.elements[e]=document.querySelector(s)})}addEventListeners(){[["document","click",this.handleDocumentClick.bind(this)],["document","keydown",this.handleKeydown.bind(this)],["document","htmx:beforeRequest",this.handleHtmxBeforeRequest.bind(this)],["document","htmx:afterRequest",this.handleHtmxAfterRequest.bind(this)],["document","htmx:afterSwap",this.handleHtmxAfterSwap.bind(this)],["document","htmx:afterSettle",this.handleHtmxAfterSettle.bind(this)],["document","htmx:responseError",this.handleHtmxError.bind(this)],["document","htmx:sendError",this.handleHtmxError.bind(this)],["window","resize",this.handleWindowResize.bind(this)],["body","openModal",this.showModal.bind(this)],["body","closeModal",this.hideModal.bind(this)],["body","refreshGrid",this.handleRefreshGrid.bind(this)],["body","scrollToEnd",this.handleScrollToEnd.bind(this)],["body","resetGridToInitial",this.handleResetGridToInitial.bind(this)]].forEach(([t,e,s])=>{const o="document"===t?document:"window"===t?window:document.body;o.addEventListener(e,s),this.eventListeners.has(o)||this.eventListeners.set(o,[]),this.eventListeners.get(o).push({event:e,handler:s})}),document.addEventListener("scrollToEnd",t=>{this.handleScrollToEnd()}),document.addEventListener("htmx:trigger",t=>{"scrollToEnd"===t.detail.trigger&&this.handleScrollToEnd()}),document.body.addEventListener("htmx:afterRequest",t=>{if(t.detail.xhr&&t.detail.xhr.getResponseHeader("HX-Trigger")){const e=t.detail.xhr.getResponseHeader("HX-Trigger");if(e&&e.includes("scrollToEnd"))return void this.handleScrollToEnd();if(e&&e.includes("refreshGrid"))return void this.handleRefreshGrid();if(e&&e.includes("resetGridToInitial"))return void this.handleResetGridToInitial()}}),this.setupDragAndDrop()}setupDragAndDrop(){window.innerWidth<769||this.initializeSortable()}initializeSortable(){document.querySelectorAll("[data-row][data-col]").forEach(t=>{new Sortable(t,{handle:".drag-handle",sort:!0,animation:150,dragClass:"sortable-drag",group:"tasks",onEnd:t=>{const e=this.getTaskOrder();this.saveTaskOrder(e)}})})}handleDragEnter(t){if(!this.state.isDragging||this.state.isScrollingToEnd)return;const e=t.target.closest("[data-row][data-col]");e&&e.classList.add("drag-over")}handleDragLeave(t){if(!this.state.isDragging||this.state.isScrollingToEnd)return;const e=t.target.closest("[data-row][data-col]");e&&!e.contains(t.relatedTarget)&&e.classList.remove("drag-over")}createDragPlaceholder(t){this.state.dragPlaceholder=t.cloneNode(!0),this.state.dragPlaceholder.classList.add("drag-placeholder"),this.state.dragPlaceholder.style.opacity="0.5",this.state.dragPlaceholder.style.border="2px dashed var(--primary-action-bg)",this.state.dragPlaceholder.style.backgroundColor="var(--grid-header-bg)",this.state.dragPlaceholder.style.minHeight="40px",this.state.dragPlaceholder.style.margin="4px 0",this.state.dragPlaceholder.removeAttribute("draggable");this.state.dragPlaceholder.querySelectorAll("button, input, form, .drag-handle").forEach(t=>t.remove()),t.parentNode.insertBefore(this.state.dragPlaceholder,t)}updateDragPlaceholder(t,e){this.state.dragPlaceholder&&(e?t.parentNode.insertBefore(this.state.dragPlaceholder,t.nextSibling):t.parentNode.insertBefore(this.state.dragPlaceholder,t))}removeDragPlaceholder(){this.state.dragPlaceholder&&(this.state.dragPlaceholder.remove(),this.state.dragPlaceholder=null),document.querySelectorAll(".drag-over").forEach(t=>{t.classList.remove("drag-over")})}getTaskOrder(){const t=[],e=document.querySelectorAll("[data-task-id]"),s=Array.from(e).filter(t=>t.classList.contains("group")&&t.classList.contains("flex")&&t.classList.contains("items-center")&&t.classList.contains("justify-between")&&t.classList.contains("w-full")&&t.classList.contains("p-2")&&t.classList.contains("rounded-lg")),o={};return s.forEach(t=>{const e=t.closest("[data-row][data-col]");if(!e)return;const s=`${e.dataset.row}-${e.dataset.col}`;o[s]||(o[s]=[]),o[s].push(t)}),Object.keys(o).forEach(e=>{const[s,i]=e.split("-"),n=o[e];n.sort((t,e)=>{const s=t.closest("[data-row][data-col]"),o=Array.from(s.querySelectorAll("[data-task-id]")).filter(t=>t.classList.contains("group")&&t.classList.contains("flex")&&t.classList.contains("items-center")&&t.classList.contains("justify-between")&&t.classList.contains("w-full")&&t.classList.contains("p-2")&&t.classList.contains("rounded-lg"));return o.indexOf(t)-o.indexOf(e)}),n.forEach((e,o)=>{const n=e.dataset.taskId,a=o;t.push({task_id:n,row_header:s,column_header:i,order:a})})}),t}saveTaskOrder(t){const e=this.getProjectId();if(!e)return;const s={task_order:t};fetch(`/grids/${e}/tasks/reorder/`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":this.getCSRFToken()},body:JSON.stringify(s)}).then(t=>{if(!t.ok)throw new Error("Failed to save task order");return t.json()}).then(e=>{e.success?this.updateTaskOrderAttributes(t):this.revertToOriginalOrder()}).catch(t=>{this.revertToOriginalOrder()})}getProjectId(){const t=window.location.pathname.split("/"),e=t.indexOf("grids");return e>=0&&e+1<t.length?t[e+1]:null}getCSRFToken(){const t=document.querySelector("[name=csrfmiddlewaretoken]");return t?t.value:""}updateTaskOrderAttributes(t){t.forEach((t,e)=>{const s=document.querySelector(`[data-task-id="${t.task_id}"]`);if(s){s.dataset.taskOrder,s.dataset.taskRow,s.dataset.taskCol;s.dataset.taskOrder=t.order.toString(),s.dataset.taskRow=t.row_header,s.dataset.taskCol=t.column_header}})}updateTaskOrderAttributesInContainer(t){Array.from(t.querySelectorAll("[data-task-id]")).forEach((t,e)=>{t.dataset.taskOrder=e.toString()})}revertToOriginalOrder(){this.state.originalOrder.length&&this.showReorderError()}showReorderError(){const t=document.createElement("div");t.className="fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg z-50",t.textContent="Failed to save task order. Please try again.",document.body.appendChild(t),setTimeout(()=>{t.remove()},3e3)}verifyOrder(t,e){if(t.length!==e.length)return console.error("GridManager: Order length mismatch:",t.length,"vs",e.length),!1;for(let s=0;s<t.length;s++){const o=t[s],i=e[s];if(o.task_id!==i.task_id||o.row_header!==i.row_header||o.column_header!==i.column_header||o.order!==i.order)return console.error("GridManager: Order mismatch at index",s,":",o,"vs",i),!1}return!0}handleDocumentClick(t){if(t.target.closest('[hx-target="#modal-content"]')&&(this.clearModalContent(),this.showModal()),t.target.closest("#project-switcher-btn"))return t.stopPropagation(),void this.toggleProjectSwitcher();t.target.closest("#project-switcher-container")||this.closeProjectSwitcher();const e=t.target.closest(".delete-task-btn");if(e)return t.preventDefault(),void this.showDeleteModal(e.dataset.taskId,e.dataset.taskText,e.dataset.deleteUrl);const s=t.target.closest(".close-modal, #close-delete-modal, #cancel-delete-task");if(s)return void("close-delete-modal"===s.id||"cancel-delete-task"===s.id?this.hideDeleteModal():s.classList.contains("close-modal")&&this.hideModal());t.target===this.elements.deleteModal&&this.hideDeleteModal(),t.target===this.elements.modal&&this.hideModal();const o=t.target.closest(".add-task-trigger");if(o)return t.preventDefault(),void this.expandAddTaskForm(o.closest(".add-task-form"));const i=t.target.closest(".add-task-cancel");if(i)return t.preventDefault(),void this.collapseAddTaskForm(i.closest(".add-task-form"));t.target.closest(".add-task-form")||this.collapseAllAddTaskForms();const n=t.target.closest('input[type="checkbox"][name="completed"]');if(n){const t=n.closest("form");if(t&&t.hasAttribute("hx-post")){const t=n.id.replace("checkbox-",""),e=document.getElementById(`task-text-${t}`);e&&(n.checked?(n.classList.add("checkbox-completed"),e.classList.add("task-completed-strikethrough")):(n.classList.remove("checkbox-completed"),e.classList.remove("task-completed-strikethrough")))}}}handleKeydown(t){"Escape"===t.key&&(this.closeProjectSwitcher(),this.hideDeleteModal(),this.hideModal(),this.collapseAllAddTaskForms())}toggleProjectSwitcher(){this.elements.switcherDropdown&&(this.state.isDropdownOpen=!this.state.isDropdownOpen,this.updateProjectSwitcherUI())}closeProjectSwitcher(){this.state.isDropdownOpen&&(this.state.isDropdownOpen=!1,this.updateProjectSwitcherUI())}updateProjectSwitcherUI(){const{switcherDropdown:t,switcherChevron:e,switcherBtn:s}=this.elements;if(!t)return;const o=this.state.isDropdownOpen?{remove:["opacity-0","invisible","scale-95"],add:["opacity-100","visible","scale-100"]}:{remove:["opacity-100","visible","scale-100"],add:["opacity-0","invisible","scale-95"]};t.classList.remove(...o.remove),t.classList.add(...o.add),e&&(e.style.transform=this.state.isDropdownOpen?"rotate(180deg)":"rotate(0deg)"),s&&(s.classList.toggle("ring-2",this.state.isDropdownOpen),s.classList.toggle("ring-[var(--primary-action-bg)]/20",this.state.isDropdownOpen))}closeAllDropdowns(){this.closeProjectSwitcher()}showDeleteModal(t,e,s){this.state.currentTaskId=t,this.state.currentDeleteUrl=s,this.elements.taskToDelete&&(this.elements.taskToDelete.textContent=e),this.elements.deleteTaskForm&&(this.elements.deleteTaskForm.action=s,this.elements.deleteTaskForm.setAttribute("hx-post",s),"undefined"!=typeof htmx&&htmx.process(this.elements.deleteTaskForm)),this.setModalState(this.elements.deleteModal,this.elements.deleteModalContent,!0),setTimeout(()=>this.elements.cancelDeleteTask?.focus(),100)}hideDeleteModal(){this.setModalState(this.elements.deleteModal,this.elements.deleteModalContent,!1),this.state.currentTaskId=null,this.state.currentDeleteUrl=null}showModal(){this.setModalState(this.elements.modal,this.elements.modalContent,!0)}hideModal(){this.setModalState(this.elements.modal,this.elements.modalContent,!1)}clearModalContent(){this.elements.modalContent&&(this.elements.modalContent.innerHTML='\n                <div class="flex items-center justify-center p-8">\n                    <div class="flex items-center space-x-3">\n                        <div class="animate-spin w-6 h-6 border-2 border-[var(--primary-action-bg)] border-t-transparent rounded-full"></div>\n                        <span class="text-[var(--text-secondary)]">Loading...</span>\n                    </div>\n                </div>\n            ')}setModalState(t,e,s){t&&e&&(s?(t.classList.remove("opacity-0","invisible"),t.classList.add("opacity-100","visible"),e.classList.remove("scale-95"),e.classList.add("scale-100")):(t.classList.add("opacity-0","invisible"),t.classList.remove("opacity-100","visible"),e.classList.add("scale-95"),e.classList.remove("scale-100")))}expandAddTaskForm(t){if(!t)return;this.collapseAllAddTaskForms();const e=t.querySelector(".add-task-collapsed"),s=t.querySelector(".add-task-expanded"),o=t.querySelector('input[name="text"]');e&&s&&(e.style.display="none",s.classList.remove("hidden"),setTimeout(()=>o?.focus(),100))}collapseAddTaskForm(t){if(!t)return;const e=t.querySelector(".add-task-collapsed"),s=t.querySelector(".add-task-expanded"),o=t.querySelector('input[name="text"]'),i=t.querySelector(".error-message");e&&s&&(e.style.display="block",s.classList.add("hidden"),o&&(o.value="",o.classList.remove("border-red-500"),o.classList.add("border-[var(--inline-input-border)]")),i&&(i.innerHTML=""))}collapseAllAddTaskForms(){document.querySelectorAll(".add-task-form").forEach(t=>{this.collapseAddTaskForm(t)})}getResponsiveColumnCount(){const t=window.innerWidth;return t<=480?1:t<=768?2:3}setupGridScrolling(t=!1){const{scrollable:e,leftBtn:s,rightBtn:o,gridTable:i}=this.elements;if(!(e&&s&&o&&i))return console.warn("Grid elements not found, retrying..."),void setTimeout(()=>{this.cacheElements(),this.setupGridScrolling(t)},100);const n=document.querySelectorAll(".data-column");if(this.elements.dataCols=n,!n.length)return void console.warn("No data columns found");const a=parseInt(i.dataset.totalDataColumns),r=n.length;if(this.state.totalDataColumns=a||r,this.state.columnsToShow=Math.min(this.getResponsiveColumnCount(),this.state.totalDataColumns),s.onclick||(s.onclick=t=>{t.preventDefault(),this.scrollToCol(this.state.currentCol-1,"auto")},o.onclick=t=>{t.preventDefault(),this.scrollToCol(this.state.currentCol+1,"auto")},s.addEventListener("touchstart",t=>{t.preventDefault(),this.scrollToCol(this.state.currentCol-1,"auto")}),o.addEventListener("touchstart",t=>{t.preventDefault(),this.scrollToCol(this.state.currentCol+1,"auto")})),!this.observers.has("resize")){const t=new ResizeObserver(()=>{const t=e.scrollLeft,s=this.getResponsiveColumnCount();s!==this.state.columnsToShow&&(this.state.columnsToShow=Math.min(s,this.state.totalDataColumns),this.state.currentCol=Math.min(this.state.currentCol,Math.max(0,this.state.totalDataColumns-this.state.columnsToShow))),this.calculateAndApplyWidths(),e.scrollLeft=t,this.updateScrollButtons()});t.observe(e),this.observers.set("resize",t)}if(!this.observers.has("scroll")){let t,s=!1;const o=()=>{this.state.isScrollingToEnd||(s||(s=!0),clearTimeout(t),t=setTimeout(()=>{if(this.state.dataColWidth>0){const t=Math.round(e.scrollLeft/this.state.dataColWidth);t!==this.state.currentCol&&(this.state.currentCol=t,this.updateScrollButtons())}s=!1},16))};e.addEventListener("scroll",o,{passive:!0}),this.observers.set("scroll",{disconnect:()=>{clearTimeout(t),e.removeEventListener("scroll",o)}})}this.calculateAndApplyWidths(),this.updateScrollButtons(),t||this.restoreScrollPosition(),this.elements.gridTable&&this.elements.gridTable.classList.add("initialized")}calculateAndApplyWidths(){const{scrollable:t,gridTable:e,dataCols:s}=this.elements;if(t&&s.length){if(this.state.columnsToShow>0){const o=t.closest(".grid-container-wrapper"),i=()=>{const e=t.closest(".grid-container-wrapper");let s,o;e&&(s=getComputedStyle(e),o=s.getPropertyValue("--category-col-width")),o||(s=getComputedStyle(document.documentElement),o=s.getPropertyValue("--category-col-width"));return parseInt(o)||225},n=(o?o.clientWidth:t.clientWidth)-i(),a=this.getResponsiveColumnCount();this.state.columnsToShow=Math.min(a,this.state.totalDataColumns),this.state.totalDataColumns<=this.state.columnsToShow?this.state.dataColWidth=n/this.state.totalDataColumns:this.state.dataColWidth=n/this.state.columnsToShow,s.forEach((t,e)=>{t.style.width=`${this.state.dataColWidth}px`,t.style.minWidth=`${this.state.dataColWidth}px`,t.style.maxWidth=`${this.state.dataColWidth}px`});const r=this.state.dataColWidth*this.state.totalDataColumns;e.style.width=`${r}px`,e.style.minWidth=`${r}px`}this.syncRowHeights()}}scrollToCol(t,e="smooth"){const{scrollable:s}=this.elements;if(!s)return;(this.state.totalDataColumns<=0||this.state.dataColWidth<=0)&&this.calculateAndApplyWidths();const o=Math.max(0,this.state.totalDataColumns-1),i=Math.max(0,Math.min(t,o));if(i===this.state.currentCol)return;this.state.currentCol=i;const n=i*this.state.dataColWidth;"smooth"===e?s.scrollTo({left:n,behavior:"smooth"}):s.scrollLeft=n,this.updateScrollButtons(),"smooth"===e&&setTimeout(()=>{Math.abs(s.scrollLeft-n)>5&&(s.scrollLeft=n)},100)}updateScrollButtons(){const{leftBtn:t,rightBtn:e}=this.elements;if(!t||!e)return;const s=this.state.totalDataColumns<=this.state.columnsToShow,o=0===this.state.currentCol,i=this.state.currentCol>=this.state.totalDataColumns-this.state.columnsToShow;s?"none"!==t.style.display&&(t.style.display=e.style.display="none",t.disabled=e.disabled=!0):("flex"!==t.style.display&&(t.style.display=e.style.display="flex"),t.disabled!==o&&(t.disabled=o),e.disabled!==i&&(e.disabled=i))}syncRowHeights(){const{fixedRows:t,scrollRows:e}=this.elements;if(t.length===e.length)for(let s=0;s<t.length;s++){const o=t[s].querySelector("td, th"),i=e[s].querySelector("td, th");if(o&&i){o.style.height=i.style.height="auto";const t=Math.max(o.offsetHeight,i.offsetHeight);o.style.height=i.style.height=`${t}px`}}}restoreScrollPosition(){const t=sessionStorage.getItem("scrollToEnd"),e=sessionStorage.getItem("grid-scroll-position");if(sessionStorage.getItem("resetToInitial"))return sessionStorage.removeItem("resetToInitial"),this.state.currentCol=0,void this.scrollToCol(0,"auto");if(t)sessionStorage.removeItem("scrollToEnd"),this.state.isScrollingToEnd=!0,this.performScrollToEnd();else if(e){sessionStorage.removeItem("grid-scroll-position");const t=parseFloat(e);this.elements.scrollable&&t>0&&setTimeout(()=>{this.elements.scrollable.scrollLeft=t,this.state.currentCol=this.state.dataColWidth>0?Math.round(t/this.state.dataColWidth):0,this.updateScrollButtons()},50)}else this.state.currentCol=0,this.elements.scrollable&&(this.elements.scrollable.scrollLeft=0,setTimeout(()=>{0!==this.elements.scrollable.scrollLeft&&(this.elements.scrollable.scrollLeft=0),this.elements.scrollable.scrollLeft>0&&(this.elements.scrollable.scrollLeft=0)},10)),this.updateScrollButtons()}performScrollToEnd(){this.state.isScrollingToEnd=!0,setTimeout(()=>{const t=document.querySelectorAll(".data-column").length;console.log("ScrollToEnd: Found",t,"columns"),t>0?(this.state.totalDataColumns=t,this.elements.gridTable&&(this.elements.gridTable.dataset.totalDataColumns=t),this.calculateAndApplyWidths(),setTimeout(()=>{const t=Math.max(0,this.state.totalDataColumns-1);console.log("ScrollToEnd: Scrolling to column",t,"of",this.state.totalDataColumns),this.state.currentCol=t;const e=t*this.state.dataColWidth;console.log("ScrollToEnd: Calculated scroll position:",e,"px (column width:",this.state.dataColWidth,"px)"),this.elements.scrollable&&(this.elements.scrollable.scrollLeft=e,setTimeout(()=>{this.elements.scrollable&&this.state.isScrollingToEnd&&(this.elements.scrollable.scrollLeft=e,console.log("ScrollToEnd: Forced scroll position:",this.elements.scrollable.scrollLeft,"px"))},50),setTimeout(()=>{if(this.elements.scrollable&&this.state.isScrollingToEnd){const e=this.elements.scrollable.scrollLeft,s=t*this.state.dataColWidth;console.log("ScrollToEnd: Final verification - Current scroll:",e,"px, Expected:",s,"px"),Math.abs(e-s)>5&&(console.log("ScrollToEnd: Final scroll position correction"),this.elements.scrollable.scrollLeft=s,this.state.currentCol=t)}this.state.isScrollingToEnd=!1},200)),this.updateScrollButtons()},100)):(this.scrollToCol(0,"auto"),this.state.isScrollingToEnd=!1)},300)}handleScrollToEnd(){sessionStorage.setItem("scrollToEnd","true"),window.location.reload()}handleRefreshGrid(){this.elements.scrollable&&sessionStorage.setItem("grid-scroll-position",this.elements.scrollable.scrollLeft.toString()),window.location.reload()}handleResetGridToInitial(){sessionStorage.removeItem("grid-scroll-position"),sessionStorage.removeItem("scrollToEnd"),sessionStorage.setItem("resetToInitial","true"),this.state.currentCol=0,this.elements.scrollable&&(this.elements.scrollLeft=0),window.location.reload()}handleWindowResize(){this.resizeTimeout&&clearTimeout(this.resizeTimeout),this.resizeTimeout=setTimeout(()=>{const t=this.getResponsiveColumnCount();t!==this.state.columnsToShow&&(this.state.columnsToShow=Math.min(t,this.state.totalDataColumns),this.state.currentCol=Math.min(this.state.currentCol,Math.max(0,this.state.totalDataColumns-this.state.columnsToShow)),this.calculateAndApplyWidths(),this.updateScrollButtons())},100)}updateColumnHeader(t,e){document.querySelectorAll(`[data-column-id="${t}"]`).forEach(t=>{const s=t.querySelector("span.font-semibold");s&&(s.textContent=e);const o=t.querySelector(".column-header-editable");o&&(o.textContent=e,o.setAttribute("data-original-text",e))})}updateRowHeader(t,e){document.querySelectorAll(`[data-row-id="${t}"]`).forEach(t=>{const s=t.querySelector("span.font-semibold");s&&(s.textContent=e);const o=t.querySelector(".row-header-editable");o&&(o.textContent=e,o.setAttribute("data-original-text",e))})}handleHtmxBeforeRequest(t){}handleHtmxAfterRequest(t){const e=t.detail.requestConfig?.url||t.target?.getAttribute("hx-post")||t.target?.getAttribute("hx-get")||"unknown",s=t.detail.requestConfig?.verb||t.detail.requestConfig?.type||(t.target?.getAttribute("hx-post")?"post":t.target?.getAttribute("hx-get")?"get":"unknown");if(t.detail.successful&&t.detail.xhr){const e=t.detail.xhr.getResponseHeader("HX-Trigger");if(e){if(e.includes("scrollToEnd"))return void this.handleScrollToEnd();if(e.includes("refreshGrid"))return void this.handleRefreshGrid();if(e.includes("resetGridToInitial"))return void this.handleResetGridToInitial()}}if(t.detail.successful&&"post"===s&&e.includes("/columns/create/"))return this.disableInteractionsDuringScroll(),void setTimeout(()=>{this.forceScrollToEnd()},100);if(t.detail.successful&&("post"===s||"POST"===s)&&t.detail.xhr.responseText){const s=document.querySelector(".grid-table-scrollable"),o=s?s.scrollLeft:0;try{const i=JSON.parse(t.detail.xhr.responseText);if(i.success){if(e.includes("/columns/")&&e.includes("/edit/")||e.match(/\/columns\/\d+\/edit\//)){let t=null;const n=e.match(/\/columns\/(\d+)\//);if(n)t=n[1];else{const s=e.split("/"),o=s.indexOf("columns");o>=0&&o+1<s.length&&(t=s[o+1])}if(t&&i.col_name)return this.updateColumnHeader(t,i.col_name),this.hideModal(),void setTimeout(()=>{s&&(s.scrollLeft=o,this.state.dataColWidth>0&&(this.state.currentCol=Math.round(o/this.state.dataColWidth),this.updateScrollButtons()))},50)}if(e.includes("/rows/")&&e.includes("/edit/")||e.match(/\/rows\/\d+\/edit\//)){let t=null;const n=e.match(/\/rows\/(\d+)\//);if(n)t=n[1];else{const s=e.split("/"),o=s.indexOf("rows");o>=0&&o+1<s.length&&(t=s[o+1])}if(t&&i.row_name)return this.updateRowHeader(t,i.row_name),this.hideModal(),void setTimeout(()=>{s&&(s.scrollLeft=o,this.state.dataColWidth>0&&(this.state.currentCol=Math.round(o/this.state.dataColWidth),this.updateScrollButtons()))},50)}}}catch(t){}}if(t.detail.successful&&"delete-task-form"===t.target.id&&"post"===t.detail.requestConfig.verb){const t=this.state.currentTaskId;if(t){const e=document.getElementById(`task-${t}`);if(e){const t=document.querySelector(".grid-table-scrollable"),s=t?t.scrollLeft:0;e.style.transition="all 0.3s ease",e.style.opacity="0",e.style.transform="scale(0.95)",setTimeout(()=>{e.remove(),t&&s>0&&(t.scrollLeft=s),setTimeout(()=>{this.syncRowHeights(),t&&s>0&&(t.scrollLeft=s,this.state.dataColWidth>0&&(this.state.currentCol=Math.round(s/this.state.dataColWidth),this.updateScrollButtons()))},10)},300)}}return void this.hideDeleteModal()}if(!t.detail.successful&&"delete-task-form"===t.target.id&&"post"===t.detail.requestConfig.verb)return void alert("Failed to delete task. Please try again.");if(t.detail.successful&&t.target.closest("#modal-content")&&"post"===t.detail.requestConfig.verb){let e=null;try{e=JSON.parse(t.detail.xhr.response)}catch(t){return void window.location.reload()}const s=document.getElementById("modal"),o=document.getElementById("modal-content");s.classList.add("opacity-0","invisible"),o.classList.remove("scale-100"),o.classList.add("scale-95"),e&&e.task_id&&e.task_html?setTimeout(()=>{const t=document.getElementById(`task-${e.task_id}`);if(t){const s=document.querySelector(".grid-table-scrollable"),o=s?s.scrollLeft:0;t.outerHTML=e.task_html;const i=document.getElementById(`task-${e.task_id}`);i&&"undefined"!=typeof htmx&&htmx.process(i),s&&o>0&&(s.scrollLeft=o),setTimeout(()=>{this.syncRowHeights(),s&&o>0&&(s.scrollLeft=o,this.state.dataColWidth>0&&(this.state.currentCol=Math.round(o/this.state.dataColWidth),this.updateScrollButtons()))},10)}else window.location.reload()},300):setTimeout(()=>window.location.reload(),300)}if(t.detail.requestConfig&&"post"===t.detail.requestConfig.verb&&t.target.closest("#modal-content")&&this.elements.scrollable&&sessionStorage.setItem("grid-scroll-position",this.elements.scrollable.scrollLeft.toString()),!t.detail.successful&&t.target.closest('form[hx-post*="toggle"]')){const e=t.target.closest("form").querySelector('input[type="checkbox"][name="completed"]');if(e){const t=e.id.replace("checkbox-",""),s=document.getElementById(`task-text-${t}`);e.checked=!e.checked,s&&(e.checked?(e.classList.add("checkbox-completed"),s.classList.add("task-completed-strikethrough")):(e.classList.remove("checkbox-completed"),s.classList.remove("task-completed-strikethrough")))}}if(t.detail.successful&&t.target.closest('form[hx-post*="toggle"]'))try{const e=JSON.parse(t.detail.xhr.response);if(e.success&&e.hasOwnProperty("completed")){const s=t.target.closest("form").querySelector('input[type="checkbox"][name="completed"]');if(s){const t=s.id.replace("checkbox-",""),o=document.getElementById(`task-text-${t}`);s.checked=e.completed,o&&(e.completed?(s.classList.add("checkbox-completed"),o.classList.add("task-completed-strikethrough")):(s.classList.remove("checkbox-completed"),o.classList.remove("task-completed-strikethrough")))}}}catch(t){}if(t.detail.successful){const e=t.target.closest(".task-form");if(e){const t=e.querySelector('input[name="text"]');t&&(t.value="",e.classList.contains("add-task-form")?this.collapseAddTaskForm(e):t.focus());const s=e.querySelector(".error-message");s&&(s.innerHTML="")}}}handleHtmxAfterSwap(t){if("modal-content"===t.detail.target.id){const e=t.detail.target;this.showModal();const s=e.querySelector('textarea, input[name="text"]');if(s){const t=t=>{if("Enter"===t.key){if("textarea"===s.tagName.toLowerCase()&&t.shiftKey)return;t.preventDefault();const e=s.closest("form");if(e){const t=e.querySelector('button[type="submit"]');t?t.click():e.submit()}}};s.addEventListener("keydown",t),setTimeout(()=>{s.focus(),s.setSelectionRange(s.value.length,s.value.length)},150)}}t.detail.target&&t.detail.target.closest('[id^="tasks-"]')&&void 0!==window._hyperscript&&window._hyperscript.processNode(t.detail.target);const e=t.detail.target&&"modal-content"===t.detail.target.id,s=t.detail.target&&t.detail.target.closest("#grid-content"),o=t.detail.target&&t.detail.target.closest('[id^="task-"]');if(e)"undefined"!=typeof htmx&&htmx.process(t.detail.target),this.reinitializeComponents();else if(s&&!o)setTimeout(()=>this.syncRowHeights(),10);else if(o){t.detail.target&&t.detail.target.querySelector("[data-task-id]")&&setTimeout(()=>{const e=t.detail.target.querySelectorAll("[data-task-id]");"undefined"!=typeof htmx&&e.forEach(t=>{htmx.process(t)});t.detail.target.querySelectorAll(".assign-task-btn").forEach(t=>{t.hasAttribute("data-initialized")||t.setAttribute("data-initialized","true")})},100)}}handleHtmxAfterSettle(t){const e=t.detail.target&&(t.detail.target.closest("#grid-content")||t.detail.target.closest(".task-form")),s=t.detail.target&&t.detail.target.closest('[id^="task-"]');if(e&&!s){const t=this.elements.scrollable?this.elements.scrollable.scrollLeft:0;setTimeout(()=>{this.syncRowHeights(),this.elements.scrollable&&this.elements.scrollable.scrollLeft!==t&&(this.elements.scrollable.scrollLeft=t)},10)}}handleHtmxError(t){t.detail.target&&"modal-content"===t.detail.target.id&&(this.elements.modalContent.innerHTML='\n                <div class="flex items-center justify-center p-8">\n                    <div class="flex flex-col items-center space-y-3 text-center">\n                        <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center">\n                            <i class="fas fa-exclamation-triangle text-red-500 text-xl"></i>\n                        </div>\n                        <div>\n                            <h3 class="text-lg font-medium text-[var(--text-primary)]">Error Loading Content</h3>\n                            <p class="text-sm text-[var(--text-secondary)] mt-1">Unable to load the requested content. Please try again.</p>\n                        </div>\n                        <button type="button" \n                                class="close-modal mt-4 px-4 py-2 bg-[var(--primary-action-bg)] hover:bg-[var(--primary-action-hover-bg)] text-white rounded-lg transition-colors">\n                            Close\n                        </button>\n                    </div>\n                </div>\n            ')}reinitializeComponents(){const t=this.elements.scrollable?this.elements.scrollable.scrollLeft:0;this.cacheElements(),this.setupGridScrolling(!0),this.addHeaderInlineEditingListeners(),this.addGridNameInlineEditingListeners(),this.elements.scrollable&&t>0&&(this.elements.scrollable.scrollLeft=t,this.state.currentCol=this.state.dataColWidth>0?Math.round(t/this.state.dataColWidth):0,this.updateScrollButtons())}cleanup(){this.resizeTimeout&&clearTimeout(this.resizeTimeout),this.eventListeners.forEach((t,e)=>{t.forEach(({event:t,handler:s})=>{e.removeEventListener(t,s)})}),this.eventListeners.clear(),this.observers.forEach(t=>t.disconnect()),this.observers.clear(),this.removeInlineEditingListeners()}removeInlineEditingListeners(){const t=document.querySelectorAll(".task-text-editable"),e=document.querySelectorAll(".row-header-editable"),s=document.querySelectorAll(".column-header-editable"),o=document.querySelector(".grid-name-editable");t.forEach(t=>{t.removeEventListener("click",this.boundTaskTextClick),t.removeEventListener("blur",this.boundTaskTextBlur),t.removeEventListener("keydown",this.boundTaskTextKeydown)}),e.forEach(t=>{t.removeEventListener("click",this.boundRowHeaderClick),t.removeEventListener("blur",this.boundRowHeaderBlur),t.removeEventListener("keydown",this.boundRowHeaderKeydown)}),s.forEach(t=>{t.removeEventListener("click",this.boundColumnHeaderClick),t.removeEventListener("blur",this.boundColumnHeaderBlur),t.removeEventListener("keydown",this.boundColumnHeaderKeydown)}),o&&(o.removeEventListener("click",this.boundGridNameClick),o.removeEventListener("blur",this.boundGridNameBlur),o.removeEventListener("keydown",this.boundGridNameKeydown))}init(){this.cacheElements(),this.setInitialColumnVisibility(),this.elements.gridTable&&this.elements.gridTable.classList.add("initialized"),this.addEventListeners(),this.setupGridScrolling(),this.setupInlineEditing(),"undefined"!=typeof htmx&&(htmx.config.disableSelector="[hx-disable]",htmx.config.useTemplateFragments=!1),this.calculateAndApplyWidths(),setTimeout(()=>{this.calculateAndApplyWidths()},100),setTimeout(()=>{this.calculateAndApplyWidths(),this.syncRowHeights(),this.elements.gridContent&&this.elements.gridContent.classList.add("grid-ready")},500)}setupInlineEditing(){window.innerWidth<769||(this.boundTaskTextClick=this.handleTaskTextClick.bind(this),this.boundTaskTextBlur=this.handleTaskTextBlur.bind(this),this.boundTaskTextKeydown=this.handleTaskTextKeydown.bind(this),this.boundRowHeaderClick=this.handleRowHeaderClick.bind(this),this.boundRowHeaderBlur=this.handleRowHeaderBlur.bind(this),this.boundRowHeaderKeydown=this.handleRowHeaderKeydown.bind(this),this.boundColumnHeaderClick=this.handleColumnHeaderClick.bind(this),this.boundColumnHeaderBlur=this.handleColumnHeaderBlur.bind(this),this.boundColumnHeaderKeydown=this.handleColumnHeaderKeydown.bind(this),this.boundGridNameClick=this.handleGridNameClick.bind(this),this.boundGridNameBlur=this.handleGridNameBlur.bind(this),this.boundGridNameKeydown=this.handleGridNameKeydown.bind(this),this.addInlineEditingListeners(),this.addHeaderInlineEditingListeners(),this.addGridNameInlineEditingListeners(),document.addEventListener("htmx:afterSwap",t=>{t.detail.target&&t.detail.target.closest('[id^="tasks-"]')&&this.addInlineEditingListeners()}),document.addEventListener("htmx:afterSwap",t=>{t.detail.target&&t.detail.target.closest("#grid-content")&&this.addHeaderInlineEditingListeners()}))}addInlineEditingListeners(){document.querySelectorAll(".task-text-editable").forEach(t=>{t.removeEventListener("click",this.boundTaskTextClick),t.removeEventListener("blur",this.boundTaskTextBlur),t.removeEventListener("keydown",this.boundTaskTextKeydown),t.addEventListener("click",this.boundTaskTextClick),t.addEventListener("blur",this.boundTaskTextBlur),t.addEventListener("keydown",this.boundTaskTextKeydown)})}addHeaderInlineEditingListeners(){const t=document.querySelectorAll(".row-header-editable"),e=document.querySelectorAll(".column-header-editable");t.forEach(t=>{t.removeEventListener("click",this.boundRowHeaderClick),t.removeEventListener("blur",this.boundRowHeaderBlur),t.removeEventListener("keydown",this.boundRowHeaderKeydown),t.addEventListener("click",this.boundRowHeaderClick),t.addEventListener("blur",this.boundRowHeaderBlur),t.addEventListener("keydown",this.boundRowHeaderKeydown)}),e.forEach(t=>{t.removeEventListener("click",this.boundColumnHeaderClick),t.removeEventListener("blur",this.boundColumnHeaderBlur),t.removeEventListener("keydown",this.boundColumnHeaderKeydown),t.addEventListener("click",this.boundColumnHeaderClick),t.addEventListener("blur",this.boundColumnHeaderBlur),t.addEventListener("keydown",this.boundColumnHeaderKeydown)})}addGridNameInlineEditingListeners(){const t=document.querySelector(".grid-name-editable");t&&(t.removeEventListener("click",this.boundGridNameClick),t.removeEventListener("blur",this.boundGridNameBlur),t.removeEventListener("keydown",this.boundGridNameKeydown),t.addEventListener("click",this.boundGridNameClick),t.addEventListener("blur",this.boundGridNameBlur),t.addEventListener("keydown",this.boundGridNameKeydown))}handleTaskTextClick(t){if(window.innerWidth<769)return;const e=t.target;e.classList.contains("editing")||(this.closeAllEditingTasks(),e.contentEditable=!0,e.focus(),e.classList.add("editing"),e.getAttribute("data-original-text")||e.setAttribute("data-original-text",e.textContent),setTimeout(()=>{document.addEventListener("click",this.handleOutsideClick.bind(this,e),{once:!0})},0))}handleTaskTextBlur(t){const e=t.target;setTimeout(()=>{e.classList.contains("editing")?(e.classList.remove("editing"),e.contentEditable=!1,this.saveTaskEdit(e)):"true"===e.contentEditable&&(e.contentEditable=!1,this.saveTaskEdit(e))},10)}handleOutsideClick(t,e){t.contains(e.target)||this.closeEditingTask(t)}closeEditingTask(t){if(t.classList.contains("editing")&&"true"===t.contentEditable){const e=t.getAttribute("data-original-text")||t.textContent,s=t.textContent.trim();s!==e&&""!==s?(t.contentEditable=!1,t.classList.remove("editing"),this.saveTaskEdit(t)):(t.contentEditable=!1,t.classList.remove("editing"))}}closeAllEditingTasks(){document.querySelectorAll(".task-text-editable.editing").forEach(t=>{this.closeEditingTask(t)})}handleTaskTextKeydown(t){const e=t.target;if("Enter"!==t.key||t.shiftKey){if("Escape"===t.key){t.preventDefault(),t.stopPropagation(),e.contentEditable=!1,e.classList.remove("editing");const s=e.getAttribute("data-original-text")||e.textContent;e.textContent=s}}else t.preventDefault(),t.stopPropagation(),e.contentEditable=!1,e.classList.remove("editing"),this.saveTaskEdit(e)}saveTaskEdit(t){let e=t.dataset.taskId;if(!e){const s=t.closest("[data-task-id]");s&&(e=s.dataset.taskId)}if(!e&&t.id){const s=t.id.match(/task-text-(\d+)/);s&&(e=s[1])}const s=t.textContent.trim(),o=t.getAttribute("data-original-text")||t.textContent;e&&s!==o&&(s?(t.setAttribute("data-original-text",o),fetch(`/tasks/${e}/edit/`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":this.getCSRFToken()},body:JSON.stringify({text:s})}).then(t=>t.json()).then(e=>{e.success?t.setAttribute("data-original-text",s):t.textContent=o}).catch(e=>{t.textContent=o})):t.textContent=o)}handleRowHeaderClick(t){if(window.innerWidth<769)return;const e=t.target;e.classList.contains("editing")||(this.closeAllEditingHeaders(),e.contentEditable=!0,e.focus(),e.classList.add("editing"),e.getAttribute("data-original-text")||e.setAttribute("data-original-text",e.textContent),setTimeout(()=>{document.addEventListener("click",this.handleOutsideHeaderClick.bind(this,e),{once:!0})},0))}handleRowHeaderBlur(t){const e=t.target;setTimeout(()=>{e.classList.contains("editing")&&!e.classList.contains("saving")&&(e.classList.add("saving"),e.contentEditable=!1,e.classList.remove("editing"),this.saveRowHeaderEdit(e))},10)}handleRowHeaderKeydown(t){const e=t.target;if("Enter"!==t.key||t.shiftKey){if("Escape"===t.key){t.preventDefault(),t.stopPropagation(),e.contentEditable=!1,e.classList.remove("editing");const s=e.getAttribute("data-original-text")||e.textContent;e.textContent=s}}else t.preventDefault(),t.stopPropagation(),e.contentEditable=!1,e.classList.remove("editing"),this.saveRowHeaderEdit(e)}handleColumnHeaderClick(t){if(window.innerWidth<769)return;const e=t.target;e.classList.contains("editing")||(this.closeAllEditingHeaders(),e.contentEditable=!0,e.focus(),e.classList.add("editing"),e.getAttribute("data-original-text")||e.setAttribute("data-original-text",e.textContent),setTimeout(()=>{document.addEventListener("click",this.handleOutsideHeaderClick.bind(this,e),{once:!0})},0),t.stopPropagation())}handleColumnHeaderBlur(t){const e=t.target;setTimeout(()=>{e.classList.contains("editing")&&!e.classList.contains("saving")&&(e.classList.add("saving"),e.contentEditable=!1,e.classList.remove("editing"),this.saveColumnHeaderEdit(e))},10)}handleColumnHeaderKeydown(t){const e=t.target;if("Enter"!==t.key||t.shiftKey){if("Escape"===t.key){t.preventDefault(),t.stopPropagation(),e.contentEditable=!1,e.classList.remove("editing");const s=e.getAttribute("data-original-text")||e.textContent;e.textContent=s}}else t.preventDefault(),t.stopPropagation(),e.contentEditable=!1,e.classList.remove("editing"),this.saveColumnHeaderEdit(e)}closeAllEditingHeaders(){document.querySelectorAll(".row-header-editable.editing, .column-header-editable.editing").forEach(t=>{this.closeEditingHeader(t)})}closeEditingHeader(t){t.classList.contains("editing")&&(t.classList.add("saving"),t.contentEditable=!1,t.classList.remove("editing"),t.classList.contains("row-header-editable")?this.saveRowHeaderEdit(t):t.classList.contains("column-header-editable")&&this.saveColumnHeaderEdit(t))}handleOutsideHeaderClick(t,e){t.contains(e.target)||this.closeEditingHeader(t)}saveRowHeaderEdit(t){const e=t.dataset.rowId,s=t.textContent.trim(),o=t.getAttribute("data-original-text")||t.textContent;if(!e)return void t.classList.remove("saving");if(s===o)return void t.classList.remove("saving");if(!s)return t.textContent=o,void t.classList.remove("saving");t.setAttribute("data-original-text",o);const i=this.getProjectId();if(!i)return console.error("No project ID found"),t.textContent=o,void t.classList.remove("saving");fetch(`/grids/${i}/rows/${e}/edit/`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":this.getCSRFToken()},body:JSON.stringify({row_name:s})}).then(t=>t.json()).then(i=>{i.success?(t.setAttribute("data-original-text",s),this.updateRowHeader(e,s)):t.textContent=o,t.classList.remove("saving")}).catch(e=>{t.textContent=o,t.classList.remove("saving")})}saveColumnHeaderEdit(t){const e=t.dataset.columnId,s=t.textContent.trim(),o=t.getAttribute("data-original-text")||t.textContent;if(!e)return void t.classList.remove("saving");if(s===o)return void t.classList.remove("saving");if(!s)return t.textContent=o,void t.classList.remove("saving");t.setAttribute("data-original-text",o);const i=this.getProjectId();if(!i)return console.error("No project ID found"),t.textContent=o,void t.classList.remove("saving");fetch(`/grids/${i}/columns/${e}/edit/`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":this.getCSRFToken()},body:JSON.stringify({col_name:s})}).then(t=>t.json()).then(i=>{i.success?(t.setAttribute("data-original-text",s),this.updateColumnHeader(e,s)):t.textContent=o,t.classList.remove("saving")}).catch(e=>{t.textContent=o,t.classList.remove("saving")})}setInitialColumnVisibility(){const t=document.querySelectorAll(".data-column");if(!t.length)return;const e=this.getResponsiveColumnCount();t.forEach((t,s)=>{if(s<e){const e="300px";t.style.width=e,t.style.minWidth=e,t.style.maxWidth=e,t.style.overflow="visible"}else t.style.width="0",t.style.minWidth="0",t.style.maxWidth="0",t.style.overflow="hidden"}),this.elements.scrollable&&this.elements.scrollable.offsetHeight}forceScrollToEnd(){this.state.isScrollingToEnd&&(this.state.isScrollingToEnd=!1),this.state.isScrollingToEnd=!0,this.performScrollToEnd()}disableInteractionsDuringScroll(){const t=this.state.isDragging,e=this.state.isScrollingToEnd;this.state.isDragging=!1,this.state.isScrollingToEnd=!0,setTimeout(()=>{this.state.isDragging=t,this.state.isScrollingToEnd=e},1e3)}handleGridNameClick(t){if(window.innerWidth<769)return;const e=t.target;e.classList.contains("editing")||(this.closeAllEditingElements(),e.contentEditable=!0,e.focus(),e.classList.add("editing"),e.getAttribute("data-original-text")||e.setAttribute("data-original-text",e.textContent),setTimeout(()=>{document.addEventListener("click",this.handleOutsideGridNameClick.bind(this,e),{once:!0})},0))}handleGridNameBlur(t){const e=t.target;setTimeout(()=>{e.classList.contains("editing")&&!e.classList.contains("saving")&&(e.classList.add("saving"),e.contentEditable=!1,e.classList.remove("editing"),this.saveGridNameEdit(e))},10)}handleGridNameKeydown(t){const e=t.target;if("Enter"!==t.key||t.shiftKey){if("Escape"===t.key){t.preventDefault(),t.stopPropagation(),e.contentEditable=!1,e.classList.remove("editing");const s=e.getAttribute("data-original-text")||e.textContent;e.textContent=s}}else t.preventDefault(),t.stopPropagation(),e.contentEditable=!1,e.classList.remove("editing"),this.saveGridNameEdit(e)}handleOutsideGridNameClick(t,e){t.contains(e.target)||this.closeEditingGridName(t)}closeEditingGridName(t){t.classList.contains("editing")&&(t.classList.add("saving"),t.contentEditable=!1,t.classList.remove("editing"),this.saveGridNameEdit(t))}closeAllEditingElements(){this.closeAllEditingTasks(),this.closeAllEditingHeaders();const t=document.querySelector(".grid-name-editable.editing");t&&this.closeEditingGridName(t)}saveGridNameEdit(t){const e=t.textContent.trim(),s=t.getAttribute("data-original-text")||t.textContent;if(e===s)return void t.classList.remove("saving");if(!e)return t.textContent=s,void t.classList.remove("saving");t.setAttribute("data-original-text",s);const o=this.getProjectId();if(!o)return console.error("No project ID found"),t.textContent=s,void t.classList.remove("saving");fetch(`/grids/${o}/edit/`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":this.getCSRFToken()},body:JSON.stringify({name:e})}).then(t=>t.json()).then(o=>{if(o.success){t.setAttribute("data-original-text",e);const o=document.querySelector("title");o&&o.textContent.includes(s)&&(o.textContent=o.textContent.replace(s,e))}else t.textContent=s;t.classList.remove("saving")}).catch(e=>{t.textContent=s,t.classList.remove("saving")})}}function validateTaskForm(t){const e=t.querySelector('input[name="text"]'),s=t.querySelector(".error-message");return e.value.trim()?(s.innerHTML="",e.classList.remove("border-red-500"),e.classList.add("border-[var(--inline-input-border)]"),!0):(s.innerHTML="Please enter a task description",e.classList.remove("border-[var(--inline-input-border)]"),e.classList.add("border-red-500"),e.focus(),!1)}function handleGridLoading(){window.addEventListener("load",function(){const t=document.getElementById("grid-loading-overlay");t&&(t.style.opacity="0",setTimeout(()=>{t.style.display="none"},300));const e=document.getElementById("grid-header"),s=document.getElementById("grid-content-wrapper");e&&(e.classList.remove("grid-content-hidden"),e.classList.add("grid-content-visible")),s&&(s.classList.remove("grid-content-hidden"),s.classList.add("grid-content-visible"))}),setTimeout(function(){const t=document.getElementById("grid-loading-overlay"),e=document.getElementById("grid-header"),s=document.getElementById("grid-content-wrapper");t&&"none"!==t.style.display&&(t.style.opacity="0",setTimeout(()=>{t.style.display="none"},300)),e&&e.classList.contains("grid-content-hidden")&&(e.classList.remove("grid-content-hidden"),e.classList.add("grid-content-visible")),s&&s.classList.contains("grid-content-hidden")&&(s.classList.remove("grid-content-hidden"),s.classList.add("grid-content-visible"))},3e3)}function updateTaskNoteDisplay(t,e){const s=document.getElementById(`task-${t}`);if(!s)return;s.querySelectorAll(".task-note-btn").forEach(t=>{const s=t.querySelector("i");s&&(e?(s.className="fas fa-sticky-note text-[var(--primary-action-bg)] text-xs transition-colors",t.title="Edit note",t.setAttribute("data-has-note","true")):(s.className="fas fa-sticky-note text-gray-400 hover:text-[var(--primary-action-bg)] text-xs transition-colors",t.title="Add note",t.setAttribute("data-has-note","false")))});const o=s.querySelector(".flex.items-center.space-x-3");if(!o)return;let i=o.querySelector(".note-display");e?fetch(`/tasks/${t}/notes/`).then(t=>t.json()).then(t=>{if(t.success&&t.notes&&t.notes.length>0){if(!i){i=document.createElement("div"),i.className="note-display flex items-center text-xs text-[var(--text-secondary)] mr-2";const t=o.querySelector("form"),e=o.querySelector(".flex-1.min-w-0");t&&e&&o.insertBefore(i,e)}i.innerHTML='\n                        <i class="fas fa-sticky-note text-[var(--primary-action-bg)]"></i>\n                    '}}).catch(t=>{console.error("Error fetching notes:",t)}):i&&i.remove()}function showTeamSettingsModal(){const t=document.getElementById("team-settings-modal");t&&(t.classList.remove("opacity-0","invisible"),t.classList.add("opacity-100","visible"),t.querySelector(".transform").classList.remove("scale-95"),t.querySelector(".transform").classList.add("scale-100"))}function hideTeamSettingsModal(){const t=document.getElementById("team-settings-modal");t&&(t.classList.add("opacity-0","invisible"),t.classList.remove("opacity-100","visible"),t.querySelector(".transform").classList.add("scale-95"),t.querySelector(".transform").classList.remove("scale-100"))}function removeTeamMember(t){const e=window.location.pathname.match(/\/grids\/(\d+)\//)?.[1];e&&fetch(`/grids/${e}/team/remove/`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":document.querySelector("[name=csrfmiddlewaretoken]").value},body:JSON.stringify({member_id:t})}).then(t=>t.json()).then(e=>{if(e.success){const s=document.querySelector(`[data-member-id="${t}"]`).closest(".flex.items-center.justify-between");s&&s.remove(),window.showNotification&&window.showNotification(e.message,"success")}else window.showNotification&&window.showNotification(e.error||"Failed to remove team member","error")}).catch(t=>{console.error("Error removing team member:",t),window.showNotification&&window.showNotification("Failed to remove team member","error")})}function addTeamMember(t){const e=window.location.pathname.match(/\/grids\/(\d+)\//)?.[1];e&&fetch(`/grids/${e}/team/add/`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":document.querySelector("[name=csrfmiddlewaretoken]").value},body:JSON.stringify({email:t})}).then(t=>t.json()).then(t=>{t.success?(document.getElementById("member-email").value="",window.location.reload()):window.showNotification&&window.showNotification(t.error||"Failed to add team member","error")}).catch(t=>{console.error("Error adding team member:",t),window.showNotification&&window.showNotification("Failed to add team member","error")})}document.addEventListener("DOMContentLoaded",function(){handleGridLoading(),window.gridManager=new GridManager}),window.closeAllDropdowns=function(){window.gridManager&&window.gridManager.closeAllDropdowns()},window.cleanupDuplicateTasks=function(){window.gridManager&&window.gridManager.cleanupDuplicateTasks()},window.inspectDuplicateTasks=function(){window.gridManager&&window.gridManager.inspectDuplicateTasks()},window.showTaskNotePanel=function(t,e,s){const o=document.getElementById("task-note-panel"),i=document.getElementById("task-note-overlay"),n=document.getElementById("note-panel-task-text"),a=document.getElementById("task-note-form"),r=document.getElementById("note-text"),l=document.getElementById("notes-display"),d=document.getElementById("notes-list"),c=document.getElementById("note-form-label");o&&i&&n&&a&&r?(n.textContent=e,a.action=`/tasks/${t}/note/`,r.value="",s?(l.classList.remove("hidden"),c.textContent="Add Note",fetch(`/tasks/${t}/notes/`).then(t=>t.json()).then(t=>{t.success&&t.notes&&(d.innerHTML="",t.notes.forEach(t=>{const e=document.createElement("div");e.className="border border-gray-200 rounded-lg p-4 relative mb-2";const s=new Date(t.created_at),o=s.getDate(),i=s.toLocaleDateString("en-GB",{month:"short"}),n=s.getFullYear().toString().slice(-2),a=o+(1===o||21===o||31===o?"st":2===o||22===o?"nd":3===o||23===o?"rd":"th");e.innerHTML=`\n                                <button type="button" \n                                        class="delete-note-btn absolute top-2 right-2 text-gray-400 hover:text-red-500 transition-colors"\n                                        data-note-id="${t.id}"\n                                        title="Delete note">\n                                    <i class="fas fa-trash text-xs"></i>\n                                </button>\n                                <p class="text-sm text-gray-900 whitespace-pre-wrap pr-6">${t.note}</p>\n                                <p class="text-xs text-gray-700 mt-2">${a} ${i} ${n}</p>\n                            `,d.appendChild(e)}))}).catch(t=>{console.error("Error loading notes:",t)})):(l.classList.add("hidden"),c.textContent="Add Note"),i.style.pointerEvents="auto",i.classList.remove("opacity-0","invisible"),o.style.transform="translateX(0)",o.style.transition="transform 0.3s ease-in-out",setTimeout(()=>{r.focus()},300)):console.error("Required elements not found:",{panel:o,taskTextElement:n,form:a,noteTextarea:r})},window.hideTaskNotePanel=function(){const t=document.getElementById("task-note-panel"),e=document.getElementById("task-note-overlay");t&&e&&(e.style.pointerEvents="none",e.classList.add("opacity-0","invisible"),t.style.transform="translateX(100%)",t.style.transition="transform 0.3s ease-in-out")},document.addEventListener("click",function(t){const e=t.target.closest(".task-note-btn");if(e){t.preventDefault();const s=e.dataset.taskId,o=e.dataset.taskText,i="true"===e.dataset.hasNote;return showTaskNotePanel(s,o,i),!1}}),document.addEventListener("DOMContentLoaded",function(){const t=document.getElementById("close-note-panel"),e=(document.getElementById("cancel-note-btn"),document.getElementById("task-note-panel"));t&&t.addEventListener("click",hideTaskNotePanel),document.addEventListener("click",function(t){const e=t.target.closest(".delete-note-btn");if(e){t.preventDefault();const s=e.dataset.noteId,o=document.getElementById("task-note-form").action.split("/tasks/")[1].split("/note/")[0];fetch(`/tasks/${o}/note/`,{method:"DELETE",headers:{"X-CSRFToken":document.querySelector("[name=csrfmiddlewaretoken]").value,"X-Note-ID":s}}).then(t=>{if(!t.ok)throw new Error(`HTTP ${t.status}: ${t.statusText}`);return t.json()}).then(t=>{if(t.success){if(updateTaskNoteDisplay(o,t.has_notes),t.has_notes)fetch(`/tasks/${o}/notes/`).then(t=>t.json()).then(t=>{if(t.success&&t.notes){const e=document.getElementById("notes-list");e.innerHTML="",t.notes.forEach(t=>{const s=document.createElement("div");s.className="border border-gray-200 rounded-lg p-4 relative mb-2";const o=new Date(t.created_at),i=o.getDate(),n=o.toLocaleDateString("en-GB",{month:"short"}),a=o.getFullYear().toString().slice(-2),r=i+(1===i||21===i||31===i?"st":2===i||22===i?"nd":3===i||23===i?"rd":"th");s.innerHTML=`\n                                            <button type="button" \n                                                    class="delete-note-btn absolute top-2 right-2 text-gray-400 hover:text-red-500 transition-colors"\n                                                    data-note-id="${t.id}"\n                                                    title="Delete note">\n                                                <i class="fas fa-trash text-xs"></i>\n                                            </button>\n                                            <p class="text-sm text-gray-900 whitespace-pre-wrap pr-6">${t.note}</p>\n                                            <p class="text-xs text-gray-700 mt-2">${r} ${n} ${a}</p>\n                                        `,e.appendChild(s)})}});else{document.getElementById("notes-display").classList.add("hidden")}window.showNotification&&window.showNotification("Note deleted successfully!","success")}else window.showNotification&&window.showNotification("Failed to delete note","error")}).catch(t=>{console.error("Error deleting note:",t),window.showNotification&&window.showNotification("Failed to delete note","error")})}}),e&&e.addEventListener("click",function(t){t.target===e&&hideTaskNotePanel()});const s=document.getElementById("task-note-overlay");s&&s.addEventListener("click",function(t){t.target===s&&hideTaskNotePanel()});const o=document.getElementById("task-note-form");o&&o.addEventListener("submit",function(t){t.preventDefault();const e=new FormData(o),s=o.action.split("/tasks/")[1].split("/note/")[0],i=(e.get("note"),o.querySelector("#save-note-btn")),n=i.innerHTML;i.disabled=!0,fetch(o.action,{method:"POST",body:e,headers:{"X-CSRFToken":e.get("csrfmiddlewaretoken")}}).then(t=>{if(!t.ok)throw new Error(`HTTP ${t.status}: ${t.statusText}`);return t.json()}).then(t=>{t.success?(updateTaskNoteDisplay(s,!0),hideTaskNotePanel(),window.showNotification&&window.showNotification("Note saved successfully!","success"),i.disabled=!1):(i.innerHTML='<i class="fas fa-exclamation-triangle"></i>',i.classList.remove("text-gray-400","hover:text-[var(--primary-action-bg)]"),i.classList.add("text-red-500"),setTimeout(()=>{i.innerHTML=n,i.disabled=!1,i.classList.remove("text-red-500"),i.classList.add("text-gray-400","hover:text-[var(--primary-action-bg)]")},2e3))}).catch(t=>{console.error("Error saving note:",t),i.innerHTML='<i class="fas fa-exclamation-triangle"></i>',i.classList.remove("text-gray-400","hover:text-[var(--primary-action-bg)]"),i.classList.add("text-red-500"),setTimeout(()=>{i.innerHTML=n,i.disabled=!1,i.classList.remove("text-red-500"),i.classList.add("text-gray-400","hover:text-[var(--primary-action-bg)]")},2e3)})})}),document.addEventListener("DOMContentLoaded",function(){const t=document.getElementById("close-team-settings-modal");t&&t.addEventListener("click",hideTeamSettingsModal);const e=document.getElementById("team-settings-modal");e&&e.addEventListener("click",function(t){t.target===e&&hideTeamSettingsModal()}),document.addEventListener("click",function(t){if(t.target.closest(".remove-member-btn")){const e=t.target.closest(".remove-member-btn"),s=e.getAttribute("data-member-id"),o=e.getAttribute("data-member-name");confirm(`Are you sure you want to remove ${o} from the team?`)&&removeTeamMember(s)}});const s=document.getElementById("add-member-form");s&&s.addEventListener("submit",function(t){t.preventDefault();const e=document.getElementById("member-email").value.trim();e&&addTeamMember(e)})}),window.addEventListener("beforeunload",function(){window.gridManager&&window.gridManager.cleanup()});