{% extends "layout.html" %}

{% block title %}{{ project.name }} - Toad{% endblock %}

{% block content %}
<div class="mb-6 sm:mb-8">
    <div class="flex justify-center items-center mb-1">
        <svg class="brand-icon" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><path d="M256 448c-69.21 0-131.04-38.38-161.97-98.66C63.25 300.06 23.13 252 23.13 252c-10.05-10.05-10.05-26.32 0-36.36s26.32-10.05 36.36 0l7.57 7.57C80.43 230.43 128 192 128 192c-17.67-17.68-17.67-46.32 0-64s46.32-17.68 64 0l16.12 16.12C218.96 130.96 236.38 128 256 128s37.04 2.96 47.88 16.12L320 128c17.67-17.68 46.32-17.68 64 0s17.67 46.32 0 64c0 0 47.57 38.43 60.94 31.21l7.57-7.57c10.05-10.05 26.32-10.05 36.36 0s10.05 26.32 0 36.36c0 0-40.12 48.06-70.9 97.34C387.04 409.62 325.21 448 256 448zm0-288c-8.84 0-16 7.16-16 16s7.16 16 16 16 16-7.16 16-16-7.16-16-16-16zm-80 64c-8.84 0-16 7.16-16 16s7.16 16 16 16 16-7.16 16-16-7.16-16-16-16zm160 0c-8.84 0-16 7.16-16 16s7.16 16 16 16 16-7.16 16-16-7.16-16-16-16z"/></svg>
        <h1 class="text-3xl sm:text-4xl font-bold text-[var(--title-text)]">{{ project.name }}</h1>
    </div>
    <p class="text-[var(--subtitle-text)] text-sm sm:text-base text-center">Organize your tasks for this project.</p>
</div>

<div class="flex flex-col sm:flex-row justify-center items-center gap-2 mb-6 sm:mb-8">
    <div class="relative">
        <label for="project_switcher" class="sr-only">Switch Project</label>
        <select id="project_switcher" name="project_switcher"
                class="appearance-none w-full sm:w-auto bg-[var(--container-bg)] border border-[var(--border-color)] text-[var(--text-primary)] py-2 px-3 pr-8 rounded-md shadow-sm text-sm focus:outline-none focus:ring-2 focus:ring-[var(--primary-action-bg)] focus:border-[var(--primary-action-bg)]"
                onchange="if (this.value) window.location.href=this.value;">
            <option value="">Switch Project...</option>
            {% for p in projects %}
            <option value="{% url 'project_grid' pk=p.pk %}" {% if p.pk == project.pk %}selected{% endif %}>{{ p.name }}</option>
            {% endfor %}
             <option value="{% url 'project_list' %}">View All / Create New</option>
        </select>
        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-[var(--text-secondary)]">
            <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
        </div>
    </div>
    {# Add link/button to project settings or delete project here if needed #}
</div>

<div id="projectSpecificContent" class="bg-[var(--container-bg)] p-4 sm:p-6 rounded-lg shadow-lg">
    <div class="mb-4 flex flex-col sm:flex-row sm:items-center gap-3">
        {# Buttons to add columns/rows - these would link to CreateViews or trigger modals/forms #}
        <a href="#" class="bg-[var(--primary-action-bg)] hover:bg-[var(--primary-action-hover-bg)] text-[var(--primary-action-text)] font-medium py-2 px-4 rounded-md shadow-sm text-sm flex items-center justify-center sm:w-auto w-full">
            Add Column
        </a>
        <a href="#" class="bg-[var(--primary-action-bg)] hover:bg-[var(--primary-action-hover-bg)] text-[var(--primary-action-text)] font-medium py-2 px-4 rounded-md shadow-sm text-sm flex items-center justify-center sm:w-auto w-full">
            Add Row
        </a>
        {# You would also add forms or links for deleting the project here #}
    </div>

    <div id="gridContainer" class="overflow-x-auto border border-[var(--border-color)] rounded-md">
        <table class="w-full border-collapse min-w-[800px]"> {# min-w for horizontal scroll demo #}
            <thead id="gridHeader">
                <tr>
                    {% for col_header in column_headers %}
                    <th class="p-3 border-b border-r border-[var(--border-color)] text-left text-sm font-semibold whitespace-nowrap 
                               {% if col_header.is_category_column %}sticky left-0 z-20 category-column{% else %}sticky top-0 z-10 data-column{% endif %}">
                        <div class="flex items-center justify-between">
                            <span>{{ col_header.name }}</span>
                            {% if not col_header.is_category_column %}
                                {# Link to edit/delete column view #}
                                <a href="#" title="Edit column" class="ml-2 p-1 rounded hover:bg-gray-200">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-[var(--text-secondary)] hover:text-[var(--primary-action-bg)]" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                                </a>
                            {% endif %}
                        </div>
                    </th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody id="gridBody">
                {% for row_h in row_headers %}
                <tr class="border-b border-[var(--border-color)]">
                    {# Row Header Cell #}
                    <td class="p-3 border-r border-[var(--border-color)] font-medium text-[var(--text-primary)] sticky left-0 z-10 whitespace-nowrap sticky-row-header" 
                        style="min-width: 200px; background-color: var(--container-bg);">
                         <div class="flex items-center justify-between">
                            <span>{{ row_h.name }}</span>
                            {# Link to edit/delete row view #}
                            <a href="#" title="Edit row" class="ml-2 p-1 rounded hover:bg-gray-200">
                                 <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-[var(--text-secondary)] hover:text-[var(--primary-action-bg)]" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                            </a>
                        </div>
                    </td>

                    {# Data Cells #}
                    {% for col_h in column_headers %}
                        {% if not col_h.is_category_column %}
                        <td class="p-2 border-r border-[var(--border-color)] align-top" style="min-width: 220px; min-height: 100px;">
                            <div class="task-list space-y-1.5 mb-2">
                                {% for task in tasks_by_cell|get_item:row_h.id|get_item:col_h.id %} {# Custom template filter needed for dict access by var #}
                                 {% with key_tuple=row_h.id|stringformat:"s"|add:","|add:col_h.id|stringformat:"s" %} {# A bit of a hack for complex keys without custom filter #}
                                    {% for task in tasks_by_cell|get_item:key_tuple|default_if_none:"" %}
                                        <div class="task-item bg-[var(--task-bg)] p-2 rounded-md shadow-sm flex items-center text-sm text-[var(--text-primary)] hover:bg-[var(--task-hover-bg)] transition-colors duration-150 group {% if task.completed %}completed{% endif %}">
                                            <form action="{% url 'task_toggle_complete' task_pk=task.pk %}" method="post" class="contents">
                                                {% csrf_token %}
                                                <input type="checkbox" name="completed" {% if task.completed %}checked{% endif %}
                                                       onchange="this.form.submit()"
                                                       class="mr-2 h-4 w-4 rounded border-gray-300 text-[var(--primary-action-bg)] focus:ring-[var(--primary-action-bg)] cursor-pointer flex-shrink-0">
                                            </form>
                                            <span class="task-text flex-grow cursor-pointer" title="Edit task"> {# Link to edit task view #}
                                                {{ task.text }}
                                            </span>
                                            <form action="{% url 'task_delete' task_pk=task.pk %}" method="post" class="contents" onsubmit="return confirm('Are you sure you want to delete this task?');">
                                                {% csrf_token %}
                                                <button type="submit" title="Delete task"
                                                        class="ml-2 text-red-400 hover:text-red-600 font-bold p-0.5 px-1.5 rounded-full opacity-0 group-hover:opacity-100 transition-opacity flex-shrink-0">
                                                    &times;
                                                </button>
                                            </form>
                                        </div>
                                    {% endfor %}
                                 {% endwith %}
                                {% endfor %}
                            </div>
                            
                            <form method="post" action="{% url 'task_create' project_pk=project.pk row_pk=row_h.pk col_pk=col_h.pk %}">
                                {% csrf_token %}
                                <input type="text" name="task_text" placeholder="Add task... (Enter)"
                                       class="new-task-inline-input text-sm">
                                {# No explicit submit button, relies on Enter key. Or add a small + button that submits the form #}
                            </form>
                        </td>
                        {% endif %}
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

{# Note: For dictionary access like tasks_by_cell|get_item:row_h.id|get_item:col_h.id, 
   you might need to create a custom Django template filter `get_item`.
   Alternatively, pre-process tasks_by_cell in the view to make keys directly usable, 
   e.g., by converting tuple keys to strings like "rowID_colID".
   The stringformat hack is also shown above but is clumsy.
#}
<style>
    .category-column {
        background-color: var(--container-bg);
        min-width: 200px;
    }
    
    .data-column {
        background-color: var(--grid-header-bg);
        min-width: 220px;
    }
</style>

<script>
    // Simple project switcher
    // document.getElementById('project_switcher').addEventListener('change', function() {
    //     if (this.value) {
    //         window.location.href = this.value;
    //     }
    // });

    // Inline task add: The form submission handles this on Enter.
    // If JS enhancements are needed for "Enter" key on the inline input, add them here.
    // For example, to prevent default form submission if using AJAX later:
    // document.querySelectorAll('.new-task-inline-input').forEach(input => {
    //     input.addEventListener('keypress', function(event) {
    //         if (event.key === 'Enter') {
    //             event.preventDefault(); // if handling with JS/AJAX
    //             // this.form.submit(); // if simply triggering standard form submission
    //         }
    //     });
    // });
</script>
{% endblock %}