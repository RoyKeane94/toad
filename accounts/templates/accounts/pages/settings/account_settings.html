{% extends "pages/layout.html" %}
{% load static %}

{% block title %}Account Settings - Toad{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="bg-[var(--container-bg)] rounded-lg shadow-sm border border-[var(--border-color)] overflow-hidden">
        <!-- Header -->
        <div class="p-6 border-b border-[var(--border-color)]">
            <div class="flex items-center space-x-3">
                <div class="flex items-center justify-center w-10 h-10 bg-gradient-to-br from-[var(--primary-action-bg)] to-[var(--primary-action-hover-bg)] rounded-lg shadow-sm">
                    <i class="fas fa-user-cog text-white"></i>
                </div>
                <div>
                    <h1 class="text-xl font-semibold text-[var(--title-text)]">Account Settings</h1>
                    <p class="text-sm text-[var(--text-secondary)] mt-1">Manage your account preferences and information</p>
                </div>
            </div>
        </div>

        <!-- Trial Banner -->
        {% if is_on_trial %}
        <div class="mx-6 mt-6 bg-gradient-to-r from-amber-50 to-orange-50 border border-amber-200 rounded-lg p-4">
            <div class="flex items-center justify-between flex-wrap gap-3">
                <div class="flex items-center">
                    <div class="flex items-center justify-center w-10 h-10 bg-amber-100 rounded-lg mr-3 flex-shrink-0">
                        <i class="fas fa-clock text-amber-600"></i>
                    </div>
                    <div>
                        <p class="font-semibold text-amber-800 text-sm">
                            {% if trial_days_remaining > 0 %}
                                Trial ends in {{ trial_days_remaining }} day{{ trial_days_remaining|pluralize }}
                            {% elif trial_days_remaining == 0 %}
                                Trial ends today
                            {% else %}
                                Trial has expired
                            {% endif %}
                        </p>
                        <p class="text-xs text-amber-700 mt-0.5">
                            {{ trial_type_display }}
                        </p>
                    </div>
                </div>
                {% if is_team_trial and subscription_group %}
                <a href="{% url 'accounts:stripe_checkout_team' %}" 
                   class="inline-flex items-center px-4 py-2 bg-gradient-to-r from-emerald-500 to-green-500 hover:from-emerald-600 hover:to-green-600 text-white text-sm font-semibold rounded-lg shadow-md hover:shadow-lg transition-all"
                   style="background: linear-gradient(to right, #10b981, #22c55e) !important; color: white !important;">
                    <i class="fas fa-arrow-up mr-2" style="color: white !important;"></i>
                    <span style="color: white !important;">Convert to Paid Plan</span>
                </a>
                {% elif not is_team_trial %}
                <a href="{% url 'accounts:manage_subscription' %}" 
                   class="inline-flex items-center px-4 py-2 bg-gradient-to-r from-emerald-500 to-green-500 hover:from-emerald-600 hover:to-green-600 text-white text-sm font-semibold rounded-lg shadow-md hover:shadow-lg transition-all"
                   style="background: linear-gradient(to right, #10b981, #22c55e) !important; color: white !important;">
                    <i class="fas fa-arrow-up mr-2" style="color: white !important;"></i>
                    <span style="color: white !important;">Upgrade Now</span>
                </a>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Content -->
        <div class="p-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Profile Information -->
                <div class="bg-[var(--grid-header-bg)] border border-[var(--border-color)] rounded-lg p-6">
                    <h2 class="text-lg font-semibold text-[var(--title-text)] mb-4">Profile Information</h2>
                    <form method="post" action="{% url 'accounts:account_settings' %}">
                        {% csrf_token %}
                        <input type="hidden" name="update_profile" value="1">
                        <div class="space-y-4">
                            <div>
                                <label for="{{ profile_form.first_name.id_for_label }}" class="block text-sm font-medium text-[var(--text-primary)] mb-1">{{ profile_form.first_name.label }}</label>
                                {{ profile_form.first_name }}
                                {% if profile_form.first_name.errors %}
                                    <div class="mt-1 text-sm text-[var(--delete-button-bg)]">
                                        {% for error in profile_form.first_name.errors %}
                                            <p>{{ error }}</p>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            <div>
                                <label for="{{ profile_form.last_name.id_for_label }}" class="block text-sm font-medium text-[var(--text-primary)] mb-1">{{ profile_form.last_name.label }}</label>
                                {{ profile_form.last_name }}
                                {% if profile_form.last_name.errors %}
                                    <div class="mt-1 text-sm text-[var(--delete-button-bg)]">
                                        {% for error in profile_form.last_name.errors %}
                                            <p>{{ error }}</p>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            <div>
                                <label for="{{ profile_form.email.id_for_label }}" class="block text-sm font-medium text-[var(--text-primary)] mb-1">{{ profile_form.email.label }}</label>
                                {{ profile_form.email }}
                                {% if profile_form.email.errors %}
                                    <div class="mt-1 text-sm text-[var(--delete-button-bg)]">
                                        {% for error in profile_form.email.errors %}
                                            <p>{{ error }}</p>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="pt-2">
                                <button type="submit" 
                                        class="w-full bg-[var(--primary-action-bg)] hover:bg-[var(--primary-action-hover-bg)] text-[var(--primary-action-text)] px-4 py-2 rounded-md text-sm font-medium transition-colors">
                                    Update Profile
                                </button>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Change Password -->
                <div class="bg-[var(--grid-header-bg)] border border-[var(--border-color)] rounded-lg p-6">
                    <h2 class="text-lg font-semibold text-[var(--title-text)] mb-4">Security</h2>
                    <div class="space-y-4">
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 p-4 bg-[var(--container-bg)] rounded-lg border border-[var(--border-color)]">
                            <div class="min-w-0 flex-1">
                                <h3 class="font-medium text-[var(--text-primary)]">Password</h3>
                            </div>
                            <a href="{% url 'accounts:change_password' %}" 
                               class="px-4 py-2 bg-[var(--primary-action-bg)] hover:bg-[var(--primary-action-hover-bg)] text-[var(--primary-action-text)] rounded-md text-sm font-medium transition-colors whitespace-nowrap flex-shrink-0">
                                Update
                            </a>
                        </div>
                        
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 p-4 bg-[var(--container-bg)] rounded-lg border border-[var(--border-color)]">
                            <div class="min-w-0 flex-1">
                                <h3 class="font-medium text-[var(--text-primary)]">Email</h3>
                                <p class="text-sm text-[var(--text-secondary)] break-words">{{ user.email }}</p>
                            </div>
                            {% if user.email_verified %}
                                <span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-xs font-medium whitespace-nowrap flex-shrink-0">
                                    Verified
                                </span>
                            {% else %}
                                <div class="flex flex-col sm:flex-row items-start sm:items-center gap-2 flex-shrink-0">
                                    <span class="px-3 py-1 bg-yellow-100 text-yellow-700 rounded-full text-xs font-medium whitespace-nowrap">
                                        Unverified
                                    </span>
                                    <a href="{% url 'accounts:resend_verification' %}" 
                                       class="px-3 py-1 bg-[var(--primary-action-bg)] hover:bg-[var(--primary-action-hover-bg)] text-[var(--primary-action-text)] rounded-md text-xs font-medium transition-colors whitespace-nowrap">
                                        Resend
                                    </a>
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 p-4 bg-[var(--container-bg)] rounded-lg border border-[var(--border-color)]">
                            <div class="min-w-0 flex-1">
                                <h3 class="font-medium text-[var(--text-primary)]">Current Plan</h3>
                                <p class="text-sm text-[var(--text-secondary)]">
                                    {% if user.tier == 'beta' %}
                                        Beta Access
                                    {% elif user.tier == 'free' %}
                                        Free Plan
                                    {% elif user.tier == 'personal' %}
                                        Personal Plan
                                    {% elif user.tier == 'personal_trial' %}
                                        Personal Trial Plan
                                    {% elif user.tier == 'personal_3_month_trial' %}
                                        Personal 3 Month Trial Plan
                                    {% elif user.tier == 'pro' %}
                                        Team Toad Plan
                                    {% else %}
                                        {{ user.tier|title }} Plan
                                    {% endif %}
                                </p>
                            </div>
                            <div class="flex flex-col sm:flex-row gap-2 flex-shrink-0">
                                <a href="{% url 'accounts:manage_subscription' %}"
                                   class="px-4 py-2 border border-[var(--border-color)] text-[var(--text-primary)] bg-white hover:bg-[var(--bg-secondary)] rounded-md text-sm font-medium transition-colors whitespace-nowrap">
                                    Manage Subscription
                                </a>
                            </div>
                        </div>
                        
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 p-4 bg-[var(--container-bg)] rounded-lg border border-[var(--border-color)]">
                            <div class="min-w-0 flex-1">
                                <h3 class="font-medium text-[var(--text-primary)]">Account Created</h3>
                                <p class="text-sm text-[var(--text-secondary)]">{{ user.date_joined|date:"F j, Y" }}</p>
                            </div>
                            <span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-xs font-medium whitespace-nowrap flex-shrink-0">
                                Active
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Team Admin Section -->
            {% if subscription_group %}
            <div class="mt-6 bg-gradient-to-br from-[var(--tertiary-action-bg)]/10 to-[var(--tertiary-action-bg)]/5 rounded-lg p-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center space-x-3">
                        <div class="flex items-center justify-center w-10 h-10 bg-[var(--tertiary-action-bg)] rounded-lg shadow-sm">
                            <i class="fas fa-users text-white"></i>
                        </div>
                        <div>
                            <h2 class="text-lg font-semibold text-[var(--title-text)]">Team Admin</h2>
                            <p class="text-sm text-[var(--text-secondary)]">Manage your team subscription</p>
                        </div>
                    </div>
                    <a href="{% url 'accounts:manage_team' %}" class="px-4 py-2 bg-[var(--tertiary-action-bg)] hover:bg-[var(--tertiary-action-hover-bg)] text-white rounded-md text-sm font-medium transition-colors">
                        <i class="fas fa-cog mr-2"></i>
                        Manage Team
                    </a>
                </div>

                <!-- Team Stats -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-[var(--container-bg)] border border-[var(--border-color)] rounded-lg p-4">
                        <p class="text-xs text-[var(--text-secondary)] mb-1">Total Seats</p>
                        <p class="text-2xl font-bold text-[var(--text-primary)]">{{ total_seats }}</p>
                    </div>
                    <div class="bg-[var(--container-bg)] border border-[var(--border-color)] rounded-lg p-4">
                        <p class="text-xs text-[var(--text-secondary)] mb-1">In Use</p>
                        <p class="text-2xl font-bold text-[var(--text-primary)]">{{ current_members_count }}</p>
                    </div>
                    <div class="bg-[var(--container-bg)] border border-[var(--border-color)] rounded-lg p-4">
                        <p class="text-xs text-[var(--text-secondary)] mb-1">Pending</p>
                        <p class="text-2xl font-bold text-[var(--text-primary)]">{{ pending_count }}</p>
                    </div>
                    <div class="bg-[var(--container-bg)] border border-[var(--border-color)] rounded-lg p-4">
                        <p class="text-xs text-[var(--text-secondary)] mb-1">Available</p>
                        <p class="text-2xl font-bold text-[var(--text-primary)]">{{ available_seats }}</p>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <a href="{% url 'accounts:team_invite_members' %}" class="flex items-center justify-between p-4 bg-[var(--container-bg)] border border-[var(--border-color)] rounded-lg hover:bg-[var(--grid-header-bg)] transition-colors">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-user-plus text-green-600"></i>
                            </div>
                            <div>
                                <p class="font-medium text-[var(--text-primary)]">Add Team Members</p>
                                <p class="text-xs text-[var(--text-secondary)]">Invite new members to your team</p>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right text-[var(--text-secondary)]"></i>
                    </a>
                    <a href="{% url 'accounts:manage_team' %}" class="flex items-center justify-between p-4 bg-[var(--container-bg)] border border-[var(--border-color)] rounded-lg hover:bg-[var(--grid-header-bg)] transition-colors">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-list text-blue-600"></i>
                            </div>
                            <div>
                                <p class="font-medium text-[var(--text-primary)]">View All Members</p>
                                <p class="text-xs text-[var(--text-secondary)]">See all team members and invitations</p>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right text-[var(--text-secondary)]"></i>
                    </a>
                </div>

                <!-- Current Team Members Preview -->
                {% if team_members %}
                <div class="mb-6">
                    <h3 class="text-sm font-semibold text-[var(--text-primary)] mb-3">Current Team Members</h3>
                    <div class="space-y-2">
                        {% for member in team_members|slice:":5" %}
                        <div class="flex items-center justify-between p-3 bg-[var(--container-bg)] border border-[var(--border-color)] rounded-lg">
                            <div class="flex items-center space-x-3">
                                <div class="w-8 h-8 bg-[var(--tertiary-action-bg)] rounded-full flex items-center justify-center text-white text-xs font-semibold">
                                    {{ member.first_name|first|upper }}{{ member.last_name|first|upper }}
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-[var(--text-primary)]">{{ member.get_full_name|default:member.email }}</p>
                                    <p class="text-xs text-[var(--text-secondary)]">{{ member.email }}</p>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                        {% if team_members|length > 5 %}
                        <p class="text-xs text-[var(--text-secondary)] text-center mt-2">
                            and {{ team_members|length|add:"-5" }} more member(s)
                        </p>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                <!-- Pending Invitations Preview -->
                {% if pending_invitations %}
                <div>
                    <h3 class="text-sm font-semibold text-[var(--text-primary)] mb-3">Recent Pending Invitations</h3>
                    <div class="space-y-2">
                        {% for invitation in pending_invitations %}
                        <div class="flex items-center justify-between p-3 bg-[var(--container-bg)] border border-[var(--border-color)] rounded-lg">
                            <div>
                                <p class="text-sm font-medium text-[var(--text-primary)]">{{ invitation.invited_email }}</p>
                                <p class="text-xs text-[var(--text-secondary)]">
                                    Sent {{ invitation.created_at|timesince }} ago
                                </p>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="px-2 py-1 bg-yellow-100 text-yellow-700 rounded-full text-xs font-medium">
                                    Pending
                                </span>
                                <button type="button" onclick="openCancelInvitationModal({{ invitation.id }}, '{{ invitation.invited_email }}')" class="px-2 py-1 bg-red-100 hover:bg-red-200 text-red-700 rounded text-xs font-medium transition-colors" title="Cancel invitation">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
            {% endif %}

            <!-- Danger Zone -->
            <div class="mt-6 bg-red-50 border border-red-200 rounded-lg p-6">
                <h2 class="text-lg font-semibold text-red-700 mb-4">Danger Zone</h2>
                <p class="text-sm text-red-600 mb-4">Once you delete your account, there is no going back. Please be certain.</p>
                <a href="{% url 'accounts:delete_account' %}" 
                   class="inline-flex items-center px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-md text-sm font-medium transition-colors">
                    <i class="fas fa-trash mr-2"></i>Delete Account
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Cancel Invitation Modal -->
{% if subscription_group %}
<div id="cancelInvitationModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 opacity-0 invisible transition-all duration-300">
    <div class="bg-[var(--container-bg)] rounded-xl shadow-2xl border border-[var(--border-color)] max-w-md w-full mx-4 transform scale-95 transition-all duration-300">
        <!-- Modal Header -->
        <div class="flex items-center justify-between p-6 border-b border-[var(--border-color)]">
            <div class="flex items-center space-x-3">
                <div class="flex items-center justify-center w-10 h-10 bg-red-100 rounded-lg shadow-sm">
                    <i class="fas fa-exclamation-triangle text-red-600"></i>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-[var(--text-primary)]">Cancel Invitation</h3>
                    <p class="text-sm text-[var(--text-secondary)]">This action cannot be undone</p>
                </div>
            </div>
            <button type="button" id="close-cancel-invitation-modal" class="text-[var(--text-secondary)] hover:text-[var(--text-primary)] transition-colors">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <!-- Modal Body -->
        <div class="p-6">
            <p class="text-[var(--text-primary)] mb-4">
                Are you sure you want to cancel the invitation to <strong id="invitation-email-display"></strong>?
            </p>
            <p class="text-sm text-[var(--text-secondary)]">
                The invitation will be canceled and the seat will become available again.
            </p>
        </div>
        
        <!-- Modal Footer -->
        <div class="flex items-center justify-end space-x-3 p-6 border-t border-[var(--border-color)] bg-[var(--grid-header-bg)]/30 rounded-b-xl">
            <button type="button" id="cancel-invitation-close" class="w-32 h-10 flex items-center justify-center border border-[var(--border-color)] text-[var(--text-secondary)] rounded-lg hover:bg-[var(--container-bg)] hover:text-[var(--text-primary)] transition-all duration-200 font-medium cursor-pointer">
                <i class="fas fa-times mr-2"></i>Cancel
            </button>
            <form method="POST" action="" id="cancel-invitation-form" class="inline">
                {% csrf_token %}
                <button type="submit" class="w-40 h-10 flex items-center justify-center bg-red-600 hover:bg-red-700 text-white rounded-lg transition-all duration-200 font-medium shadow-sm hover:shadow-md cursor-pointer">
                    <i class="fas fa-trash mr-2"></i>Cancel Invitation
                </button>
            </form>
        </div>
    </div>
</div>

<script>
function openCancelInvitationModal(invitationId, email) {
    const modal = document.getElementById('cancelInvitationModal');
    const form = document.getElementById('cancel-invitation-form');
    const emailDisplay = document.getElementById('invitation-email-display');
    
    if (modal && form && emailDisplay) {
        // Set the form action - construct URL manually
        const baseUrl = '/accounts/team/cancel-invitation/';
        form.action = baseUrl + invitationId + '/';
        
        // Set the email display
        emailDisplay.textContent = email;
        
        // Show modal
        modal.classList.remove('opacity-0', 'invisible');
        const modalContent = modal.querySelector('div');
        if (modalContent) {
            modalContent.classList.remove('scale-95');
            modalContent.classList.add('scale-100');
        }
    }
}

function closeCancelInvitationModal() {
    const modal = document.getElementById('cancelInvitationModal');
    if (modal) {
        modal.classList.add('opacity-0', 'invisible');
        const modalContent = modal.querySelector('div');
        if (modalContent) {
            modalContent.classList.add('scale-95');
            modalContent.classList.remove('scale-100');
        }
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const closeBtn = document.getElementById('close-cancel-invitation-modal');
    const cancelBtn = document.getElementById('cancel-invitation-close');
    const modal = document.getElementById('cancelInvitationModal');
    
    if (closeBtn) {
        closeBtn.addEventListener('click', closeCancelInvitationModal);
    }
    
    if (cancelBtn) {
        cancelBtn.addEventListener('click', closeCancelInvitationModal);
    }
    
    if (modal) {
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                closeCancelInvitationModal();
            }
        });
    }
});
</script>
{% endif %}
{% endblock %}
