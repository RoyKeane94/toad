{% extends 'pages/layout.html' %}
{% load static %}

{% block title %}Manage Team - Toad{% endblock %}

{% block extra_head %}
{% endblock %}

{% block content %}
<div class="min-h-screen flex items-start justify-center pt-8 pb-12 px-4 sm:px-6 lg:px-8 bg-[var(--main-bg)]">
    <div class="max-w-4xl w-full space-y-8">
        <!-- Header -->
        <div class="text-center">
            <h1 class="text-3xl font-bold text-green-600 mb-2">
                Manage Team Subscription
            </h1>
        </div>

        <!-- Critical: Seats Reduced Below Usage - Action Required -->
        {% if seats_need_removal %}
        <div class="bg-gradient-to-r from-red-50 to-orange-50 border-2 border-red-300 rounded-xl p-6 shadow-sm">
            <div class="flex items-start gap-4">
                <div class="flex items-center justify-center w-12 h-12 bg-red-100 rounded-lg flex-shrink-0">
                    <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                </div>
                <div class="flex-1">
                    <h2 class="text-xl font-bold text-red-800 mb-2">⚠️ Action Required: Remove Team Members</h2>
                    <p class="text-sm text-red-700 mb-4">
                        You reduced your subscription to <strong>{{ total_seats }} seat(s)</strong>, but you currently have <strong>{{ current_usage }} in use</strong> ({{ current_members_count }} active members + {{ pending_count }} pending invitations).
                    </p>
                    <div class="bg-white border border-red-200 rounded-lg p-4 mb-4">
                        <p class="font-semibold text-red-800 mb-2">You must remove the following to match your new subscription:</p>
                        <ul class="list-disc list-inside space-y-1 text-sm text-red-700">
                            {% if invitations_to_cancel_count > 0 %}
                            <li><strong>{{ invitations_to_cancel_count }} pending invitation{{ invitations_to_cancel_count|pluralize }}</strong> must be cancelled</li>
                            {% endif %}
                            {% if members_to_remove_count > 0 %}
                            <li><strong>{{ members_to_remove_count }} team member{{ members_to_remove_count|pluralize }}</strong> must be removed</li>
                            {% endif %}
                        </ul>
                    </div>
                    <div class="bg-red-100 border border-red-300 rounded-lg p-3">
                        <p class="text-sm font-medium text-red-800">
                            <i class="fas fa-info-circle mr-2"></i>
                            <strong>Important:</strong> Please review the sections below and remove members or cancel invitations until you have no more than {{ total_seats }} seat{{ total_seats|pluralize }} in use.
                        </p>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Trial Status Banner (shown for trial users) -->
        {% if is_trial %}
        <div class="bg-gradient-to-r from-amber-50 to-orange-50 border border-amber-200 rounded-xl p-6 shadow-sm">
            <div class="flex items-start justify-between gap-4 flex-wrap">
                <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-3 mb-2">
                        <div class="flex items-center justify-center w-10 h-10 bg-amber-100 rounded-lg">
                            <i class="fas fa-clock text-amber-600"></i>
                        </div>
                        <div>
                            <h2 class="text-lg font-semibold text-amber-900">Team Trial Active</h2>
                            <p class="text-sm text-amber-700">
                                {% if trial_days_remaining > 0 %}
                                    <strong>{{ trial_days_remaining }} day{{ trial_days_remaining|pluralize }} remaining</strong>
                                {% else %}
                                    <strong class="text-red-600">Trial expired</strong>
                                {% endif %}
                            </p>
                        </div>
                    </div>
                    {% if trial_ends_at %}
                    <p class="text-xs text-amber-600 ml-13">
                        <i class="fas fa-calendar-alt mr-1"></i>
                        Ends {{ trial_ends_at|date:"F j, Y" }}
                    </p>
                    {% endif %}
                </div>
                <div class="flex flex-col gap-2">
                    <a href="{% url 'accounts:stripe_checkout_team' %}" 
                       class="inline-flex items-center justify-center px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm font-semibold transition-colors shadow-sm">
                        <i class="fas fa-arrow-up mr-2"></i>
                        Convert to Paid Plan
                    </a>
                    <p class="text-xs text-center text-amber-600">
                        £{{ price_per_seat }}/seat/month
                    </p>
                </div>
            </div>
            
            <!-- Trial Progress Bar -->
            <div class="mt-4">
                <div class="w-full bg-amber-200 rounded-full h-2">
                    <div class="bg-gradient-to-r from-amber-400 to-orange-400 h-2 rounded-full transition-all duration-500" 
                         style="width: {{ trial_progress_percent }}%"></div>
                </div>
            </div>
            
            <!-- Benefits of Converting -->
            <div class="mt-4 pt-4 border-t border-amber-200">
                <p class="text-xs font-medium text-amber-800 mb-2">Why convert now?</p>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-xs text-amber-700">
                    <div class="flex items-center">
                        <i class="fas fa-check text-emerald-500 mr-1"></i>
                        Keep your team
                    </div>
                    <div class="flex items-center">
                        <i class="fas fa-check text-emerald-500 mr-1"></i>
                        Keep all grids
                    </div>
                    <div class="flex items-center">
                        <i class="fas fa-check text-emerald-500 mr-1"></i>
                        No interruption
                    </div>
                    <div class="flex items-center">
                        <i class="fas fa-check text-emerald-500 mr-1"></i>
                        Cancel anytime
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Billing Information -->
        {% if stripe_subscription_info %}
        <div class="bg-[var(--container-bg)] border border-[var(--border-color)] rounded-lg p-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-semibold text-[var(--text-primary)] flex items-center">
                    <i class="fas fa-credit-card mr-2 text-blue-600"></i>
                    Current Billing
                </h2>
                {% if stripe_subscription_info.cancel_at_period_end %}
                <span class="px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs font-medium">
                    <i class="fas fa-exclamation-triangle mr-1"></i>
                    Cancels at period end
                </span>
                {% else %}
                <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-xs font-medium">
                    <i class="fas fa-check-circle mr-1"></i>
                    Active
                </span>
                {% endif %}
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div class="bg-white rounded-lg p-4 border border-blue-100">
                    <p class="text-xs text-[var(--text-secondary)] mb-1">Per Seat</p>
                    <p class="text-2xl font-bold text-[var(--text-primary)]">
                        {{ stripe_subscription_info.currency_symbol }}{{ stripe_subscription_info.unit_amount|floatformat:2 }}
                    </p>
                    <p class="text-xs text-[var(--text-secondary)] mt-1">per month</p>
                </div>
                <div class="bg-white rounded-lg p-4 border border-blue-100">
                    <p class="text-xs text-[var(--text-secondary)] mb-1">Total Seats</p>
                    <p class="text-2xl font-bold text-[var(--text-primary)]">
                        {{ stripe_subscription_info.quantity }}
                    </p>
                    <p class="text-xs text-[var(--text-secondary)] mt-1">active seats</p>
                </div>
                <div class="bg-white rounded-lg p-4 border border-blue-100">
                    <p class="text-xs text-[var(--text-secondary)] mb-1">Monthly Total</p>
                    <p class="text-2xl font-bold text-blue-600">
                        {{ stripe_subscription_info.currency_symbol }}{{ stripe_subscription_info.total_amount|floatformat:2 }}
                    </p>
                    <p class="text-xs text-[var(--text-secondary)] mt-1">per month</p>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Messages (excluding success) -->
        {% if messages %}
            {% for message in messages %}
                {% if message.tags == 'error' %}
                <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-md text-sm">
                    <div class="flex items-start">
                        <i class="fas fa-exclamation-triangle mr-2 mt-0.5 flex-shrink-0"></i>
                        <div>
                            <p class="font-medium mb-1">Error</p>
                            <p class="text-red-600 text-xs leading-relaxed">{{ message }}</p>
                        </div>
                    </div>
                </div>
                {% elif message.tags != 'success' %}
                <div class="bg-blue-50 border border-blue-200 text-blue-700 px-4 py-3 rounded-md text-sm">
                    <div class="flex items-start">
                        <i class="fas fa-info-circle mr-2 mt-0.5 flex-shrink-0"></i>
                        <div>
                            <p class="font-medium mb-1">Info</p>
                            <p class="text-blue-600 text-xs leading-relaxed">{{ message }}</p>
                        </div>
                    </div>
                </div>
                {% endif %}
            {% endfor %}
        {% endif %}

        <!-- Manage Subscription Section (only for paid subscriptions) -->
        {% if is_pro and stripe_subscription_info %}
        <div class="bg-[var(--container-bg)] border border-[var(--border-color)] rounded-lg p-6">
            <h2 class="text-xl font-semibold text-[var(--title-text)] mb-4">Manage Seats</h2>
            <p class="text-sm text-[var(--text-secondary)] mb-6">
                Add or remove seats from your team subscription. Changes will be processed through secure payment via Stripe.
            </p>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Increase Seats -->
                <div class="border border-[var(--border-color)] rounded-lg p-4 flex flex-col h-full">
                    <h3 class="font-semibold text-[var(--text-primary)] mb-2 flex items-center">
                        <i class="fas fa-plus-circle text-[var(--text-primary)] mr-2"></i>
                        Add Seats
                    </h3>
                    <p class="text-sm text-[var(--text-secondary)] mb-4 flex-grow">
                        Add more seats to your subscription at £5 per seat/month.
                    </p>
                    <a href="{% url 'accounts:increase_team_seats' %}" 
                       class="inline-flex items-center justify-center w-44 px-4 py-2 bg-[var(--primary-action-bg)] hover:bg-[var(--primary-action-hover-bg)] text-[var(--primary-action-text)] rounded-md text-sm font-medium transition-colors">
                        <i class="fas fa-plus mr-2"></i>
                        Add Seats
                    </a>
                </div>
                
                <!-- Decrease Seats -->
                <div class="border border-[var(--border-color)] rounded-lg p-4 flex flex-col h-full">
                    <h3 class="font-semibold text-[var(--text-primary)] mb-2 flex items-center">
                        <i class="fas fa-minus-circle text-[var(--text-primary)] mr-2"></i>
                        Remove Seats
                    </h3>
                    <p class="text-sm text-[var(--text-secondary)] mb-4 flex-grow">
                        Remove seats from your subscription.
                    </p>
                    <a href="{% url 'accounts:reduce_team_seats' %}" 
                       class="inline-flex items-center justify-center w-44 px-4 py-2 bg-[var(--primary-action-bg)] hover:bg-[var(--primary-action-hover-bg)] text-[var(--primary-action-text)] rounded-md text-sm font-medium transition-colors">
                        <i class="fas fa-minus mr-2"></i>
                        Remove Seats
                    </a>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Invite New Members Section -->
        <div class="bg-[var(--container-bg)] border border-[var(--border-color)] rounded-lg p-6">
            <h2 class="text-xl font-semibold text-[var(--title-text)] mb-4">Invite Team Members</h2>
            <p class="text-sm text-[var(--text-secondary)] mb-4">
                Send invitations to new team members.
            </p>
            
            <!-- Seat Stats Grid -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                <div class="bg-[var(--grid-header-bg)] rounded-lg p-4">
                    <p class="text-xs text-[var(--text-secondary)] mb-1">Total Seats</p>
                    <p class="text-2xl font-bold text-[var(--text-primary)]">{{ total_seats }}</p>
                </div>
                <div class="bg-[var(--grid-header-bg)] rounded-lg p-4">
                    <p class="text-xs text-[var(--text-secondary)] mb-1">In Use</p>
                    <p class="text-2xl font-bold text-[var(--text-primary)]">{{ current_members_count }}</p>
                </div>
                <div class="bg-[var(--grid-header-bg)] rounded-lg p-4">
                    <p class="text-xs text-[var(--text-secondary)] mb-1">Pending</p>
                    <p class="text-2xl font-bold text-[var(--text-primary)]">{{ pending_count }}</p>
                </div>
                <div class="bg-[var(--grid-header-bg)] rounded-lg p-4">
                    <p class="text-xs text-[var(--text-secondary)] mb-1">Available</p>
                    <p class="text-2xl font-bold text-[var(--text-primary)]">{{ available_seats }}</p>
                </div>
            </div>
            
            <a href="{% url 'accounts:team_invite_members' %}" class="inline-flex items-center px-4 py-2 bg-[var(--tertiary-action-bg)] hover:bg-[var(--tertiary-action-hover-bg)] text-white rounded-md text-sm font-medium transition-colors">
                <i class="fas fa-user-plus mr-2"></i>
                Invite Members
            </a>
        </div>

        <!-- Current Members Section -->
        <div class="bg-[var(--container-bg)] border border-[var(--border-color)] rounded-lg p-6">
            <h2 class="text-xl font-semibold text-[var(--text-primary)] mb-4">Current Team Members</h2>
            
            {% if members %}
            <div class="space-y-3">
                {% for member in members %}
                <div class="flex items-center justify-between p-4 bg-[var(--grid-header-bg)] border border-[var(--border-color)] rounded-lg">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-[var(--tertiary-action-bg)] rounded-full flex items-center justify-center text-white font-semibold">
                            {{ member.first_name|first|upper }}{{ member.last_name|first|upper }}
                        </div>
                        <div>
                            <p class="font-medium text-[var(--text-primary)]">
                                {{ member.get_full_name|default:member.email }}
                                {% if member == subscription_group.admin %}
                                    <span class="ml-2 px-2 py-0.5 bg-blue-100 text-blue-800 rounded text-xs font-medium">Admin</span>
                                {% endif %}
                            </p>
                            <p class="text-sm text-[var(--text-secondary)]">{{ member.email }}</p>
                        </div>
                    </div>
                    {% if member != subscription_group.admin %}
                    <button type="button" 
                            data-member-id="{{ member.id }}" 
                            data-member-name="{{ member.get_full_name|default:member.email|escapejs }}" 
                            data-member-email="{{ member.email|escapejs }}"
                            class="remove-member-btn px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-md text-sm font-medium transition-colors">
                            Remove
                        </button>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="text-sm text-[var(--text-secondary)]">No team members yet. Invite members to get started.</p>
            {% endif %}
        </div>

        <!-- Pending Invitations Section -->
        {% if pending_invitations %}
        <div class="bg-[var(--container-bg)] border border-[var(--border-color)] rounded-lg p-6">
            <h2 class="text-xl font-semibold text-[var(--text-primary)] mb-4">Pending Invitations</h2>
            <div class="space-y-3">
                {% for item in pending_invitations %}
                <div class="flex items-center justify-between p-4 bg-[var(--grid-header-bg)] border border-[var(--border-color)] rounded-lg">
                    <div>
                        <p class="font-medium text-[var(--text-primary)]">{{ item.invitation.invited_email }}</p>
                        <p class="text-sm text-[var(--text-secondary)]">
                            Sent {{ item.invitation.created_at|timesince }} ago
                            {% if item.is_expired %}
                                <span class="text-red-600">(Expired)</span>
                            {% else %}
                                <span class="text-[var(--text-secondary)]">(Expires {{ item.invitation.expires_at|date:"M d, Y" }})</span>
                            {% endif %}
                        </p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="px-3 py-1 bg-yellow-100 text-yellow-700 rounded-full text-xs font-medium">
                            Pending
                        </span>
                        <button type="button" data-invitation-id="{{ item.invitation.id }}" data-invitation-email="{{ item.invitation.invited_email|escapejs }}" class="cancel-invitation-btn px-3 py-1 bg-red-600 hover:bg-red-700 text-white rounded-md text-xs font-medium transition-colors">
                            <i class="fas fa-times mr-1"></i>
                            Cancel
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Admin Actions Section -->
        <div class="bg-[var(--container-bg)] border border-[var(--border-color)] rounded-lg p-6">
            <h2 class="text-xl font-semibold text-[var(--text-primary)] mb-4">Admin Actions</h2>
            <div class="space-y-3">
                <!-- Transfer Admin -->
                {% if members %}
                    {% comment %}Only show transfer admin if there are other members besides the admin{% endcomment %}
                    {% with members_count=members|length %}
                        {% if members_count > 1 %}
                        <div class="p-4 bg-[var(--grid-header-bg)] border border-[var(--border-color)] rounded-lg">
                            <h3 class="font-medium text-[var(--text-primary)] mb-2">Transfer Admin Role</h3>
                            <p class="text-sm text-[var(--text-secondary)] mb-3">
                                Transfer admin role to another team member. You will lose admin privileges.
                            </p>
                            <div class="space-y-2">
                                {% for member in members %}
                                    {% if member != subscription_group.admin %}
                                    <button type="button" data-user-id="{{ member.id }}" data-user-name="{{ member.get_full_name|default:member.email|escapejs }}" data-user-email="{{ member.email|escapejs }}" class="transfer-admin-btn w-full text-left px-4 py-2 bg-white hover:bg-[var(--container-bg)] border border-[var(--border-color)] rounded-md text-sm text-[var(--text-primary)] transition-colors">
                                        <i class="fas fa-user-shield mr-2"></i>
                                        Transfer to {{ member.get_full_name|default:member.email }}
                                    </button>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    {% endwith %}
                {% endif %}

                <!-- Cancel Subscription -->
                <div class="p-4 bg-red-50 border border-red-200 rounded-lg">
                    <h3 class="font-medium text-red-700 mb-2">Cancel Team Subscription</h3>
                    <p class="text-sm text-red-600 mb-3">
                        This will cancel the subscription immediately and delete all grids for all team members.
                    </p>
                    <button type="button" id="open-cancel-subscription-btn" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-md text-sm font-medium transition-colors">
                        <i class="fas fa-times mr-2"></i>
                        Cancel Subscription
                    </button>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- Cancel Invitation Modal -->
<div id="cancelInvitationModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 opacity-0 invisible transition-all duration-300">
    <div class="bg-[var(--container-bg)] rounded-xl shadow-sm border border-[var(--border-color)] max-w-md w-full mx-4 transform scale-95 transition-all duration-300">
        <!-- Modal Header -->
        <div class="flex items-center justify-between p-6 border-b border-[var(--border-color)]">
            <div class="flex items-center space-x-3">
                <div class="flex items-center justify-center w-10 h-10 bg-red-100 rounded-lg shadow-sm">
                    <i class="fas fa-exclamation-triangle text-red-600"></i>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-[var(--text-primary)]">Cancel Invitation</h3>
                    <p class="text-sm text-[var(--text-secondary)]">This action cannot be undone</p>
                </div>
            </div>
            <button type="button" id="close-cancel-invitation-modal" class="text-[var(--text-secondary)] hover:text-[var(--text-primary)] transition-colors">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <!-- Modal Body -->
        <div class="p-6">
            <p class="text-[var(--text-primary)] mb-4">
                Are you sure you want to cancel the invitation to <strong id="invitation-email-display"></strong>?
            </p>
            <p class="text-sm text-[var(--text-secondary)]">
                The invitation will be canceled and the seat will become available again.
            </p>
        </div>
        
        <!-- Modal Footer -->
        <div class="flex items-center justify-end space-x-3 p-6 border-t border-[var(--border-color)] bg-[var(--grid-header-bg)]/30 rounded-b-xl">
            <button type="button" id="cancel-invitation-close" class="w-32 h-10 flex items-center justify-center border border-[var(--border-color)] text-[var(--text-secondary)] rounded-lg hover:bg-[var(--container-bg)] hover:text-[var(--text-primary)] transition-all duration-200 font-medium cursor-pointer">
                <i class="fas fa-times mr-2"></i>Cancel
            </button>
            <form method="POST" action="" id="cancel-invitation-form" class="inline">
                {% csrf_token %}
                <button type="submit" class="w-40 h-10 flex items-center justify-center bg-red-600 hover:bg-red-700 text-white rounded-lg transition-all duration-200 font-medium shadow-sm cursor-pointer">
                    <i class="fas fa-trash mr-2"></i>Cancel Invitation
                </button>
            </form>
        </div>
    </div>
</div>

<script>
function openCancelInvitationModal(invitationId, email) {
    const modal = document.getElementById('cancelInvitationModal');
    const form = document.getElementById('cancel-invitation-form');
    const emailDisplay = document.getElementById('invitation-email-display');
    
    if (modal && form && emailDisplay) {
        // Set the form action - construct URL manually
        const baseUrl = '/accounts/team/cancel-invitation/';
        form.action = baseUrl + invitationId + '/';
        
        // Set the email display
        emailDisplay.textContent = email;
        
        // Show modal
        modal.classList.remove('opacity-0', 'invisible');
        const modalContent = modal.querySelector('div');
        if (modalContent) {
            modalContent.classList.remove('scale-95');
            modalContent.classList.add('scale-100');
        }
    }
}

function closeCancelInvitationModal() {
    const modal = document.getElementById('cancelInvitationModal');
    if (modal) {
        modal.classList.add('opacity-0', 'invisible');
        const modalContent = modal.querySelector('div');
        if (modalContent) {
            modalContent.classList.add('scale-95');
            modalContent.classList.remove('scale-100');
        }
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const closeBtn = document.getElementById('close-cancel-invitation-modal');
    const cancelBtn = document.getElementById('cancel-invitation-close');
    const modal = document.getElementById('cancelInvitationModal');
    
    // Add event listeners for cancel invitation buttons
    document.querySelectorAll('.cancel-invitation-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            const invitationId = this.getAttribute('data-invitation-id');
            const email = this.getAttribute('data-invitation-email');
            openCancelInvitationModal(parseInt(invitationId), email);
        });
    });
    
    if (closeBtn) {
        closeBtn.addEventListener('click', closeCancelInvitationModal);
    }
    
    if (cancelBtn) {
        cancelBtn.addEventListener('click', closeCancelInvitationModal);
    }
    
    if (modal) {
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                closeCancelInvitationModal();
            }
        });
    }
});

// Transfer Admin Modal
function openTransferAdminModal(userId, userName, userEmail) {
    const modal = document.getElementById('transferAdminModal');
    const form = document.getElementById('transfer-admin-form');
    const userNameDisplay = document.getElementById('transfer-user-name-display');
    const userEmailDisplay = document.getElementById('transfer-user-email-display');
    
    if (modal && form && userNameDisplay && userEmailDisplay) {
        // Set the form action
        const baseUrl = '/accounts/team/transfer-admin/';
        form.action = baseUrl + userId + '/';
        
        // Set the user display
        userNameDisplay.textContent = userName;
        userEmailDisplay.textContent = userEmail;
        
        // Show modal
        modal.classList.remove('opacity-0', 'invisible');
        const modalContent = modal.querySelector('div');
        if (modalContent) {
            modalContent.classList.remove('scale-95');
            modalContent.classList.add('scale-100');
        }
    }
}

function closeTransferAdminModal() {
    const modal = document.getElementById('transferAdminModal');
    if (modal) {
        modal.classList.add('opacity-0', 'invisible');
        const modalContent = modal.querySelector('div');
        if (modalContent) {
            modalContent.classList.add('scale-95');
            modalContent.classList.remove('scale-100');
        }
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const transferCloseBtn = document.getElementById('close-transfer-admin-modal');
    const transferCancelBtn = document.getElementById('cancel-transfer-admin');
    const transferModal = document.getElementById('transferAdminModal');
    
    // Add event listeners for transfer admin buttons
    document.querySelectorAll('.transfer-admin-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            const userId = this.getAttribute('data-user-id');
            const userName = this.getAttribute('data-user-name');
            const userEmail = this.getAttribute('data-user-email');
            openTransferAdminModal(parseInt(userId), userName, userEmail);
        });
    });
    
    if (transferCloseBtn) {
        transferCloseBtn.addEventListener('click', closeTransferAdminModal);
    }
    
    if (transferCancelBtn) {
        transferCancelBtn.addEventListener('click', closeTransferAdminModal);
    }
    
    if (transferModal) {
        transferModal.addEventListener('click', function(e) {
            if (e.target === transferModal) {
                closeTransferAdminModal();
            }
        });
    }
});

// Cancel Subscription Modal
function openCancelSubscriptionModal() {
    const modal = document.getElementById('cancelSubscriptionModal');
    if (modal) {
        modal.classList.remove('opacity-0', 'invisible');
        const modalContent = modal.querySelector('div');
        if (modalContent) {
            modalContent.classList.remove('scale-95');
            modalContent.classList.add('scale-100');
        }
    }
}

function closeCancelSubscriptionModal() {
    const modal = document.getElementById('cancelSubscriptionModal');
    if (modal) {
        modal.classList.add('opacity-0', 'invisible');
        const modalContent = modal.querySelector('div');
        if (modalContent) {
            modalContent.classList.add('scale-95');
            modalContent.classList.remove('scale-100');
        }
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const cancelSubCloseBtn = document.getElementById('close-cancel-subscription-modal');
    const cancelSubCancelBtn = document.getElementById('cancel-subscription-close');
    const cancelSubModal = document.getElementById('cancelSubscriptionModal');
    const openCancelSubBtn = document.getElementById('open-cancel-subscription-btn');
    const cancelAndDeleteBtn = document.getElementById('cancel-and-delete-btn');
    
    if (openCancelSubBtn) {
        openCancelSubBtn.addEventListener('click', openCancelSubscriptionModal);
    }
    
    if (cancelAndDeleteBtn) {
        cancelAndDeleteBtn.addEventListener('click', function(e) {
            if (!confirm('Are you absolutely sure? This will permanently delete your account and cannot be undone.')) {
                e.preventDefault();
            }
        });
    }
    
    if (cancelSubCloseBtn) {
        cancelSubCloseBtn.addEventListener('click', closeCancelSubscriptionModal);
    }
    
    if (cancelSubCancelBtn) {
        cancelSubCancelBtn.addEventListener('click', closeCancelSubscriptionModal);
    }
    
    if (cancelSubModal) {
        cancelSubModal.addEventListener('click', function(e) {
            if (e.target === cancelSubModal) {
                closeCancelSubscriptionModal();
            }
        });
    }
});

</script>

<!-- Cancel Subscription Modal -->
<div id="cancelSubscriptionModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 opacity-0 invisible transition-all duration-300">
    <div class="bg-[var(--container-bg)] rounded-xl shadow-sm border border-[var(--border-color)] max-w-md w-full mx-4 transform scale-95 transition-all duration-300">
        <!-- Modal Header -->
        <div class="flex items-center justify-between p-6 border-b border-[var(--border-color)]">
            <div class="flex items-center space-x-3">
                <div class="flex items-center justify-center w-10 h-10 bg-red-100 rounded-lg shadow-sm">
                    <i class="fas fa-exclamation-triangle text-red-600"></i>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-[var(--text-primary)]">Cancel Team Subscription</h3>
                    <p class="text-sm text-[var(--text-secondary)]">This action cannot be undone</p>
                </div>
            </div>
            <button type="button" id="close-cancel-subscription-modal" class="text-[var(--text-secondary)] hover:text-[var(--text-primary)] transition-colors">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <!-- Modal Body -->
        <div class="p-6">
            <p class="text-[var(--text-primary)] mb-4">
                Are you sure you want to cancel the team subscription? This will:
            </p>
            
            <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-4 space-y-3">
                <div class="flex items-start space-x-3">
                    <div class="flex items-center justify-center w-6 h-6 bg-red-200 rounded-full flex-shrink-0 mt-0.5">
                        <i class="fas fa-times text-red-600 text-xs"></i>
                    </div>
                    <div>
                        <p class="font-medium text-red-800 text-sm">Cancel Stripe subscription immediately</p>
                        <p class="text-xs text-red-700 mt-1">Your subscription will be canceled and billing will stop</p>
                    </div>
                </div>
                <div class="flex items-start space-x-3">
                    <div class="flex items-center justify-center w-6 h-6 bg-red-200 rounded-full flex-shrink-0 mt-0.5">
                        <i class="fas fa-trash text-red-600 text-xs"></i>
                    </div>
                    <div>
                        <p class="font-medium text-red-800 text-sm">Delete all grids for all team members</p>
                        <p class="text-xs text-red-700 mt-1">All grids (including yours) will be permanently deleted</p>
                    </div>
                </div>
                <div class="flex items-start space-x-3">
                    <div class="flex items-center justify-center w-6 h-6 bg-red-200 rounded-full flex-shrink-0 mt-0.5">
                        <i class="fas fa-user-slash text-red-600 text-xs"></i>
                    </div>
                    <div>
                        <p class="font-medium text-red-800 text-sm">Downgrade all members to Free plan</p>
                        <p class="text-xs text-red-700 mt-1">All team members (including you) will lose Team Toad access</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                <p class="text-sm text-yellow-800">
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    <strong>Warning:</strong> This action is permanent. All data will be lost and cannot be recovered.
                </p>
            </div>
        </div>
        
        <!-- Modal Footer -->
        <div class="flex flex-col space-y-3 p-6 border-t border-[var(--border-color)] bg-[var(--grid-header-bg)]/30 rounded-b-xl">
            <div class="flex items-center justify-end space-x-3">
                <button type="button" id="cancel-subscription-close" class="w-32 h-10 flex items-center justify-center border border-[var(--border-color)] text-[var(--text-secondary)] rounded-lg hover:bg-[var(--container-bg)] hover:text-[var(--text-primary)] transition-all duration-200 font-medium cursor-pointer">
                    <i class="fas fa-times mr-2"></i>Cancel
                </button>
                <form method="POST" action="{% url 'accounts:cancel_team_subscription' %}" class="inline" id="cancel-subscription-form">
                    {% csrf_token %}
                    <input type="hidden" name="delete_account" value="false">
                    <button type="submit" class="w-52 h-10 flex items-center justify-center bg-red-600 hover:bg-red-700 text-white rounded-lg transition-all duration-200 font-medium shadow-sm cursor-pointer whitespace-nowrap">
                        <i class="fas fa-trash mr-2"></i>Cancel Subscription
                    </button>
                </form>
            </div>
            <div class="border-t border-[var(--border-color)] pt-3">
                <form method="POST" action="{% url 'accounts:cancel_team_subscription' %}" class="inline w-full" id="cancel-and-delete-form">
                    {% csrf_token %}
                    <input type="hidden" name="delete_account" value="true">
                    <button type="submit" id="cancel-and-delete-btn" class="w-full h-10 flex items-center justify-center bg-red-800 hover:bg-red-900 text-white rounded-lg transition-all duration-200 font-medium shadow-sm cursor-pointer">
                        <i class="fas fa-user-times mr-2"></i>Cancel Subscription & Delete Account
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Transfer Admin Modal -->
<div id="transferAdminModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 opacity-0 invisible transition-all duration-300">
    <div class="bg-[var(--container-bg)] rounded-xl shadow-sm border border-[var(--border-color)] max-w-md w-full mx-4 transform scale-95 transition-all duration-300">
        <!-- Modal Header -->
        <div class="flex items-center justify-between p-6 border-b border-[var(--border-color)]">
            <div class="flex items-center space-x-3">
                <div class="flex items-center justify-center w-10 h-10 bg-yellow-100 rounded-lg shadow-sm">
                    <i class="fas fa-user-shield text-yellow-600"></i>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-[var(--text-primary)]">Transfer Admin Role</h3>
                    <p class="text-sm text-[var(--text-secondary)]">This action cannot be undone</p>
                </div>
            </div>
            <button type="button" id="close-transfer-admin-modal" class="text-[var(--text-secondary)] hover:text-[var(--text-primary)] transition-colors">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <!-- Modal Body -->
        <div class="p-6">
            <p class="text-[var(--text-primary)] mb-4">
                Are you sure you want to transfer admin role to <strong id="transfer-user-name-display"></strong>?
            </p>
            <div class="bg-[var(--grid-header-bg)] border border-[var(--border-color)] rounded-lg p-4 mb-4">
                <p class="text-xs text-[var(--text-secondary)] mb-1">New Admin</p>
                <p class="font-medium text-[var(--text-primary)]" id="transfer-user-email-display"></p>
            </div>
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                <p class="text-sm text-yellow-800">
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    <strong>Warning:</strong> You will lose admin privileges and will no longer be able to manage the team subscription.
                </p>
            </div>
        </div>
        
        <!-- Modal Footer -->
        <div class="flex items-center justify-end space-x-3 p-6 border-t border-[var(--border-color)] bg-[var(--grid-header-bg)]/30 rounded-b-xl">
            <button type="button" id="cancel-transfer-admin" class="w-32 h-10 flex items-center justify-center border border-[var(--border-color)] text-[var(--text-secondary)] rounded-lg hover:bg-[var(--container-bg)] hover:text-[var(--text-primary)] transition-all duration-200 font-medium cursor-pointer">
                <i class="fas fa-times mr-2"></i>Cancel
            </button>
            <form method="POST" action="" id="transfer-admin-form" class="m-0">
                {% csrf_token %}
                <button type="submit" class="w-40 h-10 flex items-center justify-center bg-yellow-600 hover:bg-yellow-700 text-white rounded-lg transition-all duration-200 font-medium shadow-sm cursor-pointer">
                    <i class="fas fa-user-shield mr-2"></i>Transfer
                </button>
            </form>
        </div>
    </div>
</div>

<!-- Remove Team Member Modal -->
<div id="removeMemberModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 opacity-0 invisible transition-all duration-300">
    <div class="bg-[var(--container-bg)] rounded-xl shadow-sm border border-[var(--border-color)] max-w-md w-full mx-4 transform scale-95 transition-all duration-300">
        <!-- Modal Header -->
        <div class="flex items-center justify-between p-6 border-b border-[var(--border-color)]">
            <div class="flex items-center space-x-3">
                <div class="flex items-center justify-center w-10 h-10 bg-red-100 rounded-lg shadow-sm">
                    <i class="fas fa-exclamation-triangle text-red-600"></i>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-[var(--text-primary)]">Remove Team Member</h3>
                    <p class="text-sm text-[var(--text-secondary)]">This action cannot be undone</p>
                </div>
            </div>
            <button type="button" id="close-remove-member-modal" class="text-[var(--text-secondary)] hover:text-[var(--text-primary)] transition-colors">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <!-- Modal Body -->
        <div class="p-6">
            <p class="text-[var(--text-primary)] mb-4">
                Are you sure you want to remove <strong id="remove-member-name-display"></strong>?
            </p>
            <div class="bg-[var(--grid-header-bg)] border border-[var(--border-color)] rounded-lg p-4 mb-4">
                <p class="text-xs text-[var(--text-secondary)] mb-1">Member Email</p>
                <p class="font-medium text-[var(--text-primary)]" id="remove-member-email-display"></p>
            </div>
            <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
                <p class="text-sm text-red-800">
                    <strong>Warning:</strong> All grids created by this member will be permanently deleted and their account will be downgraded to Free.
                </p>
            </div>
        </div>
        
        <!-- Modal Footer -->
        <div class="flex items-center justify-end space-x-3 p-6 border-t border-[var(--border-color)] bg-[var(--grid-header-bg)]/30 rounded-b-xl">
            <button type="button" id="cancel-remove-member" class="w-32 h-10 flex items-center justify-center border border-[var(--border-color)] text-[var(--text-secondary)] rounded-lg hover:bg-[var(--container-bg)] hover:text-[var(--text-primary)] transition-all duration-200 font-medium cursor-pointer">
                <i class="fas fa-times mr-2"></i>Cancel
            </button>
            <form method="POST" action="" id="remove-member-form" class="m-0">
                {% csrf_token %}
                <button type="submit" class="w-40 h-10 flex items-center justify-center bg-red-600 hover:bg-red-700 text-white rounded-lg transition-all duration-200 font-medium shadow-sm cursor-pointer">
                    Remove Member
                </button>
            </form>
        </div>
    </div>
</div>

<script>
// Remove Member Modal
function openRemoveMemberModal(memberId, memberName, memberEmail) {
    const modal = document.getElementById('removeMemberModal');
    const form = document.getElementById('remove-member-form');
    const nameDisplay = document.getElementById('remove-member-name-display');
    const emailDisplay = document.getElementById('remove-member-email-display');
    const initialsDisplay = document.getElementById('remove-member-initials-display');
    
    if (modal && form && nameDisplay && emailDisplay) {
        // Set the form action
        form.action = '/accounts/team/remove-member/' + memberId + '/';
        
        // Set the displays
        nameDisplay.textContent = memberName;
        emailDisplay.textContent = memberEmail;
        
        // Show modal
        modal.classList.remove('opacity-0', 'invisible');
        const modalContent = modal.querySelector('div');
        if (modalContent) {
            modalContent.classList.remove('scale-95');
            modalContent.classList.add('scale-100');
        }
    }
}

function closeRemoveMemberModal() {
    const modal = document.getElementById('removeMemberModal');
    if (modal) {
        modal.classList.add('opacity-0', 'invisible');
        const modalContent = modal.querySelector('div');
        if (modalContent) {
            modalContent.classList.add('scale-95');
            modalContent.classList.remove('scale-100');
        }
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const removeMemberCloseBtn = document.getElementById('close-remove-member-modal');
    const removeMemberCancelBtn = document.getElementById('cancel-remove-member');
    const removeMemberModal = document.getElementById('removeMemberModal');
    
    // Add event listeners for remove member buttons
    document.querySelectorAll('.remove-member-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            const memberId = this.getAttribute('data-member-id');
            const memberName = this.getAttribute('data-member-name');
            const memberEmail = this.getAttribute('data-member-email');
            openRemoveMemberModal(parseInt(memberId), memberName, memberEmail);
        });
    });
    
    if (removeMemberCloseBtn) {
        removeMemberCloseBtn.addEventListener('click', closeRemoveMemberModal);
    }
    
    if (removeMemberCancelBtn) {
        removeMemberCancelBtn.addEventListener('click', closeRemoveMemberModal);
    }
    
    if (removeMemberModal) {
        removeMemberModal.addEventListener('click', function(e) {
            if (e.target === removeMemberModal) {
                closeRemoveMemberModal();
            }
        });
    }
});
</script>
{% endblock %}
