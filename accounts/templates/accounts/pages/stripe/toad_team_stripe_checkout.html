{% extends 'pages/layout.html' %}
{% load static %}

{% block title %}Subscribe to Team Toad (Multiple Users){% endblock %}

{% block extra_head %}
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
        .modal-content {
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        .removal-item {
            transition: all 0.2s ease;
        }
        .removal-item:hover {
            background-color: rgba(239, 68, 68, 0.1);
        }
        .removal-item.selected {
            background-color: rgba(239, 68, 68, 0.15);
            border-color: rgb(239, 68, 68);
        }
    </style>
{% endblock %}

{% block content %}
<div class="min-h-screen flex items-start justify-center bg-[var(--main-bg)] pt-8 pb-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-md w-full space-y-8">
        <!-- Header -->
        <div class="text-center">
            <h2 class="text-3xl font-bold text-[var(--tertiary-action-bg)]">
                Upgrade to Team Toad
            </h2>
            <p class="mt-2 text-sm text-[var(--text-secondary)]">
                Purchase multiple subscriptions for your team
            </p>
        </div>

        <!-- Trial Conversion Banner -->
        {% if is_trial_conversion %}
        <div class="bg-gradient-to-r from-emerald-50 to-green-50 border border-emerald-200 rounded-lg p-4 mb-4">
            <div class="flex items-start">
                <div class="flex items-center justify-center w-10 h-10 bg-emerald-100 rounded-lg mr-3 flex-shrink-0">
                    <i class="fas fa-arrow-up text-emerald-600"></i>
                </div>
                <div>
                    <p class="font-semibold text-emerald-800 text-sm">Converting Your Team Trial</p>
                    <p class="text-xs text-emerald-700 mt-1">
                        Your team's {{ default_quantity }} seats have been pre-selected. All your grids and team members will be preserved!
                    </p>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Messages -->
        {% if messages %}
            {% for message in messages %}
                {% if message.tags == 'error' %}
                <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-md text-sm">
                    <div class="flex items-start">
                        <i class="fas fa-exclamation-triangle mr-2 mt-0.5 flex-shrink-0"></i>
                        <div>
                            <p class="font-medium mb-1">Error</p>
                            <p class="text-red-600 text-xs leading-relaxed">{{ message }}</p>
                        </div>
                    </div>
                </div>
                {% elif message.tags == 'success' %}
                <div class="bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-md text-sm">
                    <div class="flex items-start">
                        <i class="fas fa-check-circle mr-2 mt-0.5 flex-shrink-0"></i>
                        <div>
                            <p class="font-medium mb-1">Success</p>
                            <p class="text-green-600 text-xs leading-relaxed">{{ message }}</p>
                        </div>
                    </div>
                </div>
                {% endif %}
            {% endfor %}
        {% endif %}

        <!-- Product Card -->
        <div class="bg-[var(--container-bg)] py-8 px-6 shadow-xl rounded-lg border border-[var(--border-color)]">
            <div class="product text-center mb-6">
                <div class="flex justify-center mb-4">
                    <img src="{% static 'img/logo/toad_logo.png' %}" alt="Toad Logo" width="100" height="100" class="mx-auto">
                </div>
                <div class="description">
                    <h3 class="text-2xl font-bold text-[var(--text-primary)] mb-2">Team Toad</h3>
                    <h5 class="text-3xl font-bold text-[var(--tertiary-action-bg)] mb-4">£5.00 / month per user</h5>
                    <div class="text-left space-y-2 text-sm text-[var(--text-secondary)] mb-6">
                        <div class="flex items-center">
                            <i class="fas fa-check text-[var(--tertiary-action-bg)] mr-2"></i>
                            <span>Everything in Personal, plus...</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-check text-[var(--tertiary-action-bg)] mr-2"></i>
                            <span>Unlimited shared grids</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-check text-[var(--tertiary-action-bg)] mr-2"></i>
                            <span>Access to Team Toad, our premium collaboration tool</span>
                        </div>
                    </div>
                    
                    <!-- Quantity Selector -->
                    <div class="mb-6">
                        <label for="quantity" class="block text-sm font-medium text-[var(--text-primary)] mb-2">
                            Number of Team Members
                        </label>
                        <div class="flex items-center justify-center space-x-4">
                            <button type="button" id="decrease-quantity" class="w-10 h-10 rounded-full border-2 border-[var(--border-color)] bg-white hover:bg-[var(--grid-header-bg)] text-[var(--text-primary)] font-bold text-lg transition-colors">
                                -
                            </button>
                            <input 
                                type="number" 
                                id="quantity" 
                                name="quantity" 
                                value="{{ default_quantity|default:2 }}" 
                                min="1" 
                                max="100" 
                                class="w-20 text-center text-2xl font-bold text-[var(--text-primary)] border-2 border-[var(--border-color)] rounded-lg py-2 focus:outline-none focus:ring-2 focus:ring-[var(--tertiary-action-bg)]"
                                required
                            >
                            <button type="button" id="increase-quantity" class="w-10 h-10 rounded-full border-2 border-[var(--border-color)] bg-white hover:bg-[var(--grid-header-bg)] text-[var(--text-primary)] font-bold text-lg transition-colors">
                                +
                            </button>
                        </div>
                        <p class="text-xs text-[var(--text-secondary)] mt-2">
                            You'll be able to invite team members after payment
                        </p>
                    </div>
                    
                    <!-- Total Price Display -->
                    <div class="bg-[var(--grid-header-bg)] rounded-lg p-4 mb-6">
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-[var(--text-secondary)]">Total per month:</span>
                            <span id="total-price" class="text-2xl font-bold text-[var(--tertiary-action-bg)]">£10.00</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <form action="{% url 'accounts:create_checkout_session_team' %}" method="POST" id="checkout-form">
                {% csrf_token %}
                <input type="hidden" name="price_id" value="price_1SPN4iImvDyA3xuknMiIWMe5" />
                <input type="hidden" name="quantity" id="hidden-quantity" value="{{ default_quantity|default:2 }}" />
                <button id="checkout-and-portal-button" type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-[var(--tertiary-action-bg)] hover:bg-[var(--tertiary-action-hover-bg)] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[var(--tertiary-action-bg)] transition-colors duration-200">
                    <i class="fas fa-credit-card mr-2"></i>
                    Subscribe Now
                </button>
            </form>
            
            <div class="text-center mt-4">
                <p class="text-xs text-[var(--text-secondary)]">
                    Cancel anytime. Secure payment powered by Stripe.
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Seat Reduction Modal -->
{% if is_trial_conversion %}
<div id="seat-reduction-modal" class="fixed inset-0 z-50 hidden">
    <div class="modal-overlay absolute inset-0" onclick="closeSeatReductionModal()"></div>
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="modal-content relative bg-white rounded-2xl shadow-2xl max-w-lg w-full mx-4 overflow-hidden">
            <!-- Header -->
            <div class="bg-gradient-to-r from-amber-500 to-orange-500 px-6 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-white/20 rounded-lg flex items-center justify-center mr-3">
                            <i class="fas fa-users-slash text-white"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-bold text-white">Reduce Team Size</h3>
                            <p class="text-white/80 text-sm">Choose what to remove</p>
                        </div>
                    </div>
                    <button type="button" onclick="closeSeatReductionModal()" class="text-white/80 hover:text-white transition-colors">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            
            <!-- Content -->
            <div class="px-6 py-5">
                <!-- Status Banner -->
                <div class="bg-amber-50 border border-amber-200 rounded-lg p-4 mb-5">
                    <div class="flex items-start">
                        <i class="fas fa-exclamation-triangle text-amber-500 mt-0.5 mr-3"></i>
                        <div>
                            <p class="text-sm text-amber-800">
                                You're reducing from <strong id="modal-from-seats">0</strong> to <strong id="modal-to-seats">0</strong> seats.
                                Please select <strong id="modal-remove-count">0</strong> item(s) to remove.
                            </p>
                        </div>
                    </div>
                </div>
                
                <!-- Removal Selection -->
                <div class="space-y-4 max-h-64 overflow-y-auto">
                    <!-- Open Seats Section -->
                    {% if open_seats_count > 0 %}
                    <div class="border-b border-gray-100 pb-4">
                        <h4 class="text-sm font-semibold text-gray-700 mb-2 flex items-center">
                            <i class="fas fa-chair text-gray-400 mr-2"></i>
                            Open Seats ({{ open_seats_count }} available)
                        </h4>
                        <div class="space-y-2" id="open-seats-list">
                            {% for seat in open_seats_list %}
                            <label class="removal-item flex items-center p-3 border border-gray-200 rounded-lg cursor-pointer">
                                <input type="checkbox" name="remove_open_seat" value="{{ seat.index }}" class="removal-checkbox open-seat-checkbox w-4 h-4 text-red-500 border-gray-300 rounded focus:ring-red-500 mr-3">
                                <div class="flex items-center flex-1">
                                    <div class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center mr-3">
                                        <i class="fas fa-chair text-gray-400 text-sm"></i>
                                    </div>
                                    <span class="text-sm text-gray-600">Open Seat #{{ seat.index }}</span>
                                </div>
                                <span class="text-xs text-green-600 bg-green-50 px-2 py-1 rounded">Safe to remove</span>
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Pending Invitations Section -->
                    {% if pending_invitations_count > 0 %}
                    <div class="border-b border-gray-100 pb-4">
                        <h4 class="text-sm font-semibold text-gray-700 mb-2 flex items-center">
                            <i class="fas fa-envelope text-amber-400 mr-2"></i>
                            Pending Invitations ({{ pending_invitations_count }})
                        </h4>
                        <div class="space-y-2" id="invitations-list">
                            {% for inv in invitations_list %}
                            <label class="removal-item flex items-center p-3 border border-gray-200 rounded-lg cursor-pointer">
                                <input type="checkbox" name="remove_invitation" value="{{ inv.id }}" class="removal-checkbox invitation-checkbox w-4 h-4 text-red-500 border-gray-300 rounded focus:ring-red-500 mr-3">
                                <div class="flex items-center flex-1">
                                    <div class="w-8 h-8 bg-amber-100 rounded-full flex items-center justify-center mr-3">
                                        <i class="fas fa-envelope text-amber-500 text-sm"></i>
                                    </div>
                                    <span class="text-sm text-gray-700">{{ inv.email }}</span>
                                </div>
                                <span class="text-xs text-amber-600 bg-amber-50 px-2 py-1 rounded">Invitation cancelled</span>
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Active Members Section -->
                    {% if current_members_count > 0 %}
                    <div>
                        <h4 class="text-sm font-semibold text-gray-700 mb-2 flex items-center">
                            <i class="fas fa-user text-red-400 mr-2"></i>
                            Active Members ({{ current_members_count }})
                        </h4>
                        <div class="space-y-2" id="members-list">
                            {% for member in members_list %}
                            <label class="removal-item flex items-center p-3 border border-gray-200 rounded-lg cursor-pointer">
                                <input type="checkbox" name="remove_member" value="{{ member.id }}" class="removal-checkbox member-checkbox w-4 h-4 text-red-500 border-gray-300 rounded focus:ring-red-500 mr-3">
                                <div class="flex items-center flex-1">
                                    <div class="w-8 h-8 bg-red-100 rounded-full flex items-center justify-center mr-3">
                                        <i class="fas fa-user text-red-500 text-sm"></i>
                                    </div>
                                    <div>
                                        <span class="text-sm text-gray-700">{{ member.name }}</span>
                                        {% if member.name != member.email %}
                                        <span class="text-xs text-gray-400 block">{{ member.email }}</span>
                                        {% endif %}
                                    </div>
                                </div>
                                <span class="text-xs text-red-600 bg-red-50 px-2 py-1 rounded">Will lose access</span>
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
                
                <!-- Selection Counter -->
                <div class="mt-4 p-3 bg-gray-50 rounded-lg">
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-600">Selected to remove:</span>
                        <span id="selection-counter" class="text-sm font-semibold text-red-600">0 / 0</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                        <div id="selection-progress" class="bg-red-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
            </div>
            
            <!-- Footer -->
            <div class="bg-gray-50 px-6 py-4 flex items-center justify-between">
                <button type="button" onclick="closeSeatReductionModal()" class="px-4 py-2 text-sm font-medium text-gray-700 hover:text-gray-900 transition-colors">
                    Cancel
                </button>
                <button type="button" id="confirm-reduction-btn" onclick="confirmSeatReduction()" disabled class="px-6 py-2 bg-gradient-to-r from-red-500 to-red-600 text-white text-sm font-semibold rounded-lg shadow-md hover:from-red-600 hover:to-red-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all">
                    <i class="fas fa-check mr-2"></i>
                    Confirm & Continue
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    const quantityInput = document.getElementById('quantity');
    const hiddenQuantityInput = document.getElementById('hidden-quantity');
    const totalPriceDisplay = document.getElementById('total-price');
    const decreaseBtn = document.getElementById('decrease-quantity');
    const increaseBtn = document.getElementById('increase-quantity');
    const checkoutForm = document.getElementById('checkout-form');
    const pricePerUser = {{ price_per_seat|default:5 }};
    
    // Trial conversion data
    const isTrialConversion = {{ is_trial_conversion|yesno:"true,false" }};
    const originalQuantity = {{ default_quantity|default:2 }};
    const currentMembersCount = {{ current_members_count|default:0 }};
    const pendingInvitationsCount = {{ pending_invitations_count|default:0 }};
    const openSeatsCount = {{ open_seats_count|default:0 }};
    
    // Minimum seats needed = 1 (admin) + current members + pending invitations
    const minimumSeatsWithoutReduction = 1 + currentMembersCount + pendingInvitationsCount;
    
    // Track removals
    let pendingRemovals = {
        openSeats: [],
        invitations: [],
        members: []
    };
    let requiredRemovals = 0;
    let pendingNewQuantity = null;
    
    function updateTotal() {
        const quantity = parseInt(quantityInput.value) || 1;
        const total = (quantity * pricePerUser).toFixed(2);
        totalPriceDisplay.textContent = `£${total}`;
        hiddenQuantityInput.value = quantity;
    }
    
    function checkSeatReduction(newQuantity) {
        if (!isTrialConversion) return true;
        
        // Calculate how many seats we need to remove
        const seatsToFree = minimumSeatsWithoutReduction - newQuantity;
        
        if (seatsToFree > 0) {
            // Need to open the modal
            requiredRemovals = seatsToFree;
            pendingNewQuantity = newQuantity;
            openSeatReductionModal(originalQuantity, newQuantity, seatsToFree);
            return false;
        }
        return true;
    }
    
    decreaseBtn.addEventListener('click', function() {
        const currentValue = parseInt(quantityInput.value) || 1;
        if (currentValue > 1) {
            const newValue = currentValue - 1;
            if (checkSeatReduction(newValue)) {
                quantityInput.value = newValue;
            updateTotal();
            }
        }
    });
    
    increaseBtn.addEventListener('click', function() {
        const currentValue = parseInt(quantityInput.value) || 1;
        if (currentValue < 100) {
            quantityInput.value = currentValue + 1;
            updateTotal();
        }
    });
    
    quantityInput.addEventListener('input', function() {
        let value = parseInt(this.value) || 1;
        if (value < 1) value = 1;
        if (value > 100) value = 100;
        
        if (!checkSeatReduction(value)) {
            // Reset to previous value, modal will handle it
            this.value = originalQuantity;
        } else {
        this.value = value;
        }
        updateTotal();
    });
    
    // Form submission handler
    checkoutForm.addEventListener('submit', function(e) {
        const newQuantity = parseInt(quantityInput.value) || 1;
        
        if (isTrialConversion && newQuantity < minimumSeatsWithoutReduction) {
            const seatsToFree = minimumSeatsWithoutReduction - newQuantity;
            const totalRemovals = pendingRemovals.openSeats.length + 
                                  pendingRemovals.invitations.length + 
                                  pendingRemovals.members.length;
            
            if (totalRemovals < seatsToFree) {
                e.preventDefault();
                requiredRemovals = seatsToFree;
                pendingNewQuantity = newQuantity;
                openSeatReductionModal(originalQuantity, newQuantity, seatsToFree);
                return false;
            }
        }
        
        // Add removal data to form
        if (pendingRemovals.invitations.length > 0 || pendingRemovals.members.length > 0) {
            addHiddenInput('remove_invitations', JSON.stringify(pendingRemovals.invitations));
            addHiddenInput('remove_members', JSON.stringify(pendingRemovals.members));
        }
    });
    
    function addHiddenInput(name, value) {
        let input = checkoutForm.querySelector(`input[name="${name}"]`);
        if (!input) {
            input = document.createElement('input');
            input.type = 'hidden';
            input.name = name;
            checkoutForm.appendChild(input);
        }
        input.value = value;
    }
    
    // Initialize total on page load with default quantity
    updateTotal();
    
    // Modal functions - make them global
    window.openSeatReductionModal = function(fromSeats, toSeats, removeCount) {
        const modal = document.getElementById('seat-reduction-modal');
        if (!modal) return;
        
        document.getElementById('modal-from-seats').textContent = fromSeats;
        document.getElementById('modal-to-seats').textContent = toSeats;
        document.getElementById('modal-remove-count').textContent = removeCount;
        
        // Reset checkboxes
        document.querySelectorAll('.removal-checkbox').forEach(cb => {
            cb.checked = false;
            cb.closest('.removal-item').classList.remove('selected');
        });
        
        updateSelectionCounter();
        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    };
    
    window.closeSeatReductionModal = function() {
        const modal = document.getElementById('seat-reduction-modal');
        if (modal) {
            modal.classList.add('hidden');
            document.body.style.overflow = '';
        }
        pendingNewQuantity = null;
    };
    
    window.confirmSeatReduction = function() {
        // Gather selected removals
        pendingRemovals.openSeats = [];
        pendingRemovals.invitations = [];
        pendingRemovals.members = [];
        
        document.querySelectorAll('.open-seat-checkbox:checked').forEach(cb => {
            pendingRemovals.openSeats.push(cb.value);
        });
        document.querySelectorAll('.invitation-checkbox:checked').forEach(cb => {
            pendingRemovals.invitations.push(cb.value);
        });
        document.querySelectorAll('.member-checkbox:checked').forEach(cb => {
            pendingRemovals.members.push(cb.value);
        });
        
        // Update quantity input
        if (pendingNewQuantity !== null) {
            quantityInput.value = pendingNewQuantity;
            updateTotal();
        }
        
        closeSeatReductionModal();
    };
    
    function updateSelectionCounter() {
        const selectedCount = document.querySelectorAll('.removal-checkbox:checked').length;
        const counterEl = document.getElementById('selection-counter');
        const progressEl = document.getElementById('selection-progress');
        const confirmBtn = document.getElementById('confirm-reduction-btn');
        
        counterEl.textContent = `${selectedCount} / ${requiredRemovals}`;
        
        const percentage = Math.min((selectedCount / requiredRemovals) * 100, 100);
        progressEl.style.width = `${percentage}%`;
        
        if (selectedCount >= requiredRemovals) {
            progressEl.classList.remove('bg-red-500');
            progressEl.classList.add('bg-green-500');
            confirmBtn.disabled = false;
        } else {
            progressEl.classList.remove('bg-green-500');
            progressEl.classList.add('bg-red-500');
            confirmBtn.disabled = true;
        }
    }
    
    // Checkbox event listeners
    document.querySelectorAll('.removal-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const item = this.closest('.removal-item');
            if (this.checked) {
                item.classList.add('selected');
            } else {
                item.classList.remove('selected');
            }
            updateSelectionCounter();
        });
    });
});
</script>
{% endblock %}



